<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport"    content="width=device-width, initial-scale=1"/>
    <meta name="description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />
    <meta name="keywords"    content="Ruby Rails ガイド 体系的 入門 無料" />
    <meta name="author"      content="Ruby on Rails Community" />

    <meta property="fb:admins"      content="715330868" />
    <meta property="og:title"       content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:site_name"   content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:image"       content="http://railsguides.jp/images/cover_for_facebook.png"/>
    <meta property="og:url"         content="http://railsguides.jp/" />
    <meta property="og:type"        content="article" />
    <meta property="og:description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />

    <meta name="twitter:card"  content="summary" />
    <meta name="twitter:site"  content="@RailsGuidesJP" />
    <meta name="twitter:title" content="Ruby on Rails ガイド：体系的に Rails を学ぼう" />
    <meta name="twitter:description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />
    <meta name="twitter:image" content="http://railsguides.jp/images/cover_for_twitter.png" />
    <meta name="twitter:url"   content="http://railsguides.jp/" />

    <title>Action Controller の概要 | Rails ガイド</title>
    <meta name="apple-mobile-web-app-title" content="Railsガイド" />
    <meta name="application-name"           content="Railsガイド" />

    <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />

    <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />

    <link rel="apple-touch-icon" sizes="57x57" href="images/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

  </head>
<body class="guide">
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=614116885378153&version=v2.0";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">関連サイト: </strong>
      <span class="red-button more-info-button">関連URL</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://guides.rubyonrails.org/">原著 (英語)</a></li>
        <li class="more-info"><a href="https://github.com/yasslab/railsguides.jp">ソースコード (GitHub)</a></li>
        <li class="more-info"><a href="http://railstutorial.jp/">Rails チュートリアル</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="/" title="Return to home page">railsguides.jp</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="/">ホーム</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">ガイド目次</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>はじめに</dt>
                <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
                <dt>モデル</dt>
                <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
                <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
                <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
                <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
                <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
                <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
                <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
                <dt>ビュー</dt>
                <dd><a href="action_view_overview.html">Action View の概要</a></dd>
                <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
                <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
                <dt>コントローラ</dt>
                <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
                <dd><a href="routing.html">Rails ルーティング</a></dd>
              </dl>
              <dl class="R">
                <dt>高度なトピック</dt>
                <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
                <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
                <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
                <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
                <dd><a href="testing.html">Rails テスティングガイド</a></dd>
                <dd><a href="security.html">Rails セキュリティガイド</a></dd>
                <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
                <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
                <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
                <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
                <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
                <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
                <dd><a href="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</a></dd>
                <dd><a href="caching_with_rails.html">Rails のキャッシュ: 概要</a></dd>
                <dd><a href="active_support_instrumentation.html">Active Support の Instrumentation 機能</a></dd>
                <dd><a href="profiling.html">Rails アプリケーションのプロファイリング</a></dd>
                <dd><a href="api_app.html">Rails による API 専用アプリ</a></dd>
                <dd><a href="action_cable_overview.html">Action Cable の概要</a></dd>
                <dt>Rails を拡張する</dt>
                <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
                <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
                <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
                <dd><a href="engines.html">Rails エンジン入門</a></dd>
                <dt>Ruby on Rails に貢献する</dt>
                <dd><a href="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</a></dd>
                <dd><a href="development_dependencies_install.html">Rails コア開発環境の構築方法</a></dd>
                <dd><a href="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</a></dd>
                <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
                <dt>メンテナンスポリシー</dt>
                <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
                <dt>リリースノート</dt>
                <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
                <dd><a href="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</a></dd>
                <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
                <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
                <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
                <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
                <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
                <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
                <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
                <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
              </dl>
          </div>
        </li>
        <li><a class="nav-item" href="https://github.com/yasslab/railsguides.jp#readme">翻訳に貢献する</a></li>
        <li><a class="nav-item" href="credits.html">原著者</a></li>
        <li><a class="nav-item" href="options.html">電子書籍 (検索対応)</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">ガイド目次</option>
              <optgroup label="はじめに">
                  <option value="getting_started.html">Rails をはじめよう</option>
              </optgroup>
              <optgroup label="モデル">
                  <option value="active_record_basics.html">Active Record の基礎</option>
                  <option value="active_record_migrations.html">Active Record マイグレーション</option>
                  <option value="active_record_validations.html">Active Record バリデーション</option>
                  <option value="active_record_callbacks.html">Active Record コールバック</option>
                  <option value="association_basics.html">Active Record の関連付け</option>
                  <option value="active_record_querying.html">Active Record クエリインターフェイス</option>
                  <option value="active_model_basics.html">Active Model の基礎</option>
              </optgroup>
              <optgroup label="ビュー">
                  <option value="action_view_overview.html">Action View の概要</option>
                  <option value="layouts_and_rendering.html">レイアウトとレンダリング</option>
                  <option value="form_helpers.html">Action View フォームヘルパー</option>
              </optgroup>
              <optgroup label="コントローラ">
                  <option value="action_controller_overview.html">Action Controller の概要</option>
                  <option value="routing.html">Rails ルーティング</option>
              </optgroup>
              <optgroup label="高度なトピック">
                  <option value="active_support_core_extensions.html">Active Support コア拡張機能</option>
                  <option value="i18n.html">Rails 国際化 (i18n) API</option>
                  <option value="action_mailer_basics.html">Action Mailer の基礎</option>
                  <option value="active_job_basics.html">Active Job の基礎</option>
                  <option value="testing.html">Rails テスティングガイド</option>
                  <option value="security.html">Rails セキュリティガイド</option>
                  <option value="debugging_rails_applications.html">Rails アプリケーションのデバッグ</option>
                  <option value="configuring.html">Rails アプリケーションを設定する</option>
                  <option value="command_line.html">コマンドラインツールと Rake タスク</option>
                  <option value="asset_pipeline.html">アセットパイプライン</option>
                  <option value="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</option>
                  <option value="initialization.html">Rails の初期化プロセス</option>
                  <option value="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</option>
                  <option value="caching_with_rails.html">Rails のキャッシュ: 概要</option>
                  <option value="active_support_instrumentation.html">Active Support の Instrumentation 機能</option>
                  <option value="profiling.html">Rails アプリケーションのプロファイリング</option>
                  <option value="api_app.html">Rails による API 専用アプリ</option>
                  <option value="action_cable_overview.html">Action Cable の概要</option>
              </optgroup>
              <optgroup label="Rails を拡張する">
                  <option value="plugins.html">Rails プラグイン作成入門</option>
                  <option value="rails_on_rack.html">Rails と Rack</option>
                  <option value="generators.html">Rails ジェネレータとテンプレート入門</option>
                  <option value="engines.html">Rails エンジン入門</option>
              </optgroup>
              <optgroup label="Ruby on Rails に貢献する">
                  <option value="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</option>
                  <option value="development_dependencies_install.html">Rails コア開発環境の構築方法</option>
                  <option value="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</option>
              </optgroup>
              <optgroup label="メンテナンスポリシー">
                  <option value="maintenance_policy.html">メンテナンスポリシー</option>
              </optgroup>
              <optgroup label="リリースノート">
                  <option value="upgrading_ruby_on_rails.html">Rails アップグレードガイド</option>
                  <option value="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</option>
                  <option value="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide" />
  <div id="feature">
  <div class="wrapper">
      <h2>Action Controller の概要</h2><p>本ガイドでは、コントローラの動作と、アプリケーションのリクエストサイクルでコントローラがどのように使われるかについて説明します。</p><p>このガイドの内容:</p>
<ul>
<li>コントローラを経由するリクエストの流れを理解する</li>
<li>コントローラに渡されるパラメータを制限する方法</li>
<li>セッションやcookieにデータを保存する理由とその方法</li>
<li>リクエストの処理中にフィルタを使用してコードを実行する方法</li>
<li>Action ControllerにビルトインされているHTTP認証</li>
<li>ユーザーのブラウザにデータを直接ストリーミング送信する方法</li>
<li>機密性の高いパラメータをフィルタしてログに出力されないようにする方法</li>
<li>リクエスト処理中に発生する可能性のある例外の取り扱い</li>
</ul>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />目次</h3>
            <ol class="chapters">
<li><a href="#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%BD%B9%E5%89%B2">コントローラの役割</a></li>
<li><a href="#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%91%BD%E5%90%8D%E8%A6%8F%E5%89%87">コントローラの命名規則</a></li>
<li><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">メソッドとアクション</a></li>
<li>
<a href="#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">パラメータ</a>

<ul>
<li><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%A8%E9%85%8D%E5%88%97%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">ハッシュと配列のパラメータ</a></li>
<li><a href="#json%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">JSONパラメータ</a></li>
<li><a href="#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">ルーティングパラメータ</a></li>
<li><a href="#default-url-options"><code>default_url_options</code></a></li>
<li><a href="#strong-parameters">Strong Parameters</a></li>
</ul>
</li>
<li>
<a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3">セッション</a>

<ul>
<li><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B">セッションにアクセスする</a></li>
<li><a href="#flash">Flash</a></li>
</ul>
</li>
<li><a href="#cookies">Cookies</a></li>
<li><a href="#xml%E3%81%A8json%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E6%8F%8F%E7%94%BB%E3%81%99%E3%82%8B">XMLとJSONデータを描画する</a></li>
<li>
<a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF">フィルタ</a>

<ul>
<li><a href="#after%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%A8around%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF">afterフィルタとaroundフィルタ</a></li>
<li><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E4%BD%BF%E7%94%A8%E6%B3%95">その他のフィルタ使用法</a></li>
</ul>
</li>
<li><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA%E3%81%8B%E3%82%89%E3%81%AE%E4%BF%9D%E8%AD%B7">リクエストフォージェリからの保護</a></li>
<li>
<a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A8%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88">リクエストオブジェクトとレスポンスオブジェクト</a>

<ul>
<li><a href="#request%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><code>request</code>オブジェクト</a></li>
<li><a href="#response%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><code>response</code>オブジェクト</a></li>
</ul>
</li>
<li>
<a href="#http%E8%AA%8D%E8%A8%BC">HTTP認証</a>

<ul>
<li><a href="#http-basic%E8%AA%8D%E8%A8%BC">HTTP BASIC認証</a></li>
<li><a href="#http%E3%83%80%E3%82%A4%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E8%AA%8D%E8%A8%BC">HTTPダイジェスト認証</a></li>
</ul>
</li>
<li>
<a href="#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%A8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89">ストリーミングとファイルダウンロード</a>

<ul>
<li><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B">ファイルを送信する</a></li>
<li><a href="#restful%E3%81%AA%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89">RESTfulなダウンロード</a></li>
<li><a href="#%E4%BB%BB%E6%84%8F%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%83%A9%E3%82%A4%E3%83%96%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B">任意のデータをライブストリーミングする</a></li>
</ul>
</li>
<li>
<a href="#%E3%83%AD%E3%82%B0%E3%82%92%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%99%E3%82%8B">ログをフィルタする</a>

<ul>
<li><a href="#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%99%E3%82%8B">パラメータをフィルタする</a></li>
<li><a href="#%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%82%92%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%99%E3%82%8B">リダイレクトをフィルタする</a></li>
</ul>
</li>
<li>
<a href="#rescue">Rescue</a>

<ul>
<li><a href="#%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE500%E3%83%BB404%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">デフォルトの500・404テンプレート</a></li>
<li><a href="#rescue-from"><code>rescue_from</code></a></li>
</ul>
</li>
<li><a href="#https%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%82%92%E5%BC%B7%E5%88%B6%E3%81%99%E3%82%8B">HTTPSプロトコルを強制する</a></li>
</ol>

          </div>
</div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="コントローラの役割"><a href="#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%BD%B9%E5%89%B2">1 コントローラの役割</a></h3><p>Action Controllerは、MVCモデルのCに相当します。リクエストを処理するコントローラがルーティング設定によって指名されると、コントローラはリクエストの意味を理解し、適切な出力を行なうための責任を持ちます。幸い、これらの処理はほとんどAction Controllerが行ってくれます。しかも吟味された規則を使用しているので、リクエストの処理は可能な限り素直な方法で行われます。</p><p>従来のいわゆる<a href="http://ja.wikipedia.org/wiki/REST">RESTful</a> なアプリケーションでは、コントローラはリクエストを受け取り (この部分は開発者からは見えないようになっています)、データをモデルから取得したりモデルに保存するなどの作業を行い、最後にビューを使用してHTML出力を生成する、という役割を担います。自分のコントローラのつくりがこれと少し違っていたりするかもしれませんが、気にする必要はありません。ここではコントローラの一般的な使用法について説明しています。</p><p>コントローラは、モデルとビューの間に立って仲介を行っているという見方もできます。コントローラはモデルのデータをビューで使用できるようにすることで、データをビューで表示したり、入力されたデータでモデルを更新したりします。</p><div class="note"><p>ルーティングの詳細については、本ガイドの<a href="routing.html">Railsのルーティング</a>を参照してください。</p></div><h3 id="コントローラの命名規則"><a href="#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%91%BD%E5%90%8D%E8%A6%8F%E5%89%87">2 コントローラの命名規則</a></h3><p>Railsのコントローラ名(ここでは"Controller"という文字は除きます)は、基本的に名前の最後の部分に「複数形」を使用します。ただしこれは絶対的に守らなければならないというものではありません (実際 <code>ApplicationController</code>はApplicationが単数になっています)。たとえば、<code>ClientsController</code>の方が<code>ClientController</code>より好ましく、<code>SiteAdminsController</code>は<code>SiteAdminController</code>や<code>SitesAdminsController</code>よりも好ましい、といった具合です。</p><p>しかし、この規則には従っておくことをお勧めします。その理由は、<code>resources</code>などのデフォルトのルーティングジェネレータがそのまま利用できるのと、URLやパスヘルパーの用法がアプリケーション全体で一貫するからです。コントローラ名の最後が複数形になっていないと、たとえば<code>resources</code>で簡単に一括ルーティングできず、<code>:path</code>や<code>:controller</code>をいちいち指定しなければなりません。詳細については、<a href="layouts_and_rendering.html">レイアウト・レンダリングガイド</a>を参照してください。</p><div class="note"><p>モデルの命名規則は「単数形」であり、コントローラの命名規則とは異なります。</p></div><h3 id="メソッドとアクション"><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">3 メソッドとアクション</a></h3><p>Railsのコントローラは、<code>ApplicationController</code>を継承したRubyのクラスであり、他のクラスと同様のメソッドが使用できます。アプリケーションがブラウザからのリクエストを受け取ると、ルーティングによってコントローラとアクションが指名され、Railsはそれに応じてコントローラのインスタンスを生成し、アクション名と同じ名前のメソッドを実行します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ClientsController &lt; ApplicationController
  def new
  end
end

</pre>
</div>
<p>例として、クライアントを1人追加するためにブラウザでアプリケーションの<code>/clients/new</code>にアクセスすると、Railsは<code>ClientsController</code>のインスタンスを作成して<code>new</code>メソッドを実行します。ここでご注目いただきたいのは、<code>new</code>メソッドの内容が空であるにもかかわらず正常に動作するという点です。これは、Railsでは<code>new</code>アクションで特に指定のない場合には<code>new.html.erb</code>ビューを描画するようになっているからです。ビューで<code>@client</code>インスタンス変数にアクセスできるようにするために、<code>new</code>メソッドで<code>Client</code>を新規作成し、@clientに保存してみましょう。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def new
  @client = Client.new
end

</pre>
</div>
<p>この詳細については、<a href="layouts_and_rendering.html">レイアウト・レンダリングガイド</a>で説明されています。</p><p><code>ApplicationController</code>は、便利なメソッドが多数定義されている<code>ActionController::Base</code>を継承しています。本ガイドではそれらの一部について説明しますが、もっと知りたい場合はAPIドキュメントかRailsのソースコードを参照してください。</p><p>publicなメソッドでないとアクションとして呼び出すことはできません。補助メソッドやフィルタのような、アクションとして扱われたくないメソッドはprivateを指定するのが定石です。</p><h3 id="パラメータ"><a href="#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">4 パラメータ</a></h3><p>コントローラのアクションでは、ユーザーから送信されたデータやその他のパラメータにアクセスして何か作業を行なうのが普通です。Railsに限らず、一般にWebアプリケーションでは2種類のパラメータを扱うことができます。1番目は、URLの一部として送信されるパラメータで、「クエリ文字列パラメータ」と呼ばれます。クエリ文字列は、常にURLの"?"の後に置かれます。2番目のパラメータは、「POSTデータ」と呼ばれるものです。POSTデータは通常、ユーザーが記入したHTMLフォームから受け取ります。これがPOSTデータと呼ばれているのは、HTTP POSTリクエストの一部として送信されるからです。Railsでは、クエリ文字列パラメータの受け取り方とPOSTデータの受け取り方に違いはありません。どちらもコントローラ内では<code>params</code>という名前のハッシュでアクセスできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ClientsController &lt; ApplicationController
  # このアクションではクエリ文字列パラメータが使用されています
  # 送信側でHTTP GETリクエストが使用されているためです
  # ただしパラメータにアクセスするうえでは下との違いは生じません
  # 有効な顧客リストを得るため、このアクションへのURLは以下のようになっています
  # clients: /clients?status=activated
  def index
    if params[:status] == "activated"
      @clients = Client.activated
    else
      @clients = Client.inactivated
    end
  end

  # このアクションではPOSTパラメータが使用されています。このパラメータは通常
  # ユーザーが送信したHTMLフォームが元になります。
  # これはRESTfulなアクセスであり、URLは"/clients"となります。
  # データはURLではなくリクエストのbodyの一部として送信されます。
  def create
    @client = Client.new(params[:client])
    if @client.save
      redirect_to @client
    else
      # 以下の行ではデフォルトのレンダリング動作を上書きします。
      # 本来は"create"ビューが描画されます。
      render "new"
    end
  end
end

</pre>
</div>
<h4 id="ハッシュと配列のパラメータ"><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%81%A8%E9%85%8D%E5%88%97%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">4.1 ハッシュと配列のパラメータ</a></h4><p><code>params</code>ハッシュは、一次元のキー・値ペアしか格納できないということはありません。配列や、ネストしたハッシュを格納することもできます。値の配列をフォームから送信したい場合は、以下のように空の角かっこ[]をキー名に追加してください。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
GET /clients?ids[]=1&amp;ids[]=2&amp;ids[]=3

</pre>
</div>
<div class="note"><p>"["と"]"はURLで使用できない文字なので、この例の実際のURLは "/clients?ids%5b%5d=1&amp;ids%5b%5d=2&amp;ids%5b%5d=3"のようになります。これについては、ブラウザが自動的に面倒を見てくれ、さらにRailsはパラメータ受け取り時に自動的に復元してくれるので、通常は気にする必要はありません。ただし、何らかの理由でサーバーにリクエストを手動送信しなければならない場合には、このことを思い出す必要があります。</p></div><p>これで、受け取った<code>params[:ids]</code>の値は<code>["1", "2", "3"]</code>になりました。もう一つ知っておいて欲しいのは、パラメータの値はすべて「文字列型」であることです。Railsはパラメータの型を推測することもしなければ、型変換も行いませんので、必要であれば自分で型を変換する必要があります。パラメータの数字を<code>to_i</code>で整数に変換するのはよく行われます。</p><div class="note"><p><code>params</code>の中に<code>[]</code>、<code>[nil]</code>、<code>[nil, nil, ...]</code>という値があると、すべて自動的に<code>nil</code>に置き換えられます。この動作は、デフォルトのセキュリティ上の理由にもとづいています。詳細については <a href="security.html#%E5%AE%89%E5%85%A8%E3%81%A7%E3%81%AA%E3%81%84%E3%82%AF%E3%82%A8%E3%83%AA%E7%94%9F%E6%88%90">セキュリティガイド</a> を参照してください。</p></div><p>フォームから、中かっこ[]の中にキー名を含めたハッシュを送信するには以下のようにします。</p><div class="code_container">
<pre class="brush: xml; gutter: false; toolbar: false">
&lt;form accept-charset="UTF-8" action="/clients" method="post"&gt;
  &lt;input type="text" name="client[name]" value="Acme" /&gt;
  &lt;input type="text" name="client[phone]" value="12345" /&gt;
  &lt;input type="text" name="client[address][postcode]" value="12345" /&gt;
  &lt;input type="text" name="client[address][city]" value="Carrot City" /&gt;
&lt;/form&gt;

</pre>
</div>
<p>このフォームを送信すると、<code>params[:client]</code>の値は<code>{ "name" =&gt; "Acme", "phone" =&gt; "12345", "address" =&gt; { "postcode" =&gt; "12345", "city" =&gt; "Carrot City" } }</code>になります。<code>params[:client][:address]</code>のハッシュがネストしていることにご注目ください。</p><p>この<code>params</code>ハッシュは、実は<code>ActiveSupport::HashWithIndifferentAccess</code>のインスタンスです。これはハッシュのように振る舞いますが、キーとしてシンボルと文字列のどちらを指定してもよい (交換可能) 点が異なります。</p><h4 id="jsonパラメータ"><a href="#json%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">4.2 JSONパラメータ</a></h4><p>Webサービスアプリケーションを開発していると、パラメータをJSONフォーマットで受け取れたら便利なのにと思うことがあります。Railsでは、リクエストの"Content-Type"に"application/json"が指定されていれば、自動的にパラメータを<code>params</code>ハッシュに変換してくれます。以後は通常の<code>params</code>ハッシュと同様に操作できます。</p><p>たとえば、以下のJSONコンテンツを送信したとします。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
{ "company": { "name": "acme", "address": "123 Carrot Street" } }

</pre>
</div>
<p><code>params[:company]</code>で受け取る値は<code>{ "name" =&gt; "acme", "address" =&gt; "123 Carrot Street" }</code>になります。</p><p>同様に、初期化設定で<code>config.wrap_parameters</code>をオンにした場合や、コントローラで<code>wrap_parameters</code>を呼び出した場合、JSONパラメータのルート要素を安全に取り除くことができます。このパラメータは、デフォルトではコントローラ名に応じて複製およびラップされます。従って、上のパラメータは以下のように書けます。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
{ "name": "acme", "address": "123 Carrot Street" }

</pre>
</div>
<p>データの送信先が<code>CompaniesController</code>であるとすると、以下のように<code>:company</code>というキーでラップされます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{ name: "acme", address: "123 Carrot Street", company: { name: "acme", address: "123 Carrot Street" } }

</pre>
</div>
<p>キー名のカスタマイズや、ラップしたい特定のパラメータについては<a href="http://api.rubyonrails.org/classes/ActionController/ParamsWrapper.html">APIドキュメント</a>を参照してください。</p><div class="note"><p>従来のXMLパラメータ解析のサポートは、<code>actionpack-xml_parser</code>というgemに書き出されました。</p></div><h4 id="ルーティングパラメータ"><a href="#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">4.3 ルーティングパラメータ</a></h4><p><code>params</code>ハッシュに必ず含まれるキーは<code>:controller</code>キーと<code>:action</code>キーです。ただしこれらの値には直接アクセスせず、<code>controller_name</code>と<code>action_name</code>という専用のメソッドを使用してください。ルーティングで定義されるその他の値パラメータ (<code>id</code>など) にもアクセスできます。例として、「有効」と「無効」のいずれかで表される顧客のリストについて考えてみましょう。「プリティな」URLに含まれる<code>:status</code>パラメータを捉えるためのルートを1つ追加してみましょう。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '/clients/:status' =&gt; 'clients#index', foo: 'bar'

</pre>
</div>
<p>この場合、ブラウザで<code>/clients/active</code>というURLを開くと、<code>params[:status]</code>が"active" (有効) に設定されます。このルーティングを使用すると、あたかもクエリ文字列で渡したかのように<code>params[:foo]</code>にも"bar"が設定されます。同様に、<code>params[:action]</code>には"index"が含まれます。</p><h4 id="default-url-options"><a href="#default-url-options">4.4 <code>default_url_options</code></a></h4><p>コントローラで<code>default_url_options</code>という名前のメソッドを定義すると、URL生成用のグローバルなデフォルトパラメータを設定できます。このようなメソッドは、必要なデフォルト値を持つハッシュを返さねばならず、キーはシンボルでなければなりません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ApplicationController &lt; ActionController::Base
  def default_url_options
    { locale: I18n.locale }
  end
end

</pre>
</div>
<p>これらのオプションはURL生成の開始点として使用でき、<code>url_for</code>呼び出しで渡されるオプションで上書きすることもできます。</p><p><code>ApplicationController</code>で<code>default_url_options</code>を定義すると、上の例で示したように、すべてのURL生成で使用されるようになります。このメソッドを特定のコントローラで定義すれば、そのコントローラで生成されるURLにだけ影響します。</p><h4 id="strong-parameters"><a href="#strong-parameters">4.5 Strong Parameters</a></h4><p>strong parametersを使用することで、Action ControllerのパラメータがActive Modelのマスアサインメントに利用されることを禁止できます。ホワイトリストに追記したもののみ使用できます。これは、多くの属性を一度に更新したいときに、どの属性の更新を許可し、どの属性の更新を禁止するかを明示的に決定しなければならないことを意味します。大雑把にすべての属性の更新をまとめて許可してしまうと、外部に公開する必要のない属性まで誤って公開されてしまう可能性が生じますので、そのような事態を防ぐために行います。</p><p>さらに、パラメータの属性には「必須 (required)」を指定することもでき、事前に定義したraise/rescueフローを実行して400 Bad Requestで終了するようにすることもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class PeopleController &lt; ActionController::Base
  # 以下のコードはActiveModel::ForbiddenAttributes例外を発生します
  # 明示的な許可を行なわずに、パラメータを一括で渡してしまう
  # 危険な「マスアサインメント」が行われているからです。
  def create
    Person.create(params[:person])
  end

  # 以下のコードは、パラメータにpersonキーがあれば成功します。
  # personキーがない場合は
  # ActionController::ParameterMissing例外を発生します。
  # この例外はActionController::Baseにキャッチされ、
  # 400 Bad Requestを返します。
  def update
    person = current_account.people.find(params[:id])
    person.update!(person_params)
    redirect_to person
  end

  private
    # privateメソッドを使用して、許可するパラメータをカプセル化します。
    # これは非常によい手法であり、createとupdateの両方で使いまわすことで
    # 同じ許可を与えることができます。また、許可する属性をユーザーごとにチェックするよう
    # このメソッドを特殊化することもできます。
    def person_params
      params.require(:person).permit(:name, :age)
    end
end

</pre>
</div>
<h5 id="許可されたスカラー値"><a href="#%E8%A8%B1%E5%8F%AF%E3%81%95%E3%82%8C%E3%81%9F%E3%82%B9%E3%82%AB%E3%83%A9%E3%83%BC%E5%80%A4">4.5.1 許可されたスカラー値</a></h5><p>以下の例では</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
params.permit(:id)

</pre>
</div>
<p><code>:id</code>キーが<code>params</code>にあり、それの値の型が許可済みスカラーがあれば、ホワイトリストチェックをパスします。でなければ、このキーはフィルタによって除外されます。従って、ハッシュやその他のオブジェクトを外部から注入することはできなくなります。</p><p>許可されるスカラー型は<code>String</code>、<code>Symbol</code>、<code>NilClass</code>、<code>Numeric</code>、<code>TrueClass</code>、<code>FalseClass</code>、<code>Date</code>、<code>Time</code>、<code>DateTime</code>、<code>StringIO</code>、<code>IO</code>、<code>ActionDispatch::Http::UploadedFile</code>、<code>Rack::Test::UploadedFile</code>です。</p><p><code>params</code>の値が、許可されたスカラー値の配列でなければならないことを宣言するには、以下のようにキーを空の配列にマップします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
params.permit(id: [])

</pre>
</div>
<p>パラメータのハッシュ全体をホワイトリスト化したい場合は、<code>permit!</code>メソッドを使用できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
params.require(:log_entry).permit!

</pre>
</div>
<p>こうすることで、<code>:log_entry</code>パラメータハッシュとすべてのサブハッシュが「許可」としてマーキングされます。ただし、<code>permit!</code>は属性を一括で許可してしまうものなので、くれぐれも慎重に使用してください。現在のモデルはもちろんのこと、将来属性が追加されたときにそこにマスアサインメントの脆弱性が生じる可能性があるからです。</p><h5 id="ネストしたパラメータ"><a href="#%E3%83%8D%E3%82%B9%E3%83%88%E3%81%97%E3%81%9F%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF">4.5.2 ネストしたパラメータ</a></h5><p>ネストしたパラメータに対しても以下のように許可を与えることができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
params.permit(:name, { emails: [] },
              friends: [ :name,
                         { family: [ :name ], hobbies: [] }])

</pre>
</div>
<p>この宣言では、<code>name</code>、<code>emails</code>、<code>friends</code>属性がホワイトリスト化されます。ここでは、<code>emails</code>は許可を受けたスカラー値の配列であることが期待され、<code>friends</code>は特定の属性を持つリソースの配列であることが期待され、どちらも<code>name</code>属性(許可を受けたあらゆるスカラー値を受け付ける)を持ちます。また、<code>hobbies</code>属性(許可を受けたスカラー値の配列)を持ち、<code>family</code>属性(同じく、許可を受けたあらゆるスカラー値を受け付ける)を持つことも期待されます。</p><h5 id="その他の事例"><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E4%BA%8B%E4%BE%8B">4.5.3 その他の事例</a></h5><p>今度は<code>new</code>アクションでも許可済み属性を使用したいところです。しかし今度は<code>new</code>を呼び出す時点ではルートキーがないので、ルートキーに対して<code>require</code>を指定することができないという問題があります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# `fetch`を使用することでデフォルト値を提供し、
# Strong Parameters APIを使用することができます。
params.fetch(:blog, {}).permit(:title, :author)

</pre>
</div>
<p><code>accepts_nested_attributes_for</code>メソッドを使用すると、関連付けられたレコードの更新や削除を行えます。この動作は、<code>id</code>と<code>_destroy</code>パラメータに基づきます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# :id と :_destroyを許可します。
params.require(:author).permit(:name, books_attributes: [:title, :id, :_destroy])

</pre>
</div>
<p>整数のキーを持つハッシュは異なる方法で処理されます。これらは、あたかも直接の子オブジェクトであるかのように属性を宣言することができます。<code>has_many</code>関連付けとともに<code>accepts_nested_attributes_for</code>メソッドを使用すると、これらの種類のパラメータを取得できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# 以下のデータをホワイトリスト化
# {"book" =&gt; {"title" =&gt; "Some Book",
#             "chapters_attributes" =&gt; { "1" =&gt; {"title" =&gt; "First Chapter"},
#                                        "2" =&gt; {"title" =&gt; "Second Chapter"}}}}

params.require(:book).permit(:title, chapters_attributes: [:title])

</pre>
</div>
<h5 id="strong-parametersのスコープ外"><a href="#strong-parameters%E3%81%AE%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E5%A4%96">4.5.4 Strong Parametersのスコープ外</a></h5><p>strong parameter APIは、最も一般的な使用状況を念頭に置いて設計されています。つまり、あらゆるホワイトリスト化問題を扱えるような万能性があるわけではないということです。しかし、このAPIを自分のコードに混在させることで、状況に対応しやすくすることはできます。</p><p>次のような状況を想像してみましょう。製品名と、その製品名に関連する任意のデータを表すパラメータがあるとします。そして、この製品名もデータハッシュ全体もまとめてホワイトリスト化したいとします。strong parameters APIは、任意のキーを持つネストしたハッシュ全体を直接ホワイトリスト化することはしませんが、ネストしたハッシュのキーを使用して、ホワイトリスト化する対象を宣言することはできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def product_params
  params.require(:product).permit(:name, data: params[:product][:data].try(:keys))
end

</pre>
</div>
<h3 id="セッション"><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3">5 セッション</a></h3><p>Railsアプリケーションにはユーザーごとにセッションが設定されます。前のリクエストの情報を次のリクエストでも利用するためにセッションに少量のデータが保存されます。セッションはコントローラとビューでのみ使用可能です。また、以下のように複数のストレージから選ぶことができます。</p>
<ul>
<li>
<code>ActionDispatch::Session::CookieStore</code> - すべてのセッションをクライアント側のブラウザのcookieに保存する</li>
<li>
<code>ActionDispatch::Session::CacheStore</code> - データをRailsのキャッシュに保存する</li>
<li>
<code>ActionDispatch::Session::ActiveRecordStore</code> - Active Recordを使用してデータベースに保存する (<code>activerecord-session_store</code> gemが必要)</li>
<li>
<code>ActionDispatch::Session::MemCacheStore</code> - データをmemcachedクラスタに保存する (この実装は古いのでCacheStoreを検討すべき)</li>
</ul>
<p>すべてのセッションにおいて、セッションごとに独自IDをcookieに保存します (注意: RailsではセッションIDをURLで渡すことはセキュリティ上の危険があるため許可されません。セッションIDはcookieで渡さなくてはなりません)。</p><p>多くのセッションストアでは、このIDは単にサーバー上のセッションデータ (データベーステーブルなど) を検索するために使用されています。ただしCookieStoreは例外的にcookie自身にすべてのセッションデータを保存します(セッションIDも必要であれば利用可能です)。そしてRailsではCookieStoreがデフォルトで使用され、かつRailsでの推奨セッションストアでもあります。CookieStoreの利点は、非常に軽量であることと、新規Webアプリケーションでセッションを利用するための準備がまったく不要である点です。cookieデータは改竄防止のために暗号署名が与えられています。さらにcookie自身も暗号化されているので、内容を他人に読まれないようになっています。(改ざんされたcookieはRailsが拒否します)</p><p>CookieStoreには約4KBのデータを保存できます。他のセッションストアに比べて少量ですが、通常はこれで十分です。セッションに大量のデータを保存することは、利用するセッションストアの種類にかかわらずお勧めできません。特に、セッションに複雑なオブジェクト (モデルインスタンスなどの基本的なRubyオブジェクトでないもの) を保存することはお勧めできません。このようなことをすると、サーバーがリクエスト間でセッションを再編成できずにエラーになることがあります。</p><p>ユーザーセッションに重要なデータが含まれていない場合、またはユーザーセッションを長期間保存する必要がない場合 (flashメッセージで使用したいだけの場合など) は、<code>ActionDispatch::Session::CacheStore</code>を検討してください。この方式では、Webアプリケーションに設定されているキャッシュ実装を利用してセッションを保存します。この方法のよい点は、既存のキャッシュインフラをそのまま利用してセッションを保存できることと、管理用の設定を追加する必要がないことです。この方法の欠点はセッションが短命になることです。セッションはいつでも消える可能性があります。</p><p>セッションストレージの詳細については<a href="security.html">セキュリティガイド</a>を参照してください。</p><p>別のセッションメカニズムが必要な場合は、<code>config/initializers/session_store.rb</code>ファイルを変更することで切り替えられます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# デフォルトのcookieベースのセッションに代えてデータベースセッションを
# 使用する場合は、機密情報を保存しないこと。
# (セッションテーブルの作成は"rails g active_record:session_migration"で行なう)
# Rails.application.config.session_store :active_record_store

</pre>
</div>
<p>Railsは、セッションデータに署名するときにセッションキー(=cookieの名前)を設定します。この動作も<code>config/initializers/session_store.rb</code>で変更できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# このファイルを変更後サーバーを必ず再起動してください。
Rails.application.config.session_store :cookie_store, key: '_your_app_session'

</pre>
</div>
<p><code>:domain</code>キーを渡して、cookieで使用するドメイン名を指定することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# このファイルを変更後サーバーを必ず再起動してください。
Rails.application.config.session_store :cookie_store, key: '_your_app_session', domain: ".example.com"

</pre>
</div>
<p>Railsはセッションデータの署名に使用する秘密鍵を (CookieStore用に) 設定します。この秘密鍵は<code>config/secrets.yml</code>で変更できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Be sure to restart your server when you modify this file.

# Your secret key is used for verifying the integrity of signed cookies.
# If you change this key, all old signed cookies will become invalid!

# Make sure the secret is at least 30 characters and all random,
# no regular words or you'll be exposed to dictionary attacks.
# You can use `rake secret` to generate a secure secret key.

# Make sure the secrets in this file are kept private
# if you're sharing your code publicly.

development:
  secret_key_base: a75d...

test:
  secret_key_base: 492f...

# Do not keep production secrets in the repository,
# instead read values from the environment.
production:
  secret_key_base: &lt;%= ENV["SECRET_KEY_BASE"] %&gt;

</pre>
</div>
<div class="note"><p><code>CookieStore</code>を使用中に秘密鍵を変更すると、既存のセッションがすべて無効になります。</p></div><h4 id="セッションにアクセスする"><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B">5.1 セッションにアクセスする</a></h4><p>コントローラ内では<code>session</code>インスタンスメソッドを使用してセッションにアクセスできます。</p><div class="note"><p>セッションは遅延読み込みされます。アクションのコードでセッションにアクセスしなかった場合、セッションは読込されません。従って、アクセスしていないのであればセッションを無効にする必要はまったくありません。アクセスしないことで既にセッションは無効になっています。</p></div><p>セッションの値は、ハッシュに似たキー/値ペアを使用して保存されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ApplicationController &lt; ActionController::Base

  private

  # キー付きのセッションに保存されたidでユーザーを検索する
  # :current_user_id はRailsアプリケーションでユーザーログインを扱う際の定番の方法。
  # ログインするとセッション値が設定され、
  # ログアウトするとセッション値が削除される。
  def current_user
    @_current_user ||= session[:current_user_id] &amp;&amp;
      User.find_by(id: session[:current_user_id])
  end
end

</pre>
</div>
<p>セッションを使用して何かを行なうのであれば、ハッシュに似たキーにセッションを割り当てます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class LoginsController &lt; ApplicationController
  # "Create" a login, aka "log the user in"
  def create
    if user = User.authenticate(params[:username], params[:password])
      # セッションのuser idを保存し、
      # 今後のリクエストで使用できるようにする
      session[:current_user_id] = user.id
      redirect_to root_url
    end
  end
end

</pre>
</div>
<p>セッションからデータの一部を削除したい場合は、キーに<code>nil</code>を割り当てます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class LoginsController &lt; ApplicationController
  # ログインを削除する (=ログアウト)
  def destroy
    # セッションidからuser idを削除する
    @_current_user = session[:current_user_id] = nil
    redirect_to root_url
  end
end

</pre>
</div>
<p>セッション全体をリセットするには<code>reset_session</code>を使用します。</p><h4 id="flash"><a href="#flash">5.2 Flash</a></h4><p>flashはセッションの中の特殊な部分であり、リクエストごとにクリアされます。この特徴から、flashは「直後のリクエスト」でのみ参照可能になります。これはエラーメッセージを渡したりするのに便利です。</p><p>flashのアクセス方法はセッションとほとんど同じで、ハッシュとしてアクセスします (これを<a href="http://api.rubyonrails.org/classes/ActionDispatch/Flash/FlashHash.html">FlashHash</a> インスタンスと呼びます)。</p><p>例として、ログアウトする動作を扱ってみましょう。コントローラでflashを使用することで、次のリクエストで表示するメッセージを送信できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class LoginsController &lt; ApplicationController
  def destroy
    session[:current_user_id] = nil
    flash[:notice] = "You have successfully logged out."
    redirect_to root_url
  end
end

</pre>
</div>
<p>flashメッセージはリダイレクトの一部として割り当てることもできることにご注目ください。オプションとして<code>:notice</code>、<code>:alert</code>の他に、一般的な<code>:flash</code>を使用することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
redirect_to root_url, notice: "You have successfully logged out."
redirect_to root_url, alert: "You're stuck here!"
redirect_to root_url, flash: { referral_code: 1234 }

</pre>
</div>
<p>この<code>destroy</code>アクションでは、アプリケーションの<code>root_url</code>にリダイレクトし、そこでメッセージを表示します。flashメッセージは、直前のアクションでflashメッセージにどのようなメッセージを設定していたかにかかわらず、次に行われるアクションだけですべて決まりますのでご注意ください。Railsアプリケーションのレイアウトでは、flashを使用して警告や通知を表示するのが通例です。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;html&gt;
  &lt;!-- &lt;head/&gt; --&gt;
  &lt;body&gt;
    &lt;% flash.each do |name, msg| -%&gt;
      &lt;%= content_tag :div, msg, class: name %&gt;
    &lt;% end -%&gt;

    &lt;!-- 以下略 --&gt;
  &lt;/body&gt;
&lt;/html&gt; 

</pre>
</div>
<p>このように、アクションで通知(notice)や警告(alert)メッセージを設置すると、レイアウト側で自動的にそのメッセージが表示されます。</p><p>flashには、通知や警告に限らず、セッションに保存可能なものであれば何でも保存できます。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;% if flash[:just_signed_up] %&gt;
  &lt;p class="welcome"&gt;Welcome to our site!&lt;/p&gt;
&lt;% end %&gt;

</pre>
</div>
<p>flashの値を別のリクエストにも引き継ぎたい場合は、<code>keep</code>メソッドを使用します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class MainController &lt; ApplicationController
  # このアクションはroot_urlに対応しており、このアクションに対する
  # すべてのリクエストをUsersController#indexにリダイレクトしたいとします。
  # あるアクションでflashを設定してこのindexアクションにリダイレクトすると、
  # 別のリダイレクトが発生した場合にはflashは消えてしまいます。
  # ここで'keep'を使用すると別のリクエストでflashが消えないようになります。
  def index
    # すべてのflash値を保持する
    flash.keep

    # キーを指定して値を保持することもできる
    # flash.keep(:notice)
    redirect_to users_url
  end
end

</pre>
</div>
<h5 id="flash-now"><a href="#flash-now">5.2.1 <code>flash.now</code></a></h5><p>デフォルトでは、flashに値を追加すると直後のリクエストでその値を利用できますが、場合によっては、次のリクエストを待たずに同じリクエスト内でこれらのflash値にアクセスしたくなることがあります。たとえば、<code>create</code>アクションに失敗してリソースが保存されなかった場合に、<code>new</code>テンプレートを直接描画するとします。このとき新しいリクエストは行われませんが、この状態でもflashを使用してメッセージを表示したいこともあります。このような場合、<code>flash.now</code>を使用すれば通常の<code>flash</code>と同じ要領でメッセージを表示できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ClientsController &lt; ApplicationController
  def create
    @client = Client.new(params[:client])
    if @client.save
      # ...
    else
      flash.now[:error] = "Could not save client"
      render action: "new"
    end
  end
end

</pre>
</div>
<h3 id="cookies"><a href="#cookies">6 Cookies</a></h3><p>Webアプリケーションでは、cookieと呼ばれる少量のデータをクライアントのブラウザに保存することができます。HTTPでは基本的にリクエストとリクエストの間には何の関連もありませんが、cookieを使用することでリクエスト同士の間で (あるいはセッション同士の間であっても) このデータが保持されるようになります。Railsでは<code>cookies</code>メソッドを使用してcookieに簡単にアクセスできます。アクセス方法はセッションの場合とよく似ていて、ハッシュのように動作します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class CommentsController &lt; ApplicationController
  def new
    # cookieにコメント作者名が残っていたらフィールドに自動入力する
    @comment = Comment.new(author: cookies[:commenter_name])
  end

  def create
    @comment = Comment.new(params[:comment])
    if @comment.save
      flash[:notice] = "Thanks for your comment!"
      if params[:remember_name]
        # コメント作者名を保存する
        cookies[:commenter_name] = @comment.author
      else
        # コメント作者名がcookieに残っていたら削除する
        cookies.delete(:commenter_name)
      end
      redirect_to @comment.article
    else
      render action: "new"
    end
  end
end

</pre>
</div>
<p>セッションを削除する場合はキーに<code>nil</code>を指定することで削除しましたが、cookieを削除する場合はこの方法ではなく、<code>cookies.delete(:key)</code>を使用してください。</p><p>Railsでは、機密データ保存のために署名済みcookie jarと暗号化cookie jarを利用することもできます。署名済みcookie jarでは、暗号化した署名をcookie値に追加することで、cookieの改竄を防ぎます。暗号化cookie jarでは、署名の追加と共に、値自体を暗号化してエンドユーザーに読まれることのないようにします。
詳細については<a href="http://api.rubyonrails.org/classes/ActionDispatch/Cookies.html">APIドキュメント</a>を参照してください。</p><p>これらの特殊なcookieではシリアライザを使用して値を文字列に変換して保存し、読み込み時に逆変換(deserialize)を行ってRubyオブジェクトに戻しています。</p><p>使用するシリアライザを指定することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Rails.application.config.action_dispatch.cookies_serializer = :json

</pre>
</div>
<p>新規アプリケーションのデフォルトシリアライザは<code>:json</code>です。既存のcookieが残っている旧アプリケーションとの互換性のため、<code>serializer</code>オプションに何も指定されていない場合は<code>:marshal</code>が使用されます。</p><p>シリアライザのオプションに<code>:hybrid</code>を指定することもできます。これを指定すると、<code>Marshal</code>でシリアライズされた既存のcookieも透過的にデシリアライズし、保存時に<code>JSON</code>フォーマットで保存し直します。これは、既存のアプリケーションを<code>:json</code>シリアライザに移行するときに便利です。</p><p><code>load</code>メソッドと<code>dump</code>メソッドに応答するカスタムのシリアライザを指定することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Rails.application.config.action_dispatch.cookies_serializer = MyCustomSerializer

</pre>
</div>
<p><code>:json</code>または<code>:hybrid</code>シリアライザを使用する場合、一部のRubyオブジェクトがJSONとしてシリアライズされない可能性があることにご注意ください。たとえば、<code>Date</code>オブジェクトや<code>Time</code>オブジェクトはstringsとしてシリアライズされ、<code>Hash</code>のキーはstringに変換されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class CookiesController &lt; ApplicationController
  def set_cookie
    cookies.encrypted[:expiration_date] = Date.tomorrow # =&gt; Thu, 20 Mar 2014
    redirect_to action: 'read_cookie'
  end

  def read_cookie
    cookies.encrypted[:expiration_date] # =&gt; "2014-03-20"
  end
end

</pre>
</div>
<p>cookieには文字列や数字などの単純なデータだけを保存することをお勧めします。
cookieに複雑なオブジェクトを保存しなければならない場合は、後続のリクエストでcookieから値を読み出す場合の変換については自分で面倒を見る必要があります。</p><p>cookieセッションストアを使用する場合、<code>session</code>や<code>flash</code>ハッシュについてもこのことは該当します。</p><h3 id="xmlとjsonデータを描画する"><a href="#xml%E3%81%A8json%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E6%8F%8F%E7%94%BB%E3%81%99%E3%82%8B">7 XMLとJSONデータを描画する</a></h3><p>ActionControllerのおかげで、<code>XML</code>データや<code>JSON</code>データの出力 (レンダリング) は非常に簡単に行えます。scaffoldを使用して生成したコントローラは以下のようになっているはずです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class UsersController &lt; ApplicationController
  def index
    @users = User.all
    respond_to do |format|
      format.html # index.html.erb
      format.xml  { render xml: @users}
      format.json { render json: @users}
    end
  end
end

</pre>
</div>
<p>上のコードでは、<code>render xml: @users.to_xml</code>ではなく<code>render xml: @users</code>となっていることにご注目ください。Railsは、オブジェクトが文字列型でない場合は自動的に<code>to_xml</code>を呼んでくれます。</p><h3 id="フィルタ"><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF">8 フィルタ</a></h3><p>フィルタは、アクションの直前 (before)、直後 (after)、あるいはその両方 (around) に実行されるメソッドです。</p><p>フィルタは継承可能であるため、<code>ApplicationController</code>でフィルタを設定すればアプリケーションのすべてのコントローラでフィルタが有効になります。</p><p>"Before"フィルタは、リクエストサイクルを止めてしまう可能性があることに留意してください。"before"フィルタのよくある使われ方として、ユーザーがアクションを実行する前にログインを要求するというのがあります。このフィルタメソッドは以下のような感じになるでしょう。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ApplicationController &lt; ActionController::Base
  before_action :require_login

  private

  def require_login
    unless logged_in?
      flash[:error] = "You must be logged in to access this section"
      redirect_to new_login_url # halts request cycle
    end
  end
end

</pre>
</div>
<p>このメソッドはエラーメッセージをflashに保存し、ユーザーがログインしていない場合にはログインフォームにリダイレクトするというシンプルなものです。"before"フィルタによって出力またはリダイレクトが行われると、このアクションは実行されません。フィルタの実行後に実行されるようスケジュールされた追加のフィルタがある場合、これらもキャンセルされます。</p><p>この例ではフィルタを<code>ApplicationController</code>に追加したので、これを継承するすべてのコントローラが影響を受けます。つまり、アプリケーションのあらゆる機能についてログインが要求されることになります。当然ですが、アプリケーションのあらゆる画面で認証を要求してしまうと、認証に必要なログイン画面まで表示できなくなるという困った事態になってしまいます。従って、このようにすべてのコントローラやアクションでログイン要求を設定すべきではありません。<code>skip_before_action</code>メソッドを使用すれば、特定のアクションでフィルタを止めることができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class LoginsController &lt; ApplicationController
  skip_before_action :require_login, only: [:new, :create]
end

</pre>
</div>
<p>上のようにすることで、<code>LoginsController</code>の<code>new</code>アクションと<code>create</code>アクションをこれまでどおり認証不要にすることができました。特定のアクションについてだけフィルタをスキップしたい場合には<code>:only</code>オプションを使用します。逆に特定のアクションについてだけフィルタをスキップしたくない場合は<code>:except</code>オプションを使用します。これらのオプションはフィルタを追加するときにも使用できるので、最初の場所で選択したアクションに対してだけ実行されるフィルタを追加することもできます。</p><h4 id="afterフィルタとaroundフィルタ"><a href="#after%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%A8around%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF">8.1 afterフィルタとaroundフィルタ</a></h4><p>"before"フィルタ以外に、アクションの実行後に実行されるフィルタや、実行前実行後の両方で実行されるフィルタを使用することもできます。</p><p>"after"フィルタは"before"フィルタと似ていますが、"after"フィルタの場合はアクションは既に実行済みであり、クライアントに送信されようとしている応答データにアクセスできる点が"before"フィルタとは異なります。当然ながら、"after"フィルタをどのように書いても、アクションの実行が中断するようなことはありません。</p><p>"around"フィルタを使用する場合は、フィルタ内のどこかで必ず<code>yield</code>を実行して、関連付けられたアクションを実行してやる義務が生じます。これはRackミドルウェアの動作と似ています。</p><p>たとえば、何らかの変更に際して承認ワークフローがあるWebサイトを考えてみましょう。管理者はこれらの変更内容を簡単にプレビューし、トランザクション内で承認できるとします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ChangesController &lt; ApplicationController
  around_action :wrap_in_transaction, only: :show

  private

  def wrap_in_transaction
    ActiveRecord::Base.transaction do
      begin
        yield
      ensure
        raise ActiveRecord::Rollback
      end
    end
  end
end

</pre>
</div>
<p>"around"フィルタの場合、画面出力 (レンダリング) もその作業に含まれていることにご注意ください。特に、上の例で言うとビュー自身がデータベースから (スコープなどを使用して) 読み出しを行うとすると、その読み出しはトランザクション内で行われ、データはプレビューに表示されます。</p><p>あえてyieldを実行せず、自分で応答を作成するという方法もあります。この場合、アクションは実行されません。</p><h4 id="その他のフィルタ使用法"><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E4%BD%BF%E7%94%A8%E6%B3%95">8.2 その他のフィルタ使用法</a></h4><p>最も一般的なフィルタの使用法は、privateメソッドを作成し、*_action を使用してそのメソッドを追加することですが、同じ結果を得られるフィルタ使用法が他にも2とおりあります。</p><p>1番目は、*_action メソッドに対して直接ブロックを与えることです。このブロックはコントローラを引数として受け取ります。さきほどの<code>require_login</code>フィルタを書き換えて、ブロックを使用するようにします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ApplicationController &lt; ActionController::Base
  before_action do |controller|
    unless controller.send(:logged_in?)
      flash[:error] = "You must be logged in to access this section"
      redirect_to new_login_url
    end
  end
end

</pre>
</div>
<p>ここで、フィルタで<code>send</code>メソッドを使用していることにご注意ください。その理由は、<code>logged_in?</code>メソッドはprivateであり、コントローラのスコープではフィルタが動作しないためです (訳注: <code>send</code>メソッドを使用するとprivateメソッドを呼び出せます)。この方法は、特定のフィルタを実装する方法としては推奨されませんが、もっとシンプルな場合には役に立つことがあるかもしれません。</p><p>2番目の方法はクラスを使用してフィルタを扱うものです (実際には、正しいメソッドに応答するオブジェクトであれば何でも構いません)。他の2つの方法で実装すると読みやすくならず、再利用も困難になるような複雑な場合に有用です。例として、ログインフィルタをクラスで書き換えてみましょう。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ApplicationController &lt; ActionController::Base
  before_action LoginFilter
end

class LoginFilter
  def self.before(controller)
    unless controller.send(:logged_in?)
      controller.flash[:error] = "You must be logged in to access this section"
      controller.redirect_to controller.new_login_url
    end
  end
end

</pre>
</div>
<p>繰り返しますが、この例はフィルタとして理想的なものではありません。その理由は、このフィルタがコントローラのスコープで動作せず、コントローラが引数として渡されるからです。このフィルタクラスには、フィルタと同じ名前のメソッドを実装する必要があります。従って、<code>before_action</code>フィルタの場合、クラスに<code>before</code>メソッドを実装しなければならない、という具合です。<code>around</code>メソッド内では<code>yield</code>を呼んでアクションを実行してやる必要があります。</p><h3 id="リクエストフォージェリからの保護"><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA%E3%81%8B%E3%82%89%E3%81%AE%E4%BF%9D%E8%AD%B7">9 リクエストフォージェリからの保護</a></h3><p>クロスサイトリクエストフォージェリは攻撃手法の一種です。邪悪なWebサイトがユーザーをだまし、攻撃目標となるWebサイトへの危険なリクエストを知らないうちに作成させるというものです。攻撃者は標的ユーザーに関する知識や権限を持っていなくても、目標サイトに対してデータの追加/変更/削除を行わせることができてしまいます。</p><p>この攻撃を防ぐために必要な手段の第一歩は、「create/update/destroyのような破壊的な操作に対して絶対にGETリクエストでアクセスできない」ようにすることです。WebアプリケーションがRESTful規則に従っていれば、これは守られているはずです。しかし、邪悪なWebサイトはGET以外のリクエストを目標サイトに送信することなら簡単にできてしまいます。リクエストフォージェリの保護はまさにここを守るためのものです。文字どおり、リクエストの偽造(forgery)から保護するのです。</p><p>その具体的な保護方法は、推測不可能なトークンをすべてのリクエストに追加することです。このトークンはサーバーだけが知っています。これにより、リクエストに含まれているトークンが不正であればアクセスが拒否されます。</p><p>以下のようなフォームを試しに生成してみます。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= form_for @user do |f| %&gt;
  &lt;%= f.text_field :username %&gt;
  &lt;%= f.text_field :password %&gt;
&lt;% end %&gt;

</pre>
</div>
<p>以下のようにトークンが隠しフィールドに追加されている様子がわかります。</p><div class="code_container">
<pre class="brush: xml; gutter: false; toolbar: false">
&lt;form accept-charset="UTF-8" action="/users/1" method="post"&gt;
&lt;input type="hidden"
       value="67250ab105eb5ad10851c00a5621854a23af5489"
       name="authenticity_token"/&gt;
&lt;!-- fields --&gt;
&lt;/form&gt;

</pre>
</div>
<p>Railsでは、<a href="form_helpers.html">formヘルパー</a>を使用して生成されたあらゆるフォームにトークンを追加します。従って、この攻撃を心配する必要はほとんどありません。formヘルパーを使用せずに手作りした場合や、別の理由でトークンが必要な場合には、<code>form_authenticity_token</code>メソッドでトークンを生成できます。</p><p><code>form_authenticity_token</code>メソッドは、有効な認証トークンを生成します。このメソッドは、カスタムAjax呼び出しなどのように、Railsが自動的にトークンを追加してくれない箇所で使用するのに便利です。</p><p>本ガイドの<a href="security.html">セキュリティガイド</a>では、この話題を含む多くのセキュリティ問題について言及しており、いずれもWebアプリケーションを開発するうえで必読です。</p><h3 id="リクエストオブジェクトとレスポンスオブジェクト"><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A8%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88">10 リクエストオブジェクトとレスポンスオブジェクト</a></h3><p>すべてのコントローラには、現在実行中のリクエストサイクルに関連するリクエストオブジェクトとレスポンスオブジェクトを指す、2つのアクセサメソッドがあります。<code>request</code>メソッドは<code>AbstractRequest</code>クラスのインスタンスを含み、<code>response</code>メソッドは、今クライアントに戻されようとしている内容を表すレスポンスオブジェクトを返します。</p><h4 id="requestオブジェクト"><a href="#request%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88">10.1 <code>request</code>オブジェクト</a></h4><p>リクエストオブジェクトには、クライアントブラウザから返されるリクエストに関する有用な情報が多数含まれています。利用可能なメソッドをすべて知りたい場合は<a href="http://api.rubyonrails.org/classes/ActionDispatch/Request.html">APIドキュメント</a>を参照してください。その中から、このオブジェクトでアクセス可能なメソッドを紹介します。</p>
<table>
<thead>
<tr>
<th>
<code>request</code>のプロパティ</th>
<th>目的</th>
</tr>
</thead>
<tbody>
<tr>
<td>host</td>
<td>リクエストで使用されているホスト名</td>
</tr>
<tr>
<td>domain(n=2)</td>
<td>ホスト名の右 (TLD:トップレベルドメイン) から数えて<code>n</code>番目のセグメント</td>
</tr>
<tr>
<td>format</td>
<td>クライアントからリクエストされたContent-Type</td>
</tr>
<tr>
<td>method</td>
<td>リクエストで使用されたHTTPメソッド</td>
</tr>
<tr>
<td>get?, post?, patch?, put?, delete?, head?</td>
<td>HTTPメソッドがGET/POST/PATCH/PUT/DELETE/HEADのいずれかの場合にtrueを返す</td>
</tr>
<tr>
<td>headers</td>
<td>リクエストに関連付けられたヘッダーを含むハッシュを返す</td>
</tr>
<tr>
<td>port</td>
<td>リクエストで使用されたポート番号 (整数)</td>
</tr>
<tr>
<td>protocol</td>
<td>プロトコル名に"://"を加えたものを返す ("http://"など)</td>
</tr>
<tr>
<td>query_string</td>
<td>URLの一部で使用されているクエリ文字 ("?"より後の部分)</td>
</tr>
<tr>
<td>remote_ip</td>
<td>クライアントのipアドレス</td>
</tr>
<tr>
<td>url</td>
<td>リクエストで使用されているURL全体</td>
</tr>
</tbody>
</table>
<h5 id="path-parameters、query-parameters、request-parameters"><a href="#path-parameters%E3%80%81query-parameters%E3%80%81request-parameters">10.1.1 <code>path_parameters</code>、<code>query_parameters</code>、<code>request_parameters</code></a></h5><p>Railsは、リクエストに関連するすべてのパラメータを<code>params</code>ハッシュに集約してくれます。例えば、クエリ文字列や、POSTで送信されたパラメータがそうです。requestオブジェクトには3つのアクセサがあり、パラメータの由来に応じたアクセスを行なうこともできます。<code>query_parameters</code>ハッシュにはクエリ文字列として送信されたパラメータが含まれます。<code>request_parameters</code>ハッシュにはPOST bodyの一部として送信されたパラメータが含まれます。<code>path_parameters</code>には、ルーティング機構によって特定のコントローラとアクションへのパスの一部であると認識されたパラメータが含まれます。</p><h4 id="responseオブジェクト"><a href="#response%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88">10.2 <code>response</code>オブジェクト</a></h4><p>responseオブジェクトはアクションが実行されるときに構築され、クライアントに送り返されるデータを描画 (レンダリング) するものなので、responseオブジェクトを直接使用することは通常ありません。しかし、たとえばafter filter内などでresponseオブジェクトを直接操作できれば便利です。responseオブジェクトのアクセサメソッドがセッターを持っていれば、これを使用してresponseオブジェクトの値を直接変更できます。</p>
<table>
<thead>
<tr>
<th>
<code>response</code>のプロパティ</th>
<th>目的</th>
</tr>
</thead>
<tbody>
<tr>
<td>body</td>
<td>クライアントに送り返されるデータの文字列。多くの場合HTML。</td>
</tr>
<tr>
<td>status</td>
<td>レスポンスのステータスコード (200 OK、404 file not foundなど)</td>
</tr>
<tr>
<td>location</td>
<td>リダイレクト時のリダイレクト先URL</td>
</tr>
<tr>
<td>content_type</td>
<td>レスポンスのContent-Type</td>
</tr>
<tr>
<td>charset</td>
<td>レスポンスで使用される文字セット。デフォルトは"utf-8"。</td>
</tr>
<tr>
<td>headers</td>
<td>レスポンスで使用されるヘッダー</td>
</tr>
</tbody>
</table>
<h5 id="カスタムヘッダーの設定"><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%98%E3%83%83%E3%83%80%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A">10.2.1 カスタムヘッダーの設定</a></h5><p>レスポンスでカスタムヘッダーを使用したいのであれば、<code>response.headers</code>が利用できます。このヘッダー属性はハッシュであり、ヘッダ名と値がその中でマップされています。一分の値はRailsによって自動的に設定されます。ヘッダに追加・変更を行いたい場合は以下のように<code>response.headers</code>に割り当てます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
response.headers["Content-Type"] = "application/pdf"

</pre>
</div>
<div class="note"><p>上のようなことをしたいのであれば、<code>content_type</code>セッターを直接使用する方がずっとわかりやすくなります。</p></div><h3 id="http認証"><a href="#http%E8%AA%8D%E8%A8%BC">11 HTTP認証</a></h3><p>Railsには2とおりのHTTP認証機構がビルトインされています。</p>
<ul>
<li>BASIC認証</li>
<li>ダイジェスト認証</li>
</ul>
<h4 id="http-basic認証"><a href="#http-basic%E8%AA%8D%E8%A8%BC">11.1 HTTP BASIC認証</a></h4><p>HTTP BASIC認証は認証スキームの一種であり、非常に多くのブラウザおよびHTTPクライアントによってサポートされています。例として、Webアプリケーションに管理画面があり、ブラウザのHTTP BASIC認証ダイアログウィンドウでユーザー名とパスワードを入力しないとアクセスできないようにしたいとします。このビルトイン認証メカニズムはとても簡単に利用できます。必要なのは<code>http_basic_authenticate_with</code>だけです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AdminsController &lt; ApplicationController
  http_basic_authenticate_with name: "humbaba", password: "5baa61e4"
end

</pre>
</div>
<p>このとき、<code>AdminsController</code>を継承した名前空間付きのコントローラを作成することもできます。このフィルタは、該当するコントローラのすべてのアクションで実行されるので、それらをHTTP BASIC認証で保護することができます。</p><h4 id="httpダイジェスト認証"><a href="#http%E3%83%80%E3%82%A4%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E8%AA%8D%E8%A8%BC">11.2 HTTPダイジェスト認証</a></h4><p>HTTPダイジェスト認証は、BASIC認証よりも高度な認証システムであり、暗号化されていない平文パスワードをネットワークに送信しなくて済む利点があります (BASIC認証も、HTTPS上で行えば安全になります)。Railsではダイジェスト認証も簡単に使用できます。必要なのは<code>authenticate_or_request_with_http_digest</code>メソッドだけです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AdminsController &lt; ApplicationController
  USERS = { "lifo" =&gt; "world" }

  before_action :authenticate

  private

    def authenticate
      authenticate_or_request_with_http_digest do |username|
        USERS[username]
      end
    end
end

</pre>
</div>
<p>上の例で示したように、<code>authenticate_or_request_with_http_digest</code>のブロックでは、引数を1つ (ユーザー名) しか取りません。そしてブロックからはパスワードが返されます。<code>authenticate_or_request_with_http_digest</code>から<code>nil</code>または<code>false</code>が返された場合は、認証が失敗します。</p><h3 id="ストリーミングとファイルダウンロード"><a href="#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%A8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89">12 ストリーミングとファイルダウンロード</a></h3><p>HTMLを出力するのではなく、ユーザーにファイルを直接送信したい場合があります。<code>send_data</code>メソッドと<code>send_file</code>メソッドはRailsのすべてのコントローラで利用でき、いずれもストリームデータをクライアントに送信するために使用します。<code>send_file</code>は、ディスク上のファイル名を取得したり、ファイルの内容をストリーミングしたりできる、便利なメソッドです。</p><p>クライアントにデータをストリーミングするには、<code>send_data</code>を使用します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require "prawn"
class ClientsController &lt; ApplicationController
  # クライアントに関する情報を含むPDFを生成し、
  # 返します。ユーザーはPDFをファイルダウンロードとして取得できます。
  def download_pdf
    client = Client.find(params[:id])
    send_data generate_pdf(client),
              filename: "#{client.name}.pdf",
              type: "application/pdf"
  end

  private

    def generate_pdf(client)
      Prawn::Document.new do
        text client.name, align: :center
        text "Address: #{client.address}"
        text "Email: #{client.email}"
      end.render
    end
end

</pre>
</div>
<p>上の例の<code>download_pdf</code>アクションから、privateメソッドが呼び出され、実際のPDF生成はprivateメソッド側で行われます。PDFは文字列として返されます。続いてこの文字列はクライアントに対してファイルダウンロードとしてストリーミング送信されます。このときに保存用のファイル名もクライアントに示されます。ストリーミング送信するファイルを、クライアント側でファイルとしてダウンロードして欲しくない (ファイルを保存して欲しくない) 場合があります。たとえば、HTMLページに埋め込める画像ファイルを撮影したとします。このときブラウザに対して、このファイルはダウンロード用ではないということを伝えるには、<code>:disposition</code>オプションに"inline"を指定します。逆のオプションは"attachment"で、こちらはストリーミングのデフォルト設定です。</p><h4 id="ファイルを送信する"><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B">12.1 ファイルを送信する</a></h4><p>サーバーのディスク上にすでにあるファイルを送信するには、<code>send_file</code>メソッドを使用します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ClientsController &lt; ApplicationController
  # ディスク上に生成・保存済みのファイルをストリーミング送信する
  def download_pdf
    client = Client.find(params[:id])
    send_file("#{Rails.root}/files/clients/#{client.id}.pdf",
              filename: "#{client.name}.pdf",
              type: "application/pdf")
  end
end

</pre>
</div>
<p>ファイルは4KBずつ読み出され、ストリーミング送信されます。これは、巨大なファイルを一度にメモリに読み込まないようにするためです。この分割読み出しは<code>:stream</code>オプションでオフにできます。<code>:buffer_size</code>オプションでブロックサイズを調整することもできます。</p><p><code>:type</code>オプションが未指定の場合、<code>:filename</code>で取得したファイル名の拡張子から推測して与えられます。拡張子に該当するContent-TypeがRailsに登録されていない場合、<code>application/octet-stream</code>が使用されます。</p><div class="warning"><p>サーバーのディスク上のファイルパスを指定するときに、(paramsやcookieなどの) クライアントから送信されたデータを使用する場合は、十分な注意が必要です。クライアントから邪悪なファイルパスが送り込まれ、開発者が意図しないファイルにアクセスされてしまうというセキュリティ上のリスクがあることを常に念頭に置いてください。</p></div><div class="info"><p>静的なファイルをわざわざRails経由でストリーミング送信することはお勧めできません。ほとんどの場合、Webサーバーのpublicフォルダに置いてダウンロードさせれば済みます。Railsを経由してストリーミングでダウンロードするよりも、ApacheなどのWebサーバーから直接ファイルをダウンロードする方が遥かに高効率であり、しかもRailsスタック全体を経由する不必要なリクエストを受け付けずに済みます。</p></div><h4 id="restfulなダウンロード"><a href="#restful%E3%81%AA%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89">12.2 RESTfulなダウンロード</a></h4><p><code>send_data</code>だけでも問題なく使用できますが、真にRESTfulなアプリケーションを作ろうとしているのであれば、ファイルダウンロード専用にわざわざアクションを作成する必要は通常はありません。RESTという用語では、上の例で使用されているPDFファイルのようなものは、クライアントリソースを別の形で表現したものであると見なされます。Railsには、これに基づいた"RESTfulダウンロード"を簡単に実現するための洗練された手段も用意されています。PDFダウンロードをストリーミングとして扱わず、<code>show</code>アクションの一部として扱うように上の例を変更したものを以下に示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ClientsController &lt; ApplicationController
  # ユーザーはリソース受信時にHTMLまたはPDFをリクエストできる
  def show
    @client = Client.find(params[:id])

    respond_to do |format|
      format.html
      format.pdf { render pdf: generate_pdf(@client) }
    end
  end
end

</pre>
</div>
<p>なお、この例が実際に動作するには、RailsのMIME typeにPDFを追加する必要があります。これを行なうには、<code>config/initializers/mime_types.rb</code>に以下を追加します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Mime::Type.register "application/pdf", :pdf

</pre>
</div>
<div class="note"><p>Railsの設定ファイルは、起動時にしか読み込まれません(app/以下のファイルのようにリクエストごとに読み出されたりしません)。上の設定変更を反映するサーバーを再起動する必要があります。</p></div><p>これで、以下のようにURLに".pdf"を追加するだけでPDF版のclientを取得できます。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
GET /clients/1.pdf

</pre>
</div>
<h4 id="任意のデータをライブストリーミングする"><a href="#%E4%BB%BB%E6%84%8F%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%83%A9%E3%82%A4%E3%83%96%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B">12.3 任意のデータをライブストリーミングする</a></h4><p>Railsは、ファイル以外のものをストリーミング送信することもできます。実際、responseオブジェクトに含まれるものなら何でもストリーミング送信できます。<code>ActionController::Live</code>モジュールを使用すると、ブラウザとの永続的な接続を作成することができます。これにより、いつでも好きなタイミングで任意のデータをブラウザに送信することができます。</p><h5 id="ライブストリーミングを組み込む"><a href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%82%92%E7%B5%84%E3%81%BF%E8%BE%BC%E3%82%80">12.3.1 ライブストリーミングを組み込む</a></h5><p>コントローラクラスの内部に<code>ActionController::Live</code>を組み込むと、そのコントローラのすべてのアクションでデータをストリーミングできるようになります。このモジュールを以下のようにミックスインできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class MyController &lt; ActionController::Base
  include ActionController::Live

  def stream
    response.headers['Content-Type'] = 'text/event-stream'
    100.times {
      response.stream.write "hello world\n"
      sleep 1
    }
  ensure
    response.stream.close
  end
end

</pre>
</div>
<p>上のコードでは、ブラウザとの間に永続的な接続を確立し、1秒おきに<code>"hello world\n"</code>を100個ずつ送信しています。</p><p>上の例には注意点がいくつもあります。レスポンスのストリームは確実に閉じられるようにする必要があります。ストリームを閉じ忘れると、ソケットが永久に開いたままになってしまいます。レスポンスストリームへの書き込みを行う前に、Content-Typeを<code>text/event-stream</code>に設定する必要もあります。その理由は、レスポンスがコミットされてしまうと (<code>response.committed</code>がtrueに相当する値を返したとき)、以後ヘッダーに書き込みできないからです。これは、レスポンスストリームに対して<code>write</code>または<code>commit</code>を行った場合に発生します。</p><h5 id="使用例"><a href="#%E4%BD%BF%E7%94%A8%E4%BE%8B">12.3.2 使用例</a></h5><p>今あなたはカラオケマシンを開発中です。ユーザーは曲の歌詞を見たいと思っています。それぞれの<code>Song</code>には特定の数の行があり、その行1つ1つに、「曲が終わるまで後何拍あるか」を表す<code>num_beats</code>が記入されています。</p><p>歌詞を「カラオケスタイル」でユーザーに表示したいので、直前の歌詞を歌い終わってから次の歌詞を表示することになります。そこで、以下のように<code>ActionController::Live</code>を使用します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class LyricsController &lt; ActionController::Base
  include ActionController::Live

  def show
    response.headers['Content-Type'] = 'text/event-stream'
    song = Song.find(params[:id])

    song.each do |line|
      response.stream.write line.lyrics
      sleep line.num_beats
    end
  ensure
    response.stream.close
  end
end

</pre>
</div>
<p>上のコードでは、お客さんが直前の歌詞を歌い終わった時に限って次の歌詞を送信しています。</p><h5 id="ストリーミングを行う場合の考慮事項"><a href="#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86%E5%A0%B4%E5%90%88%E3%81%AE%E8%80%83%E6%85%AE%E4%BA%8B%E9%A0%85">12.3.3 ストリーミングを行う場合の考慮事項</a></h5><p>任意のデータをストリーミング送信できることは、きわめて強力なツールとなります。これまでの例でご紹介したように、好きな時に好きなものをレスポンスストリームに流すことができます。ただし、以下の点についてご注意ください。</p>
<ul>
<li>レスポンスストリームが1つ作成されるたびに新しいスレッドが作成され、元のスレッドからスレッドローカルな変数がコピーされます。スレッドローカルな変数が増えすぎるとパフォーマンスに悪影響が生じます。また、スレッド数が多すぎても同様にパフォーマンスが低下します。</li>
<li>レスポンスストリームを閉じることに失敗すると、対応するソケットが永久に開いたままになってしまいます。レスポンスストリームを使用する場合は、<code>close</code>が確実に呼び出されるようにしてください。</li>
<li>WEBrickサーバーはすべてのレスポンスをバッファリングするため、<code>ActionController::Live</code>をインクルードしても動作しません。このため、レスポンスを自動的にバッファリングしないWebサーバーを使用する必要があります。</li>
</ul>
<h3 id="ログをフィルタする"><a href="#%E3%83%AD%E3%82%B0%E3%82%92%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%99%E3%82%8B">13 ログをフィルタする</a></h3><p>Railsのログファイルは、環境ごとに<code>log</code>フォルダの下に出力されます。デバッグ時にアプリケーションで何が起こっているかをログで確認できると非常に便利なのですが、その一方で本番のアプリケーションでは顧客のパスワードのような重要な情報をログファイルに出力したくないこともあります。</p><h4 id="パラメータをフィルタする"><a href="#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%99%E3%82%8B">13.1 パラメータをフィルタする</a></h4><p>Railsアプリケーションの設定ファイル config.filter_parameters に、特定のリクエストパラメータをログ出力時にフィルタする設定を追加することができます。フィルタされたパラメータはログ内で [FILTERED] という文字に置き換えられます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.filter_parameters &lt;&lt; :password

</pre>
</div>
<h4 id="リダイレクトをフィルタする"><a href="#%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%82%92%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%99%E3%82%8B">13.2 リダイレクトをフィルタする</a></h4><p>アプリケーションからのリダイレクト先となるURLのいくつかは、場合によってはログに出力しない方がよいことがあります。
設定の<code>config.filter_redirect</code>オプションを使用して、リダイレクト先をログに出力しないようにすることができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.filter_redirect &lt;&lt; 's3.amazonaws.com'

</pre>
</div>
<p>フィルタしたいリダイレクト先は、文字列、正規表現、または両方を含む配列で指定することができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.filter_redirect.concat ['s3.amazonaws.com', /private_path/]

</pre>
</div>
<p>マッチしたURLはログで'[FILTERED]'という文字に置き換えられます。</p><h3 id="rescue"><a href="#rescue">14 Rescue</a></h3><p>どんなアプリケーションにもどこかにバグが潜んでいたり、適切に扱う必要のある例外をスローすることがあるものです。たとえば、データベースに既に存在しなくなったリソースに対してユーザーがアクセスした場合、Active Recordは<code>ActiveRecord::RecordNotFound</code>例外をスローします。</p><p>Railsのデフォルトの例外ハンドリングでは、例外の種類にかかわらず"500 Server Error"を表示します。リクエストがローカルのブラウザから行われた場合、詳細なトレースバックや追加情報が表示されますので、問題点を把握して対応することができます。リクエストがリモートブラウザの場合、Railsは"500 Server Error"というメッセージだけをユーザーに表示したり、ルーティングやレコードがない場合は"404 Not Found"と表示したりします。このままではあまりにそっけないので、エラーのキャッチ方法やユーザーへの表示方法をカスタマイズしたくなるものです。Railsアプリケーションでは、例外ハンドリングをさまざまなレベルで実行できます。</p><h4 id="デフォルトの500・404テンプレート"><a href="#%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE500%E3%83%BB404%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">14.1 デフォルトの500・404テンプレート</a></h4><p>デフォルトでは、本番のRailsアプリケーションは404または500エラーメッセージを表示します。これらのメッセージは<code>public</code>フォルダ以下に置かれている静的なHTMLファイルです。それぞれ<code>404.html</code>および<code>500.html</code>という名前です。これらのファイルをカスタマイズして、情報を追加したりレイアウトを整えたりできます。ただし、これらはあくまで静的なHTMLファイルなので、RHTMLやERBは使用でいません。</p><h4 id="rescue-from"><a href="#rescue-from">14.2 <code>rescue_from</code></a></h4><p>エラーをキャッチしたときの動作をもう少し洗練されたものにしたい場合は、<code>rescue_from</code>を使用できます。これは、特定の種類または複数の種類の例外を1つのコントローラ全体およびそのサブクラスで扱えるようにするものです。</p><p><code>rescue_from</code>命令でキャッチできる例外が発生すると、ハンドラに例外オブジェクトが渡されます。このハンドラはメソッドか、<code>:with</code>オプション付きで渡された<code>Proc</code>オブジェクトのいずれかです。明示的に<code>Proc</code>オブジェクトを使用する代りに、ブロックを直接使用することもできます。</p><p><code>rescue_from</code>を使用してすべての<code>ActiveRecord::RecordNotFound</code>エラーを奪い取り、処理を行なう方法を以下に示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ApplicationController &lt; ActionController::Base
  rescue_from ActiveRecord::RecordNotFound, with: :record_not_found

  private

    def record_not_found
      render plain: "404 Not Found", status: 404
    end
end

</pre>
</div>
<p>前よりも巧妙にはなりましたが、もちろんこの例のままではエラーハンドリングは何も改良されていません。しかしこのようにすべての例外を捉えることができれば、後は好きなようにカスタマイズできます。たとえば、カスタム例外クラスを作成して、ユーザーがアクセス権を持たないアプリケーションの特定の箇所にアクセスした場合に例外をスローすることもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ApplicationController &lt; ActionController::Base
  rescue_from User::NotAuthorized, with: :user_not_authorized

  private

    def user_not_authorized
      flash[:error] = "You don't have access to this section."
      redirect_to :back
    end
end

class ClientsController &lt; ApplicationController
  # ユーザーがクライアントにアクセスする権限を持っているかどうかをチェックする
  before_action :check_authorization

  # このアクション内で認証周りを心配する必要がない
  def edit
    @client = Client.find(params[:id])
  end

  private

    # ユーザーが認証されていない場合は単に例外をスローする
    def check_authorization
      raise User::NotAuthorized unless current_user.admin?
    end
end

</pre>
</div>
<div class="note"><p><code>ApplicationController</code>クラスでは特定の例外についてはrescueできないものがあります。その理由は、コントローラが初期化されてアクションが実行される前に発生する例外があるからです。詳細については、Pratik Naikによる<a href="http://m.onkey.org/2008/7/20/rescue-from-dispatching">記事</a>を参照してください。</p></div><h3 id="httpsプロトコルを強制する"><a href="#https%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%82%92%E5%BC%B7%E5%88%B6%E3%81%99%E3%82%8B">15 HTTPSプロトコルを強制する</a></h3><p>セキュリティ上の理由から、特定のコントローラについてはHTTPSのみでアクセスできるように強制したいことがあります。コントローラ内で<code>force_ssl</code>メソッドを使用することでSSLを強制することができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class DinnerController
  force_ssl
end

</pre>
</div>
<p>フィルタの時と同様、<code>:only</code>オプションや<code>:except</code>オプションを使用して、コントローラ内の特定のアクションでのみセキュア接続を強制することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class DinnerController
  force_ssl only: :cheeseburger
  # または
  force_ssl except: :cheeseburger
end

</pre>
</div>
<p><code>force_ssl</code>を多くのコントローラに追加したいのであれば、アプリケーション全体でHTTPS接続を強制する方がよいでしょう。これを行なうには、環境ファイルで<code>config.force_ssl</code>を設定します。</p>
        

        <h3 id="feedback"><a href="#feedback">フィードバックについて</a></h3>
        <p>
          本ガイドは GitHub上の <a href="https://github.com/yasslab/railsguides.jp">yasslab/railsguides.jp</a> で管理・公開されております。
          本ガイドを読んで気になる文章や間違ったコードを見かけたら、上記リポジトリにてお気軽に <a href="https://github.com/yasslab/railsguides.jp/issues">Issue</a> を出して頂けると嬉しいです。また、「Pull Request を送りたい!」という場合には、<a href="ruby_on_rails_guides_guidelines.html">Ruby on Railsガイドのガイドライン</a>と、<a href="https://github.com/yasslab/railsguides.jp#%E7%BF%BB%E8%A8%B3%E3%81%AE%E6%B5%81%E3%82%8C">README</a>に記載されている「翻訳の流れ」をご参考にしてください。
        </p>
        <p>
          なお、原著における間違いを見つけたら、「Ruby on Railsに貢献する方法」に記されている<a href="/contributing_to_ruby_on_rails.html#rails%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AB%E8%B2%A2%E7%8C%AE%E3%81%99%E3%82%8B">Railsのドキュメントに貢献する</a>を参考にしながら、ぜひRailsコミュニティに貢献してみてしてください :)
        </p>
        <p>
          本ガイドの品質向上に向けて、皆さまのご協力が得られれば幸いです。よろしくお願い致します。
        </p>
        <ol class="snsb" style="margin-left: 0px">
	  <li><div class="fb-like" data-href="http://railsguides.jp/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div></li>
	  <li><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://railsguides.jp/" data-text="Ruby on Rails ガイド：体系的に Rails を学ぼう" data-lang="en" data-hashtags="Railsガイド" data-via="RailsGuidesJP" width="100">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></li>
          <li><iframe src="http://ghbtns.com/github-btn.html?user=yasslab&repo=railsguides.jp&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80" height="20"></iframe></li>
          <li><a href="http://b.hatena.ne.jp/entry/railsguides.jp" class="hatena-bookmark-button" data-hatena-bookmark-title="Ruby on Rails ガイド：体系的に Rails を学ぼう" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script></li>          
	  <li><div class="g-plusone" data-size="medium" data-lang="ja"></div>
	    <script type="text/javascript">
	      (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	      })();
	    </script>
	  </li>
        </ol>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <div class="sitemap">
          <dl class="L">
            <dt>はじめに</dt>
              <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
            <dt>モデル</dt>
              <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
              <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
              <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
              <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
              <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
              <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
              <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
            <dt>ビュー</dt>
              <dd><a href="action_view_overview.html">Action View の概要</a></dd>
              <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
              <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
            <dt>コントローラ</dt>
              <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
              <dd><a href="routing.html">Rails ルーティング</a></dd>
          </dl>
          <dl class="C">
            <dt>高度なトピック</dt>
              <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
              <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
              <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
              <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
              <dd><a href="testing.html">Rails テスティングガイド</a></dd>
              <dd><a href="security.html">Rails セキュリティガイド</a></dd>
              <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
              <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
              <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
              <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
              <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
              <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
              <dd><a href="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</a></dd>
              <dd><a href="caching_with_rails.html">Rails のキャッシュ: 概要</a></dd>
              <dd><a href="active_support_instrumentation.html">Active Support の Instrumentation 機能</a></dd>
              <dd><a href="profiling.html">Rails アプリケーションのプロファイリング</a></dd>
              <dd><a href="api_app.html">Rails による API 専用アプリ</a></dd>
              <dd><a href="action_cable_overview.html">Action Cable の概要</a></dd>
            <dt>Rails を拡張する</dt>
              <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
              <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
              <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
              <dd><a href="engines.html">Rails エンジン入門</a></dd>
          </dl>
          <dl class="R">
            <dt>Ruby on Rails に貢献する</dt>
              <dd><a href="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</a></dd>
              <dd><a href="development_dependencies_install.html">Rails コア開発環境の構築方法</a></dd>
              <dd><a href="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</a></dd>
              <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
            <dt>メンテナンスポリシー</dt>
              <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
            <dt>リリースノート</dt>
              <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
              <dd><a href="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</a></dd>
              <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
              <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
              <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
              <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
              <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
              <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
              <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
              <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
          </dl>
      </div>

      <ol class="snsb" style="padding-top: 20px">
	<li>本ガイドは<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.ja">クリエイティブ・コモンズ 表示-継承 4.0 国際</a> (CC BY-SA 4.0) ライセンスに基づいて公開されています。また、「Rails」および「Ruby on Rails」という名称、そして Rails のロゴは、David Heinemeier Hansson による登録商標で、すべての権利を有しています。</li>
      </ol>
    </div>
  </div>
</h5>
  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-50163209-4', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
