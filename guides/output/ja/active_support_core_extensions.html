<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport"    content="width=device-width, initial-scale=1"/>
    <meta name="description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />
    <meta name="keywords"    content="Ruby Rails ガイド 体系的 入門 無料" />
    <meta name="author"      content="Ruby on Rails Community" />

    <meta property="fb:admins"      content="715330868" />
    <meta property="og:title"       content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:site_name"   content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:image"       content="http://railsguides.jp/images/cover_for_facebook.png"/>
    <meta property="og:url"         content="http://railsguides.jp/" />
    <meta property="og:type"        content="article" />
    <meta property="og:description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />

    <meta name="twitter:card"  content="summary" />
    <meta name="twitter:site"  content="@RailsGuidesJP" />
    <meta name="twitter:title" content="Ruby on Rails ガイド：体系的に Rails を学ぼう" />
    <meta name="twitter:description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />
    <meta name="twitter:image" content="http://railsguides.jp/images/cover_for_twitter.png" />
    <meta name="twitter:url"   content="http://railsguides.jp/" />

    <title>Active Support コア拡張機能 | Rails ガイド</title>
    <meta name="apple-mobile-web-app-title" content="Railsガイド" />
    <meta name="application-name"           content="Railsガイド" />

    <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />

    <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />

    <link rel="apple-touch-icon" sizes="57x57" href="images/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

  </head>
<body class="guide">
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=614116885378153&version=v2.0";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">関連サイト: </strong>
      <span class="red-button more-info-button">関連URL</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://guides.rubyonrails.org/">原著 (英語)</a></li>
        <li class="more-info"><a href="https://github.com/yasslab/railsguides.jp">ソースコード (GitHub)</a></li>
        <li class="more-info"><a href="http://railstutorial.jp/">Rails チュートリアル</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="/" title="Return to home page">railsguides.jp</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="/">ホーム</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">ガイド目次</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>はじめに</dt>
                <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
                <dt>モデル</dt>
                <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
                <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
                <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
                <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
                <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
                <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
                <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
                <dt>ビュー</dt>
                <dd><a href="action_view_overview.html">Action View の概要</a></dd>
                <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
                <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
                <dt>コントローラ</dt>
                <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
                <dd><a href="routing.html">Rails ルーティング</a></dd>
              </dl>
              <dl class="R">
                <dt>高度なトピック</dt>
                <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
                <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
                <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
                <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
                <dd><a href="testing.html">Rails テスティングガイド</a></dd>
                <dd><a href="security.html">Rails セキュリティガイド</a></dd>
                <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
                <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
                <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
                <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
                <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
                <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
                <dd><a href="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</a></dd>
                <dd><a href="caching_with_rails.html">Rails のキャッシュ: 概要</a></dd>
                <dd><a href="active_support_instrumentation.html">Active Support の Instrumentation 機能</a></dd>
                <dd><a href="profiling.html">Rails アプリのプロファイリング</a></dd>
                <dd><a href="api_app.html">Rails による API 専用アプリ</a></dd>
                <dd><a href="action_cable_overview.html">Action Cable の概要</a></dd>
                <dt>Rails を拡張する</dt>
                <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
                <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
                <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
                <dd><a href="engines.html">Rails エンジン入門</a></dd>
                <dt>Ruby on Rails に貢献する</dt>
                <dd><a href="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</a></dd>
                <dd><a href="development_dependencies_install.html">Rails コア開発環境の構築方法</a></dd>
                <dd><a href="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</a></dd>
                <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
                <dt>メンテナンスポリシー</dt>
                <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
                <dt>リリースノート</dt>
                <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
                <dd><a href="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</a></dd>
                <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
                <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
                <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
                <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
                <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
                <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
                <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
                <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
              </dl>
          </div>
        </li>
        <li><a class="nav-item" href="https://github.com/yasslab/railsguides.jp#readme">翻訳に貢献する</a></li>
        <li><a class="nav-item" href="credits.html">原著者</a></li>
        <li><a class="nav-item" href="options.html">電子書籍 (検索対応)</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">ガイド目次</option>
              <optgroup label="はじめに">
                  <option value="getting_started.html">Rails をはじめよう</option>
              </optgroup>
              <optgroup label="モデル">
                  <option value="active_record_basics.html">Active Record の基礎</option>
                  <option value="active_record_migrations.html">Active Record マイグレーション</option>
                  <option value="active_record_validations.html">Active Record バリデーション</option>
                  <option value="active_record_callbacks.html">Active Record コールバック</option>
                  <option value="association_basics.html">Active Record の関連付け</option>
                  <option value="active_record_querying.html">Active Record クエリインターフェイス</option>
                  <option value="active_model_basics.html">Active Model の基礎</option>
              </optgroup>
              <optgroup label="ビュー">
                  <option value="action_view_overview.html">Action View の概要</option>
                  <option value="layouts_and_rendering.html">レイアウトとレンダリング</option>
                  <option value="form_helpers.html">Action View フォームヘルパー</option>
              </optgroup>
              <optgroup label="コントローラ">
                  <option value="action_controller_overview.html">Action Controller の概要</option>
                  <option value="routing.html">Rails ルーティング</option>
              </optgroup>
              <optgroup label="高度なトピック">
                  <option value="active_support_core_extensions.html">Active Support コア拡張機能</option>
                  <option value="i18n.html">Rails 国際化 (i18n) API</option>
                  <option value="action_mailer_basics.html">Action Mailer の基礎</option>
                  <option value="active_job_basics.html">Active Job の基礎</option>
                  <option value="testing.html">Rails テスティングガイド</option>
                  <option value="security.html">Rails セキュリティガイド</option>
                  <option value="debugging_rails_applications.html">Rails アプリケーションのデバッグ</option>
                  <option value="configuring.html">Rails アプリケーションを設定する</option>
                  <option value="command_line.html">コマンドラインツールと Rake タスク</option>
                  <option value="asset_pipeline.html">アセットパイプライン</option>
                  <option value="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</option>
                  <option value="initialization.html">Rails の初期化プロセス</option>
                  <option value="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</option>
                  <option value="caching_with_rails.html">Rails のキャッシュ: 概要</option>
                  <option value="active_support_instrumentation.html">Active Support の Instrumentation 機能</option>
                  <option value="profiling.html">Rails アプリのプロファイリング</option>
                  <option value="api_app.html">Rails による API 専用アプリ</option>
                  <option value="action_cable_overview.html">Action Cable の概要</option>
              </optgroup>
              <optgroup label="Rails を拡張する">
                  <option value="plugins.html">Rails プラグイン作成入門</option>
                  <option value="rails_on_rack.html">Rails と Rack</option>
                  <option value="generators.html">Rails ジェネレータとテンプレート入門</option>
                  <option value="engines.html">Rails エンジン入門</option>
              </optgroup>
              <optgroup label="Ruby on Rails に貢献する">
                  <option value="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</option>
                  <option value="development_dependencies_install.html">Rails コア開発環境の構築方法</option>
                  <option value="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</option>
              </optgroup>
              <optgroup label="メンテナンスポリシー">
                  <option value="maintenance_policy.html">メンテナンスポリシー</option>
              </optgroup>
              <optgroup label="リリースノート">
                  <option value="upgrading_ruby_on_rails.html">Rails アップグレードガイド</option>
                  <option value="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</option>
                  <option value="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide" />
  <div id="feature">
  <div class="wrapper">
      <h2>Active Support コア拡張機能</h2><p>Active SupportはRuby on Railsのコンポーネントであり、Ruby言語の拡張、ユーティリティ、その他横断的な作業を担っています。</p><p>Active Supportは言語レベルで基本部分を底上げして豊かなものにし、Railsアプリケーションの開発とRuby on Railsそれ自体の開発に役立てるべく作られています。</p><p>このガイドの内容:</p>
<ul>
<li>コア拡張機能について</li>
<li>すべての拡張機能を読み込む方法</li>
<li>必要な拡張機能だけを利用する方法</li>
<li>Active Supportが提供する拡張機能一覧</li>
</ul>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />目次</h3>
            <ol class="chapters">
<li>
<a href="#%E3%82%B3%E3%82%A2%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80%E6%96%B9%E6%B3%95">コア拡張機能を読み込む方法</a>

<ul>
<li><a href="#%E5%8D%98%E4%BD%93%E3%81%AEactive-support%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88">単体のActive Supportサポート</a></li>
<li><a href="#ruby-on-rails%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A7active-support%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B">Ruby on RailsアプリケーションでActive Supportを使用する</a></li>
</ul>
</li>
<li>
<a href="#%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8B%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD">すべてのオブジェクトで使用できる拡張機能</a>

<ul>
<li><a href="#blank-questionmark%E3%81%A8present-questionmark"><code>blank?</code>と<code>present?</code></a></li>
<li><a href="#presence"><code>presence</code></a></li>
<li><a href="#duplicable-questionmark"><code>duplicable?</code></a></li>
<li><a href="#deep-dup"><code>deep_dup</code></a></li>
<li><a href="#try"><code>try</code></a></li>
<li><a href="#class-eval-args-block"><code>class_eval(*args, &amp;block)</code></a></li>
<li><a href="#acts-like-questionmark-duck"><code>acts_like?(duck)</code></a></li>
<li><a href="#to-param"><code>to_param</code></a></li>
<li><a href="#to-query"><code>to_query</code></a></li>
<li><a href="#with-options"><code>with_options</code></a></li>
<li><a href="#json-support">JSON support</a></li>
<li><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E5%A4%89%E6%95%B0">インスタンス変数</a></li>
<li><a href="#%E8%AD%A6%E5%91%8A%E3%83%BB%E4%BE%8B%E5%A4%96%E3%81%AE%E6%8A%91%E5%88%B6">警告・例外の抑制</a></li>
<li><a href="#in-questionmark"><code>in?</code></a></li>
</ul>
</li>
<li>
<a href="#module%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Module</code>の拡張</a>

<ul>
<li><a href="#alias-method-chain"><code>alias_method_chain</code></a></li>
<li><a href="#%E5%B1%9E%E6%80%A7">属性</a></li>
<li><a href="#%E8%A6%AA">親</a></li>
<li><a href="#%E5%AE%9A%E6%95%B0">定数</a></li>
<li><a href="#%E5%88%B0%E9%81%94%E5%8F%AF%E8%83%BD">到達可能</a></li>
<li><a href="#%E7%84%A1%E5%90%8D%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB">無名モジュール</a></li>
<li><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%A7%94%E8%AD%B2">メソッド委譲</a></li>
<li><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%86%8D%E5%AE%9A%E7%BE%A9">メソッドの再定義</a></li>
</ul>
</li>
<li>
<a href="#class%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Class</code>の拡張</a>

<ul>
<li><a href="#class%E5%B1%9E%E6%80%A7">Class属性</a></li>
<li><a href="#%E3%82%B5%E3%83%96%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8%E5%AD%90%E5%AD%AB">サブクラスと子孫</a></li>
</ul>
</li>
<li>
<a href="#string%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>String</code>の拡張</a>

<ul>
<li><a href="#%E5%AE%89%E5%85%A8%E3%81%AA%E5%87%BA%E5%8A%9B">安全な出力</a></li>
<li><a href="#remove"><code>remove</code></a></li>
<li><a href="#squish"><code>squish</code></a></li>
<li><a href="#truncate"><code>truncate</code></a></li>
<li><a href="#truncate-words"><code>truncate_words</code></a></li>
<li><a href="#inquiry"><code>inquiry</code></a></li>
<li><a href="#starts-with-questionmark%E3%81%A8ends-with-questionmark"><code>starts_with?</code>と<code>ends_with?</code></a></li>
<li><a href="#strip-heredoc"><code>strip_heredoc</code></a></li>
<li><a href="#indent"><code>indent</code></a></li>
<li><a href="#access">Access</a></li>
<li><a href="#%E6%B4%BB%E7%94%A8%E5%BD%A2">活用形</a></li>
<li><a href="#string%E3%81%AE%E6%8B%A1%E5%BC%B5-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">各種変換</a></li>
</ul>
</li>
<li>
<a href="#numeric%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Numeric</code>の拡張</a>

<ul>
<li><a href="#%E3%83%90%E3%82%A4%E3%83%88">バイト</a></li>
<li><a href="#time">Time</a></li>
<li><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">フォーマッティング</a></li>
</ul>
</li>
<li>
<a href="#integer%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Integer</code>の拡張</a>

<ul>
<li><a href="#multiple-of-questionmark"><code>multiple_of?</code></a></li>
<li><a href="#ordinal"><code>ordinal</code></a></li>
<li><a href="#ordinalize"><code>ordinalize</code></a></li>
</ul>
</li>
<li>
<a href="#bigdecimal%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>BigDecimal</code>の拡張</a>

<ul>
<li><a href="#bigdecimal%E3%81%AE%E6%8B%A1%E5%BC%B5-to-s"><code>to_s</code></a></li>
<li><a href="#bigdecimal%E3%81%AE%E6%8B%A1%E5%BC%B5-to-formatted-s"><code>to_formatted_s</code></a></li>
</ul>
</li>
<li>
<a href="#enumerable%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Enumerable</code>の拡張</a>

<ul>
<li><a href="#sum"><code>sum</code></a></li>
<li><a href="#index-by"><code>index_by</code></a></li>
<li><a href="#many-questionmark"><code>many?</code></a></li>
<li><a href="#exclude-questionmark"><code>exclude?</code></a></li>
<li><a href="#without"><code>without</code></a></li>
</ul>
</li>
<li>
<a href="#array%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Array</code>の拡張</a>

<ul>
<li><a href="#accessing">Accessing</a></li>
<li><a href="#%E8%A6%81%E7%B4%A0%E3%82%92%E5%8A%A0%E3%81%88%E3%82%8B">要素を加える</a></li>
<li><a href="#%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%B1%95%E9%96%8B">オプションの展開</a></li>
<li><a href="#array%E3%81%AE%E6%8B%A1%E5%BC%B5-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">各種変換</a></li>
<li><a href="#%E3%83%A9%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0">ラッピング</a></li>
<li><a href="#%E8%A4%87%E8%A3%BD">複製</a></li>
<li><a href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96">グループ化</a></li>
</ul>
</li>
<li>
<a href="#hash%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Hash</code>の拡張</a>

<ul>
<li><a href="#hash%E3%81%AE%E6%8B%A1%E5%BC%B5-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">各種変換</a></li>
<li><a href="#%E3%83%9E%E3%83%BC%E3%82%B8">マージ</a></li>
<li><a href="#%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E8%A4%87%E8%A3%BD">ディープ複製</a></li>
<li><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AD%E3%83%BC%E3%81%AE%E6%93%8D%E4%BD%9C">ハッシュキーの操作</a></li>
<li><a href="#%E5%80%A4%E3%81%AE%E6%93%8D%E4%BD%9C">値の操作</a></li>
<li><a href="#%E3%82%B9%E3%83%A9%E3%82%A4%E3%82%B9">スライス</a></li>
<li><a href="#%E6%8A%BD%E5%87%BA">抽出</a></li>
<li><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AD%E3%83%BC%E3%81%8C%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%81%A7%E3%82%82%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E3%82%82%E5%90%8C%E6%A7%98%E3%81%AB%E6%89%B1%E3%81%86-indifferent-access">ハッシュキーがシンボルでも文字列でも同様に扱う (indifferent access)</a></li>
<li><a href="#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%AF%E3%83%88%E5%8C%96">コンパクト化</a></li>
</ul>
</li>
<li>
<a href="#regexp%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Regexp</code>の拡張</a>

<ul>
<li><a href="#multiline-questionmark"><code>multiline?</code></a></li>
</ul>
</li>
<li>
<a href="#range%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Range</code>の拡張</a>

<ul>
<li><a href="#range%E3%81%AE%E6%8B%A1%E5%BC%B5-to-s"><code>to_s</code></a></li>
<li><a href="#include-questionmark"><code>include?</code></a></li>
<li><a href="#overlaps-questionmark"><code>overlaps?</code></a></li>
</ul>
</li>
<li>
<a href="#date%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Date</code>の拡張</a>

<ul>
<li><a href="#date%E3%81%AE%E6%8B%A1%E5%BC%B5-%E8%A8%88%E7%AE%97">計算</a></li>
<li><a href="#%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">各種変換</a></li>
</ul>
</li>
<li>
<a href="#datetime%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>DateTime</code>の拡張</a>

<ul>
<li><a href="#datetime%E3%81%AE%E6%8B%A1%E5%BC%B5-%E8%A8%88%E7%AE%97">計算</a></li>
</ul>
</li>
<li>
<a href="#time%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Time</code>の拡張</a>

<ul>
<li><a href="#%E8%A8%88%E7%AE%97">計算</a></li>
<li><a href="#%E6%99%82%E9%96%93%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF">時間コンストラクタ</a></li>
</ul>
</li>
<li>
<a href="#file%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>File</code>の拡張</a>

<ul>
<li><a href="#atomic-write"><code>atomic_write</code></a></li>
</ul>
</li>
<li>
<a href="#marshal%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>Marshal</code>の拡張</a>

<ul>
<li><a href="#load"><code>load</code></a></li>
</ul>
</li>
<li><a href="#nameerror%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>NameError</code>の拡張</a></li>
<li><a href="#loaderror%E3%81%AE%E6%8B%A1%E5%BC%B5"><code>LoadError</code>の拡張</a></li>
</ol>

          </div>
</div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="コア拡張機能を読み込む方法"><a href="#%E3%82%B3%E3%82%A2%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80%E6%96%B9%E6%B3%95">1 コア拡張機能を読み込む方法</a></h3><h4 id="単体のactive-supportサポート"><a href="#%E5%8D%98%E4%BD%93%E3%81%AEactive-support%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88">1.1 単体のActive Supportサポート</a></h4><p>足跡をほぼ残さないようにするため、Active Supportはデフォルトでは何も読み込みません。Active Supportは細かく分割され、必要な拡張機能だけが読み込まれるようになっています。また、関連する拡張機能(場合によってはすべての拡張機能)も同時に読み込むのに便利なエントリポイントもあります。</p><p>従って、以下のようなrequire文を実行しただけでは</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support'

</pre>
</div>
<p>オブジェクトは<code>blank?</code>にすら応答してくれません。この定義がどのように読み込まれるかを見てみましょう。</p><h5 id="必要な定義だけを選ぶ"><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E5%AE%9A%E7%BE%A9%E3%81%A0%E3%81%91%E3%82%92%E9%81%B8%E3%81%B6">1.1.1 必要な定義だけを選ぶ</a></h5><p><code>blank?</code>メソッドを使えるようにする最も「軽量な」方法は、そのメソッドが定義されているファイルだけを選んで読み込むことです。</p><p>本ガイドでは、コア拡張機能として定義されているすべてのメソッドについて、その定義ファイルの置き場所も示してあります。たとえば<code>blank?</code>の場合、以下のようなメモを追加してあります。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/blank.rb</code>です。</p></div><p>つまり、以下のようにピンポイントでrequireを実行することができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support'
require 'active_support/core_ext/object/blank'

</pre>
</div>
<p>Active Supportの改訂は注意深く行われていますので、あるファイルを選んだ場合、本当に必要な依存ファイルだけが同時に読み込まれます(依存関係がある場合)。</p><h5 id="コア拡張機能をグループ化して読み込む"><a href="#%E3%82%B3%E3%82%A2%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%82%92%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96%E3%81%97%E3%81%A6%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80">1.1.2 コア拡張機能をグループ化して読み込む</a></h5><p>次の段階として、<code>Object</code>に対するすべての拡張機能を単に読み込んでみましょう。経験則として、<code>SomeClass</code>というクラスがあれば、<code>active_support/core_ext/some_class</code>というパスを指定することで一度に読み込めます。</p><p>従って、(<code>blank?</code>を含む)<code>Object</code>に対するすべての拡張機能を読み込む場合には以下のようにします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support'
require 'active_support/core_ext/object'

</pre>
</div>
<h5 id="すべてのコア拡張機能を読み込む"><a href="#%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%82%B3%E3%82%A2%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80">1.1.3 すべてのコア拡張機能を読み込む</a></h5><p>すべてのコア拡張機能を単に読み込んでおきたいのであれば、以下のようにrequireします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support'
require 'active_support/core_ext'

</pre>
</div>
<h5 id="すべてのactive-supportを読み込む"><a href="#%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AEactive-support%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80">1.1.4 すべてのActive Supportを読み込む</a></h5><p>最後に、利用可能なActive Supportをすべて読み込みたい場合は以下のようにします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support/all'

</pre>
</div>
<p>ただし、これを実行してもActive Support全体がメモリに読み込まれるわけではないことにご注意ください。一部は<code>autoload</code>として設定されており、実際に使うまで読み込まれません。</p><h4 id="ruby-on-railsアプリケーションでactive-supportを使用する"><a href="#ruby-on-rails%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A7active-support%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B">1.2 Ruby on RailsアプリケーションでActive Supportを使用する</a></h4><p>Ruby on Railsアプリケーションでは、基本的にすべてのActive Supportを読み込みます。例外は<code>config.active_support.bare</code>をtrueに設定した場合です。このオプションをtrueにすると、フレームワーク自体が必要とするまでアプリケーションは拡張機能を読み込みません。また、読み込まれる拡張機能の選択は、上で解説したように、あらゆる粒度で行われます。</p><h3 id="すべてのオブジェクトで使用できる拡張機能"><a href="#%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8B%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD">2 すべてのオブジェクトで使用できる拡張機能</a></h3><h4 id="blank-questionmarkとpresent-questionmark"><a href="#blank-questionmark%E3%81%A8present-questionmark">2.1 <code>blank?</code>と<code>present?</code></a></h4><p>Railsアプリケーションは以下の値を空白(blank)とみなします。</p>
<ul>
<li><p><code>nil</code>と<code>false</code></p></li>
<li><p>空白文字 (whitespace) だけで構成された文字列 (以下の注釈参照)</p></li>
<li><p>空欄の配列とハッシュ</p></li>
<li><p>その他、<code>empty?</code>メソッドに応答するオブジェクトはすべて空白として扱われます。</p></li>
</ul>
<div class="info"><p>文字列を判定する述語として、Unicode対応した文字クラスである<code>[:space:]</code>が使用されています。そのため、たとえばU+2029 (段落区切り文字)は空白文字と判断されます。</p></div><div class="warning"><p>数字については空白であるかどうかは判断されません。特に0および0.0は<strong>空白ではありません</strong>のでご注意ください。</p></div><p>たとえば、<code>ActionController::HttpAuthentication::Token::ControllerMethods</code>にある以下のメソッドでは<code>blank?</code>を使用してトークンが存在しているかどうかをチェックしています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def authenticate(controller, &amp;login_procedure)
  token, options = token_and_options(controller.request)
  unless token.blank?
    login_procedure.call(token, options)
  end
end

</pre>
</div>
<p><code>present?</code>メソッドは<code>!blank?</code>メソッドと同等です。以下の例は<code>ActionDispatch::Http::Cache::Response</code>から引用しました。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def set_conditional_cache_control!
  return if self["Cache-Control"].present?
  ...
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/blank.rb</code>です。</p></div><h4 id="presence"><a href="#presence">2.2 <code>presence</code></a></h4><p><code>presence</code>メソッドは、<code>present?</code>がtrueの場合は自身のレシーバを返し、falseの場合は<code>nil</code>を返します。このメソッドは以下のような定番の用法において便利です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
host = config[:host].presence || 'localhost'

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/blank.rb</code>です。</p></div><h4 id="duplicable-questionmark"><a href="#duplicable-questionmark">2.3 <code>duplicable?</code></a></h4><p>Rubyにおける基本的なオブジェクトの一部はsingletonオブジェクトです。たとえば、プログラムのライフサイクルが続く間、整数の1は常に同じインスタンスを参照します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.object_id                 # =&gt; 3
Math.cos(0).to_i.object_id  # =&gt; 3

</pre>
</div>
<p>従って、このようなオブジェクトは<code>dup</code>メソッドや<code>clone</code>メソッドで複製することはできません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
true.dup  # =&gt; TypeError: can't dup TrueClass

</pre>
</div>
<p>singletonでない数字にも、複製不可能なものがあります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
0.0.clone        # =&gt; allocator undefined for Float
(2**1024).clone  # =&gt; allocator undefined for Bignum

</pre>
</div>
<p>Active Supportには、オブジェクトがプログラム的に複製可能かどうかを問い合わせるための<code>duplicable?</code>メソッドがあります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"foo".duplicable? # =&gt; true
"".duplicable?    # =&gt; true
0.0.duplicable?  # =&gt; false
false.duplicable? # =&gt; false

</pre>
</div>
<p>デフォルトでは、<code>nil</code>、<code>false</code>、<code>true</code>、シンボル、数値、クラス、モジュール、メソッドオブジェクトを除くすべてのオブジェクトが<code>duplicable?</code> #=&gt; trueです。</p><div class="warning"><p>どんなクラスでも、<code>dup</code>メソッドと<code>clone</code>メソッドを除去することでこれらのメソッドを無効にしてしまうことができます。このとき、これらのメソッドが実行されると例外が発生します。このような状態では、どんなオブジェクトについてもそれが複製可能かどうかを確認するには<code>rescue</code>を使用する以外に方法はありません。<code>duplicable?</code>メソッドは、上のハードコードされたリストに依存しますが、その代わり<code>rescue</code>よりずっと高速です。実際のユースケースでハードコードされたリストで十分であることがわかっている場合には、<code>duplicable?</code>をお使いください。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/duplicable.rb</code>です。</p></div><h4 id="deep-dup"><a href="#deep-dup">2.4 <code>deep_dup</code></a></h4><p><code>deep_dup</code>メソッドは、与えられたオブジェクトの「ディープコピー」を返します。Rubyは通常の場合、他のオブジェクトを含むオブジェクトを<code>dup</code>しても、他のオブジェクトについては複製しません。このようなコピーは「浅いコピー (shallow copy)」と呼ばれます。たとえば、以下のように文字列を含む配列があるとします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
array     = ['string']
duplicate = array.dup

duplicate.push 'another-string'

# このオブジェクトは複製されたので、複製された方にだけ要素が追加された
array     # =&gt; ['string']
duplicate # =&gt; ['string', 'another-string']

duplicate.first.gsub!('string', 'foo')

# 1つ目の要素は複製されていないので、一方を変更するとどちらの配列も変更される
array     # =&gt; ['foo']
duplicate # =&gt; ['foo', 'another-string']

</pre>
</div>
<p>上で見たとおり、<code>Array</code>のインスタンスを複製して別のオブジェクトができたことにより、一方を変更しても他方は変更されないようになりました。ただし、配列は複製されましたが、配列の要素はそうではありません。<code>dup</code>メソッドはディープコピーを行わないので、配列の中にある文字列は複製後も同一オブジェクトのままです。</p><p>オブジェクトをディープコピーする必要がある場合は<code>deep_dup</code>をお使いください。例:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
array     = ['string']
duplicate = array.deep_dup

duplicate.first.gsub!('string', 'foo')

array     # =&gt; ['string']
duplicate # =&gt; ['foo']

</pre>
</div>
<p>オブジェクトが複製不可能な場合、<code>deep_dup</code>は単にそのオブジェクトを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
number = 1
duplicate = number.deep_dup
number.object_id == duplicate.object_id   # =&gt; true

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/deep_dup.rb</code>です。</p></div><h4 id="try"><a href="#try">2.5 <code>try</code></a></h4><p><code>nil</code>でない場合にのみオブジェクトのメソッドを呼び出したい場合、最も単純な方法は条件文を追加することですが、どこか冗長になってしまいます。そこで<code>try</code>メソッドを使うという手があります。<code>try</code>は<code>Object#send</code>と似ていますが、<code>nil</code>に送信された場合には<code>nil</code>を返す点が異なります。</p><p>例:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# tryメソッドを使用しない場合
unless @number.nil?
  @number.next
end

# tryメソッドを使用した場合
@number.try(:next)

</pre>
</div>
<p><code>ActiveRecord::ConnectionAdapters::AbstractAdapter</code>から別の例として以下をご紹介します。ここでは<code>@logger</code>が<code>nil</code>になることがあります。このコードでは<code>try</code>を使用したことで余分なチェックを行わずに済んでいます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def log_info(sql, name, ms)
  if @logger.try(:debug?)
    name = '%s (%.1fms)' % [name || 'SQL', ms]
    @logger.debug(format_log_entry(name, sql.squeeze(' ')))
  end
end

</pre>
</div>
<p><code>try</code>メソッドは引数の代りにブロックを与えて呼び出すこともできます。この場合オブジェクトが<code>nil</code>でない場合にのみブロックが実行されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
@person.try { |p| "#{p.first_name} #{p.last_name}" }

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/try.rb</code>です。</p></div><h4 id="class-eval-args-block"><a href="#class-eval-args-block">2.6 <code>class_eval(*args, &amp;block)</code></a></h4><p><code>class_eval</code>メソッドを使用することで、あらゆるオブジェクトのsingletonクラスのコンテキストでコードを評価することができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Proc
  def bind(object)
    block, time = self, Time.current
    object.class_eval do
      method_name = "__bind_#{time.to_i}_#{time.usec}"
      define_method(method_name, &amp;block)
      method = instance_method(method_name)
      remove_method(method_name)
      method
    end.bind(object)
  end
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/kernel/singleton_class.rb</code>です。</p></div><h4 id="acts-like-questionmark-duck"><a href="#acts-like-questionmark-duck">2.7 <code>acts_like?(duck)</code></a></h4><p><code>acts_like?</code>メソッドは、一部のクラスがその他のクラスと同様に振る舞うかどうかのチェックを、ある慣例に則って実行します。<code>String</code>クラスと同じインターフェイスを提供するクラスがあり、その中で以下のメソッドを定義しておくとします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def acts_like_string?
end

</pre>
</div>
<p>このメソッドは単なる目印であり、メソッドの本体と戻り値の間には関連はありません。これにより、クライアントコードで以下のようなダックタイピングチェックを行なうことができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
some_klass.acts_like?(:string)

</pre>
</div>
<p>Railsには<code>Date</code>クラスや<code>Time</code>クラスと同様に振る舞うクラスがいくつかあり、この手法を使用できます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/acts_like.rb</code>です。</p></div><h4 id="to-param"><a href="#to-param">2.8 <code>to_param</code></a></h4><p>Railsのあらゆるオブジェクトは<code>to_param</code>メソッドに応答します。これは、オブジェクトを値として表現するものを返すということです。返された値はクエリ文字列やURLの一部で使用できます。</p><p>デフォルトでは、<code>to_param</code>メソッドは単に<code>to_s</code>メソッドを呼び出します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
7.to_param # =&gt; "7"

</pre>
</div>
<p><code>to_param</code>によって返された値を <strong>エスケープしてはいけません</strong> 。脆弱性が生じます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Tom &amp; Jerry".to_param # =&gt; "Tom &amp; Jerry"

</pre>
</div>
<p>このメソッドは、Railsの多くのクラスで上書きされています。</p><p>たとえば、<code>nil</code>、<code>true</code>、<code>false</code>の場合は自分自身を返します。<code>Array#to_param</code>を実行すると、<code>to_param</code>が配列内の各要素に対して実行され、結果が"/"でjoinされます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[0, true, String].to_param # =&gt; "0/true/String"

</pre>
</div>
<p>特に、Railsのルーティングシステムはモデルに対して<code>to_param</code>メソッドを実行することで、<code>:id</code>プレースホルダの値を取得しています。<code>ActiveRecord::Base#to_param</code>はモデルの<code>id</code>を返しますが、このメソッドをモデル内で再定義することもできます。たとえば</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User
  def to_param
    "#{id}-#{name.parameterize}"
  end
end

</pre>
</div>
<p>以下の結果を得ます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
user_path(@user) # =&gt; "/users/357-john-smith"

</pre>
</div>
<div class="warning"><p>コントローラ側では、<code>to_param</code>メソッドがモデル側で再定義されている可能性があることに常に注意しておく必要があります。上のようなリクエストを受信した場合、<code>params[:id]</code>の値が"357-john-smith"になるからです。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/to_param.rb</code>です。</p></div><h4 id="to-query"><a href="#to-query">2.9 <code>to_query</code></a></h4><p>このメソッドは、エスケープされていない<code>key</code>を受け取ると、そのキーを<code>to_param</code>が返す値に対応させるクエリ文字列の一部を生成します。ただしハッシュは例外です(後述)。たとえば以下の場合、</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User
  def to_param
    "#{id}-#{name.parameterize}"
  end
end

</pre>
</div>
<p>以下の結果を得ます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
current_user.to_query('user') # =&gt; "user=357-john-smith"

</pre>
</div>
<p>このメソッドは、キーと値のいずれについても、必要な箇所をすべてエスケープします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
account.to_query('company[name]')
# =&gt; "company%5Bname%5D=Johnson+%26+Johnson"

</pre>
</div>
<p>従って、この結果はそのままクエリ文字列として使用できます。</p><p>配列に<code>to_query</code>メソッドを適用した場合、<code>to_query</code>を配列の各要素に適用して<code>_key_[]</code>をキーとして追加し、それらを"&amp;"で連結したものを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[3.4, -45.6].to_query('sample')
# =&gt; "sample%5B%5D=3.4&amp;sample%5B%5D=-45.6"

</pre>
</div>
<p>ハッシュも<code>to_query</code>に応答しますが、異なるシグネチャを使用します。メソッドに引数が渡されない場合、このメソッド呼び出しは、一連のキー/値ペアをソート済みの形で生成し、それぞれの値に対して<code>to_query(key)</code>を呼び出します。続いて結果を"&amp;"で連結します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{c: 3, b: 2, a: 1}.to_query # =&gt; "a=1&amp;b=2&amp;c=3"

</pre>
</div>
<p><code>Hash#to_query</code>メソッドは、それらのキーに対して名前空間をオプションで与えることもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{id: 89, name: "John Smith"}.to_query('user')
# =&gt; "user%5Bid%5D=89&amp;user%5Bname%5D=John+Smith"

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/to_query.rb</code>です。</p></div><h4 id="with-options"><a href="#with-options">2.10 <code>with_options</code></a></h4><p><code>with_options</code>メソッドは、連続した複数のメソッド呼び出しに対して共通して与えられるオプションを解釈するための手段を提供します。</p><p>デフォルトのオプションがハッシュで与えられると、<code>with_options</code>はブロックに対するプロキシオブジェクトを生成します。そのブロック内では、プロキシに対して呼び出されたメソッドにオプションを追加したうえで、そのメソッドをレシーバに転送します。たとえば、以下のように同じオプションを繰り返さないで済むようになります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Account &lt; ActiveRecord::Base
  has_many :customers, dependent: :destroy
  has_many :products,  dependent: :destroy
  has_many :invoices,  dependent: :destroy
  has_many :expenses,  dependent: :destroy
end

</pre>
</div>
<p>上は以下のようにできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Account &lt; ActiveRecord::Base
  with_options dependent: :destroy do |assoc|
    assoc.has_many :customers
    assoc.has_many :products
    assoc.has_many :invoices
    assoc.has_many :expenses
  end
end

</pre>
</div>
<p>この手法を使用することで、たとえばニュースレターの読者を言語ごとに <em>グループ化</em> することができます。読者が話す言語に応じて異なるニュースレターを送信したいとします。メイル送信用のコードのどこかで、以下のような感じでロケール依存ビットをグループ化することができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
I18n.with_options locale: user.locale, scope: "newsletter" do |i18n|
  subject i18n.t :subject
  body    i18n.t :body, user_name: user.name
end

</pre>
</div>
<div class="info"><p><code>with_options</code>はメソッドをレシーバに転送しているので、呼び出しをネストすることもできます。各ネスティングレベルでは、自身の呼び出しに、継承したデフォルト呼び出しをマージします。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/with_options.rb</code>です。</p></div><h4 id="json-support"><a href="#json-support">2.11 JSON support</a></h4><p>Active Supportが提供する<code>to_json</code>メソッドの実装は、通常<code>json</code> gemがRubyオブジェクトに対して提供している<code>to_json</code>よりも優れています。その理由は、<code>Hash</code>や<code>OrderedHash</code>、<code>Process::Status</code>などのクラスでは、正しいJSON表現を提供するために特別な処理が必要になるためです。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/json.rb</code>です。</p></div><h4 id="インスタンス変数"><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E5%A4%89%E6%95%B0">2.12 インスタンス変数</a></h4><p>Active Supportは、インスタンス変数に簡単にアクセスするためのメソッドを多数提供しています。</p><h5 id="instance-values"><a href="#instance-values">2.12.1 <code>instance_values</code></a></h5><p><code>instance_values</code>メソッドはハッシュを返します。インスタンス変数名から"@"を除いたものがハッシュのキーに、インスタンス変数の値がハッシュの値にマップされます。キーは文字列です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class C
  def initialize(x, y)
    @x, @y = x, y
  end
end

C.new(0, 1).instance_values # =&gt; {"x" =&gt; 0, "y" =&gt; 1}

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/instance_variables.rb</code>です。</p></div><h5 id="instance-variable-names"><a href="#instance-variable-names">2.12.2 <code>instance_variable_names</code></a></h5><p><code>instance_variable_names</code>メソッドは配列を返します。配列のインスタンス名には"@"記号が含まれます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class C
  def initialize(x, y)
    @x, @y = x, y
  end
end

C.new(0, 1).instance_variable_names # =&gt; ["@x", "@y"]

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/instance_variables.rb</code>です。</p></div><h4 id="警告・例外の抑制"><a href="#%E8%AD%A6%E5%91%8A%E3%83%BB%E4%BE%8B%E5%A4%96%E3%81%AE%E6%8A%91%E5%88%B6">2.13 警告・例外の抑制</a></h4><p><code>silence_warnings</code>メソッドと<code>enable_warnings</code>メソッドは、ブロックが継続する間<code>$VERBOSE</code>の値を変更し、その後リセットします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
silence_warnings { Object.const_set "RAILS_DEFAULT_LOGGER", logger }

</pre>
</div>
<p><code>suppress</code>メソッドを使用すると例外の発生を止めることもできます。このメソッドは、例外クラスを表す任意の数値を受け取ります。<code>suppress</code>は、あるブロックの実行時に例外が発生し、その例外が(<code>kind_of?</code>による判定で)いずれかの引数に一致する場合、それをキャプチャして例外を発生せずに戻ります。一致しない場合、例外はキャプチャされません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# ユーザーがロックされていればインクリメントは失われるが、重要ではない
suppress(ActiveRecord::StaleObjectError) do
  current_user.increment! :visits
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/kernel/reporting.rb</code>です。</p></div><h4 id="in-questionmark"><a href="#in-questionmark">2.14 <code>in?</code></a></h4><p>述語<code>in?</code>は、あるオブジェクトが他のオブジェクトに含まれているかどうかをテストします。渡された引数が<code>include?</code>に応答しない場合は<code>ArgumentError</code>例外が発生します。</p><p><code>in?</code>の例を示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.in?([1,2])        # =&gt; true
"lo".in?("hello")   # =&gt; true
25.in?(30..50)      # =&gt; false
1.in?(1)            # =&gt; ArgumentError

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/inclusion.rb</code>です。</p></div><h3 id="moduleの拡張"><a href="#module%E3%81%AE%E6%8B%A1%E5%BC%B5">3 <code>Module</code>の拡張</a></h3><h4 id="alias-method-chain"><a href="#alias-method-chain">3.1 <code>alias_method_chain</code></a></h4><p><strong>このメソッドは非推奨になりました。Module#prependをお使いください。</strong></p><p>拡張されていない純粋なRubyを使用して、メソッドを他のメソッドで包み込む(wrap)ことができます。これは <em>エイリアスチェーン (alias chaining)</em> と呼ばれています。</p><p>たとえば、機能テストのときにはパラメータが (実際のリクエストのときと同様に) 文字列であって欲しいとします。しかし必要なときには整数など他の型の値を持つこともできるようにしておきたいとします。これを実現するには、<code>ActionController::TestCase#process</code>を以下のように<code>test/test_helper.rb</code>でラップします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActionController::TestCase.class_eval do
  # 元のプロセスメソッドへの参照を保存
  alias_method :original_process, :process

  # 今度はプロセスを再定義してoriginal_processに委譲する
  def process(action, params=nil, session=nil, flash=nil, http_method='GET')
    params = Hash[*params.map {|k, v| [k, v.to_s]}.flatten]
    original_process(action, params, session, flash, http_method)
  end
end

</pre>
</div>
<p>これは、<code>get</code>、<code>post</code>メソッドなどが作業を委譲するときに使われる手法です。</p><p>この手法には、<code>:original_process</code>が取得される可能性があるというリスクがあります。エイリアスチェーンが行われる対象を特徴付けるラベルが選ばれるときにそのような衝突を回避するには、次のようにします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActionController::TestCase.class_eval do
  def process_with_stringified_params(...)
    params = Hash[*params.map {|k, v| [k, v.to_s]}.flatten]
    process_without_stringified_params(action, params, session, flash, http_method)
  end
  alias_method :process_without_stringified_params, :process
  alias_method :process, :process_with_stringified_params
end

</pre>
</div>
<p><code>alias_method_chain</code>メソッドを使用すると、上のようなパターンを簡単に行えます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActionController::TestCase.class_eval do
  def process_with_stringified_params(...)
    params = Hash[*params.map {|k, v| [k, v.to_s]}.flatten]
    process_without_stringified_params(action, params, session, flash, http_method)
  end
  alias_method_chain :process, :stringified_params
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/aliasing.rb</code>です。</p></div><h4 id="属性"><a href="#%E5%B1%9E%E6%80%A7">3.2 属性</a></h4><h5 id="alias-attribute"><a href="#alias-attribute">3.2.1 <code>alias_attribute</code></a></h5><p>モデルの属性には、リーダー (reader)、ライター (writer)、述語 (predicate) があります。上に対応する3つのメソッドを持つ、モデルの属性の別名 (alias) を一度に作成することができます。他の別名作成メソッドと同様、1つ目の引数には新しい名前、2つ目の引数には元の名前を指定します (変数に代入するときと同じ順序、と覚えておく手もあります)。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  # emailカラムを"login"という名前でも参照したい
  # そうすることで認証のコードがわかりやすくなる
  alias_attribute :login, :email
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/aliasing.rb</code>です。</p></div><h5 id="内部属性"><a href="#%E5%86%85%E9%83%A8%E5%B1%9E%E6%80%A7">3.2.2 内部属性</a></h5><p>あるクラスで属性を定義すると、後にそのクラスのサブクラスが作成されるときに名前が衝突するリスクが生じます。これはライブラリにおいては特に重要な問題です。</p><p>Active Supportでは、<code>attr_internal_reader</code>、<code>attr_internal_writer</code>、<code>attr_internal_accessor</code>というマクロが定義されています。これらのマクロは、Rubyにビルトインされている<code>attr_*</code>と同様に振る舞いますが、内部のインスタンス変数の名前が衝突しにくいように配慮される点が異なります。</p><p><code>attr_internal</code>マクロは<code>attr_internal_accessor</code>と同義です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# ライブラリ
class ThirdPartyLibrary::Crawler
  attr_internal :log_level
end

# クライアントコード
class MyCrawler &lt; ThirdPartyLibrary::Crawler
  attr_accessor :log_level
end

</pre>
</div>
<p>先の例では、<code>:log_level</code>はライブラリのパブリックインターフェイスに属さず、開発用途にのみ使用されます。クライアント側のコードでは衝突の可能性について考慮せずに独自に<code>:log_level</code>をサブクラスで定義しています。ライブラリ側で<code>attr_internal</code>を使用しているおかげで衝突が生じずに済んでいます。</p><p>このとき、内部インスタンス変数の名前にはデフォルトで冒頭にアンダースコアが追加されます。上の例であれば<code>@_log_level</code>となります。この動作は<code>Module.attr_internal_naming_format</code>を使用して変更することもできます。<code>sprintf</code>と同様のフォーマット文字列を与え、冒頭に<code>@</code>を置き、それ以外の名前を置きたい場所に<code>%s</code>を置きます。デフォルト値は<code>"@_%s"</code>です。</p><p>Railsではこの内部属性を他の場所でも若干使用しています。たとえばビューでは以下のように使用しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ActionView
  class Base
    attr_internal :captures
    attr_internal :request, :layout
    attr_internal :controller, :template
  end
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/attr_internal.rb</code>です。</p></div><h5 id="モジュール属性"><a href="#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E5%B1%9E%E6%80%A7">3.2.3 モジュール属性</a></h5><p><code>mattr_reader</code>、<code>mattr_writer</code>、<code>mattr_accessor</code>という3つのマクロは、クラス用に定義される<code>cattr_*</code>マクロと同じです。実際、<code>cattr_*</code>マクロは単なる<code>mattr_*</code>マクロの別名です。<a href="#class%E5%B1%9E%E6%80%A7">クラス属性</a>も参照してください。</p><p>たとえば、これらのマクロは以下のDependenciesモジュールで使用されています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ActiveSupport
  module Dependencies
    mattr_accessor :warnings_on_first_load
    mattr_accessor :history
    mattr_accessor :loaded
    mattr_accessor :mechanism
    mattr_accessor :load_paths
    mattr_accessor :load_once_paths
    mattr_accessor :autoloaded_constants
    mattr_accessor :explicitly_unloadable_constants
    mattr_accessor :logger
    mattr_accessor :log_activity
    mattr_accessor :constant_watch_stack
    mattr_accessor :constant_watch_stack_mutex
  end
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/attribute_accessors.rb</code>です。</p></div><h4 id="親"><a href="#%E8%A6%AA">3.3 親</a></h4><h5 id="parent"><a href="#parent">3.3.1 <code>parent</code></a></h5><p><code>parent</code>メソッドは、名前がネストしたモジュールに対して実行でき、対応する定数を持つモジュールを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module X
  module Y
    module Z
    end
  end
end
M = X::Y::Z

X::Y::Z.parent # =&gt; X::Y
M.parent       # =&gt; X::Y

</pre>
</div>
<p>モジュールが無名またはトップレベルの場合、<code>parent</code>は<code>Object</code>を返します。</p><div class="warning"><p><code>parent_name</code>は上の場合でも<code>nil</code>を返します。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/introspection.rb</code>です。</p></div><h5 id="parent-name"><a href="#parent-name">3.3.2 <code>parent_name</code></a></h5><p><code>parent_name</code>メソッドは、名前がネストしたモジュールに対して実行でき、対応する定数を持つモジュールを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module X
  module Y
    module Z
    end
  end
end
M = X::Y::Z

X::Y::Z.parent_name # =&gt; "X::Y"
M.parent_name       # =&gt; "X::Y"

</pre>
</div>
<p>モジュールが無名またはトップレベルの場合、<code>parent_name</code>は<code>nil</code>を返します。</p><div class="warning"><p><code>parent</code>は上の場合でも<code>Object</code>を返します。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/introspection.rb</code>。</p></div><h5 id="parents"><a href="#parents">3.3.3 <code>parents</code></a></h5><p><code>parents</code>メソッドは、レシーバに対して<code>parent</code>を呼び出し、<code>Object</code>に到着するまでパスをさかのぼります。連鎖したモジュールは、階層の下から上の順に配列として返されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module X
  module Y
    module Z
    end
  end
end
M = X::Y::Z

X::Y::Z.parents # =&gt; [X::Y, X, Object]
M.parents       # =&gt; [X::Y, X, Object]

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/introspection.rb</code>です。</p></div><h4 id="定数"><a href="#%E5%AE%9A%E6%95%B0">3.4 定数</a></h4><p><code>local_constants</code>メソッドは、レシーバモジュールで定義された定数名を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module X
  X1 = 1
  X2 = 2
  module Y
    Y1 = :y1
    X1 = :overrides_X1_above
  end
end

X.local_constants    # =&gt; [:X1, :X2, :Y]
X::Y.local_constants # =&gt; [:Y1, :X1]

</pre>
</div>
<p>定数名はシンボルとして返されます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/introspection.rb</code>です。</p></div><h5 id="正規の定数名"><a href="#%E6%AD%A3%E8%A6%8F%E3%81%AE%E5%AE%9A%E6%95%B0%E5%90%8D">3.4.1 正規の定数名</a></h5><p>標準のメソッド<code>const_defined?</code>、<code>const_get</code>、<code>const_set</code>では、(修飾されていない)素の定数名を使用します。Active SupportではこのAPIを拡張し、よりフルパスに近い(qualified)定数名を渡せるようにしています。</p><p>新しいメソッドは<code>qualified_const_defined?</code>、<code>qualified_const_get</code>、<code>qualified_const_set</code>です。これらのメソッドに渡す引数は、レシーバからの相対的な修飾済み定数名であることが前提となります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Object.qualified_const_defined?("Math::PI")       # =&gt; true
Object.qualified_const_get("Math::PI")            # =&gt; 3.141592653589793
Object.qualified_const_set("Math::Phi", 1.618034) # =&gt; 1.618034

</pre>
</div>
<p>修飾されていない、素の定数名も使用できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Math.qualified_const_get("E") # =&gt; 2.718281828459045

</pre>
</div>
<p>これらのメソッドは、ビルトイン版のメソッドと類似しています。特に、<code>qualified_constant_defined?</code>メソッドは2つ目の引数として、述語を先祖に向って遡って探すかどうかというフラグをオプションで指定できます。
このフラグは、与えられたすべての定数について、メソッドでパスを下る時に適用されます。</p><p>以下の例で考察してみましょう。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
  X = 1
end

module N
  class C
    include M
  end
end

</pre>
</div>
<p><code>qualified_const_defined?</code>は以下のように動作します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
N.qualified_const_defined?("C::X", false) # =&gt; false
N.qualified_const_defined?("C::X", true)  # =&gt; true
N.qualified_const_defined?("C::X")        # =&gt; true

</pre>
</div>
<p>最後の例でわかるように、<code>const_defined?</code>メソッドと同様に2番目の引数はデフォルトでtrueになります。</p><p>ビルトインメソッドと一貫させるため、相対パス以外は利用できません。
<code>::Math::PI</code>のような絶対定数名を指定すると<code>NameError</code>が発生します。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/qualified_const.rb</code>です。</p></div><h4 id="到達可能"><a href="#%E5%88%B0%E9%81%94%E5%8F%AF%E8%83%BD">3.5 到達可能</a></h4><p>名前を持つモジュールは、対応する定数に保存されている場合に到達可能 (reachable) となります。これは、定数を経由してモジュールオブジェクトに到達できるという意味です。</p><p>これは通常の動作です。"M"というモジュールがあるとすると、<code>M</code>という定数が存在し、そこにモジュールが保持されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end

M.reachable? # =&gt; true

</pre>
</div>
<p>しかし、定数とモジュールが実質上切り離されると、そのモジュールオブジェクトは到着不能 (unreachable) になります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end

orphan = Object.send(:remove_const, :M)

# このモジュールは孤立しているが、まだ無名ではない
orphan.name # =&gt; "M"

# 定数Mは既に存在してないので、定数Mを経由して到達できない
orphan.reachable? # =&gt; false

# "M"という名前のモジュールを再度定義する
module M
end

# 定数Mが再度存在し、モジュールオブジェクト"M"を保持しているが
# 元と異なる新しいインスタンスである
orphan.reachable? # =&gt; false

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/reachable.rb</code>です。</p></div><h4 id="無名モジュール"><a href="#%E7%84%A1%E5%90%8D%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB">3.6 無名モジュール</a></h4><p>モジュールは名前を持つことも、無名でいることもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end
M.name # =&gt; "M"

N = Module.new
N.name # =&gt; "N"

Module.new.name # =&gt; nil

</pre>
</div>
<p>述語<code>anonymous?</code>を使用して、モジュールに名前があるかどうかをチェックできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end
M.anonymous? # =&gt; false

Module.new.anonymous? # =&gt; true

</pre>
</div>
<p>到達不能 (unreachable) であっても、必ずしも無名 (anonymous) になるとは限りません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end

m = Object.send(:remove_const, :M)

m.reachable? # =&gt; false
m.anonymous? # =&gt; false

</pre>
</div>
<p>逆に無名モジュールは、定義上必ず到達不能になります。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/anonymous.rb</code>です。</p></div><h4 id="メソッド委譲"><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%A7%94%E8%AD%B2">3.7 メソッド委譲</a></h4><p><code>delegate</code>マクロを使用すると、メソッドを簡単に委譲できます。</p><p>あるアプリケーションの<code>User</code>モデルにログイン情報があり、それに関連する名前などの情報は<code>Profile</code>モデルにあるとします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  has_one :profile
end

</pre>
</div>
<p>この構成では、<code>user.profile.name</code>のようにプロファイル越しにユーザー名を取得することになります。これらの属性に直接アクセスできたらもっと便利になることでしょう。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  has_one :profile

  def name
    profile.name
  end
end

</pre>
</div>
<p><code>delegate</code>を使用すればできるようになります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  has_one :profile

  delegate :name, to: :profile
end

</pre>
</div>
<p>この方法なら記述が短くて済み、意味もはっきりします。</p><p>使用するメソッドは対象クラス内でpublicである必要があります。</p><p><code>delegate</code>マクロには複数のメソッドを指定できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
delegate :name, :age, :address, :twitter, to: :profile

</pre>
</div>
<p><code>:to</code>オプションが文字列に変換されると、メソッドの委譲先となるオブジェクトに評価される式になります。通常は文字列またはシンボルになります。そのような式は、レシーバのコンテキストで評価されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Rails定数を委譲する
delegate :logger, to: :Rails

# レシーバのクラスに委譲する
delegate :table_name, to: :class

</pre>
</div>
<div class="warning"><p><code>:prefix</code>オプションが<code>true</code>の場合、一般性が低下します (後述)。</p></div><p>委譲時に<code>NoMethodError</code>が発生して対象が<code>nil</code>の場合、例外が発生します。<code>:allow_nil</code>オプションを使用すると、例外の代りに<code>nil</code>を返すようにすることができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
delegate :name, to: :profile, allow_nil: true

</pre>
</div>
<p><code>:allow_nil</code>を指定すると、ユーザーのプロファイルがない場合に<code>user.name</code>呼び出しは<code>nil</code>を返します。</p><p><code>:prefix</code>オプションをtrueにすると、生成されたメソッドの名前にプレフィックスを追加します。これは、たとえばよりよい名前にしたい場合に便利です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
delegate :street, to: :address, prefix: true

</pre>
</div>
<p>上の例では、<code>street</code>ではなく<code>address_street</code>が生成されます。</p><div class="warning"><p>この場合、生成されるメソッドの名前では、対象となるオブジェクト名とメソッド名が使用されます。<code>:to</code>オプションで指定するのはメソッド名でなければなりません。</p></div><p>プレフィックスをカスタマイズすることもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
delegate :size, to: :attachment, prefix: :avatar

</pre>
</div>
<p>上の例では、マクロによって<code>size</code>の代わりに<code>avatar_size</code>が生成されます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/delegation.rb</code>です。</p></div><h4 id="メソッドの再定義"><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%86%8D%E5%AE%9A%E7%BE%A9">3.8 メソッドの再定義</a></h4><p><code>define_method</code>を使用してメソッドを再定義する必要があるが、その名前が既にあるかどうかがわからないとことがあります。有効な名前が既にあれば警告が表示されます。警告が表示されても大したことはありませんが、邪魔に思えることもあります。</p><p><code>redefine_method</code>メソッドを使用すれば、必要に応じて既存のメソッドが削除されるので、このような警告表示を抑制できます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/remove_method.rb</code>です。</p></div><h3 id="classの拡張"><a href="#class%E3%81%AE%E6%8B%A1%E5%BC%B5">4 <code>Class</code>の拡張</a></h3><h4 id="class属性"><a href="#class%E5%B1%9E%E6%80%A7">4.1 Class属性</a></h4><h5 id="class-attribute"><a href="#class-attribute">4.1.1 <code>class_attribute</code></a></h5><p><code>class_attribute</code>メソッドは、1つ以上の継承可能なクラスの属性を宣言します。そのクラス属性は、その下のどの階層でも上書き可能です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class A
  class_attribute :x
end

class B &lt; A; end

class C &lt; B; end

A.x = :a
B.x # =&gt; :a
C.x # =&gt; :a

B.x = :b
A.x # =&gt; :a
C.x # =&gt; :b

C.x = :c
A.x # =&gt; :a
B.x # =&gt; :b

</pre>
</div>
<p>たとえば、<code>ActionMailer::Base</code>に以下の定義があるとします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class_attribute :default_params
self.default_params = {
  mime_version: "1.0",
  charset: "UTF-8",
  content_type: "text/plain",
  parts_order: [ "text/plain", "text/enriched", "text/html" ]
}.freeze

</pre>
</div>
<p>これらの属性はインスタンスのレベルでアクセスまたはオーバーライドできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
A.x = 1

a1 = A.new
a2 = A.new
a2.x = 2

a1.x # =&gt; 1 (Aが使われる)
a2.x # =&gt; 2 (a2でオーバーライドされる)

</pre>
</div>
<p><code>:instance_writer</code>を<code>false</code>に設定すれば、writerインスタンスメソッドは生成されません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ActiveRecord
  class Base
    class_attribute :table_name_prefix, instance_writer: false
    self.table_name_prefix = ""
  end
end

</pre>
</div>
<p>上のオプションは、モデルの属性設定時にマスアサインメントを防止するのに便利です。</p><p><code>:instance_reader</code>を<code>false</code>に設定すれば、readerインスタンスメソッドは生成されません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class A
  class_attribute :x, instance_reader: false
end

A.new.x = 1 # NoMethodError

</pre>
</div>
<p>利便性のために、<code>class_attribute</code>は、インスタンスのreaderが返すものを「二重否定」するインスタンス述語も定義されます。上の例の場合、<code>x?</code>となります。</p><p><code>:instance_reader</code>が<code>false</code>の場合、インスタンス述語はreaderメソッドと同様に<code>NoMethodError</code>を返します。</p><p>インスタンス述語が不要な場合、<code>instance_predicate: false</code>を指定すれば定義されなくなります。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/class/attribute.rb</code>です。</p></div><h5 id="cattr-reader、cattr-writer、cattr-accessor"><a href="#cattr-reader%E3%80%81cattr-writer%E3%80%81cattr-accessor">4.1.2 <code>cattr_reader</code>、<code>cattr_writer</code>、<code>cattr_accessor</code></a></h5><p><code>cattr_reader</code>、<code>cattr_writer</code>、<code>cattr_accessor</code>マクロは、<code>attr_*</code>と似ていますが、クラス用である点が異なります。これらのメソッドは、クラス変数を<code>nil</code>に設定し (クラス変数が既にある場合を除く)、対応するクラスメソッドを生成してアクセスできるようにします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class MysqlAdapter &lt; AbstractAdapter
  # @@emulate_booleansにアクセスできるクラスメソッドを生成する
  cattr_accessor :emulate_booleans
  self.emulate_booleans = true
end

</pre>
</div>
<p>利便性のため、このときインスタンスメソッドも生成されますが、これらは実際にはクラス属性の単なるプロキシです。従って、インスタンスからクラス属性を変更することはできますが、<code>class_attribute</code>で行われるように上書きすることはできません(上記参照)。たとえば以下の場合、</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ActionView
  class Base
    cattr_accessor :field_error_proc
    @@field_error_proc = Proc.new{ ... }
  end
end

</pre>
</div>
<p>ビューで<code>field_error_proc</code>にアクセスできます。</p><p>同様に、<code>cattr_*</code>にブロックを渡して属性にデフォルト値を設定することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class MysqlAdapter &lt; AbstractAdapter
  # @@emulate_booleansにアクセスしてデフォルト値をtrueにするクラスメソッドを生成
  cattr_accessor(:emulate_booleans) { true }
end

</pre>
</div>
<p><code>:instance_reader</code>オプションを<code>false</code>に設定することで、readerインスタンスメソッドが生成されないようにできます。同様に、<code>:instance_writer</code>オプションを<code>false</code>に設定することで、writerインスタンスメソッドが生成されないようにできます。<code>:instance_accessor</code>オプションを<code>false</code>に設定すれば、どちらのインスタンスメソッドも生成されません。いずれの場合も、指定できる値は<code>false</code>のみです。'nil'など他のfalse値は指定できません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module A
  class B
    # first_nameインスタンスreaderは生成されない
    cattr_accessor :first_name, instance_reader: false
    # last_name= インスタンスwriterは生成されない
    cattr_accessor :last_name, instance_writer: false
    # surnameインスタンスreaderもsurname= インスタンスwriterも生成されない
    cattr_accessor :surname, instance_accessor: false
  end
end

</pre>
</div>
<p><code>:instance_accessor</code>を<code>false</code>に設定すると、モデルの属性設定時にマスアサインメントを防止するのに便利です。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/module/attribute_accessors.rb</code>です。</p></div><h4 id="サブクラスと子孫"><a href="#%E3%82%B5%E3%83%96%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8%E5%AD%90%E5%AD%AB">4.2 サブクラスと子孫</a></h4><h5 id="subclasses"><a href="#subclasses">4.2.1 <code>subclasses</code></a></h5><p><code>subclasses</code>メソッドはレシーバのサブクラスを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class C; end
C.subclasses # =&gt; []

class B &lt; C; end
C.subclasses # =&gt; [B]

class A &lt; B; end
C.subclasses # =&gt; [B]

class D &lt; C; end
C.subclasses # =&gt; [B, D]

</pre>
</div>
<p>返されるクラスの順序は一定ではありません。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/class/subclasses.rb</code>です。</p></div><h5 id="descendants"><a href="#descendants">4.2.2 <code>descendants</code></a></h5><p><code>descendants</code>メソッドは、そのレシーバより下位にあるすべてのクラスを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class C; end
C.descendants # =&gt; []

class B &lt; C; end
C.descendants # =&gt; [B]

class A &lt; B; end
C.descendants # =&gt; [B, A]

class D &lt; C; end
C.descendants # =&gt; [B, A, D]

</pre>
</div>
<p>返されるクラスの順序は一定ではありません。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/class/subclasses.rb</code>です。</p></div><h3 id="stringの拡張"><a href="#string%E3%81%AE%E6%8B%A1%E5%BC%B5">5 <code>String</code>の拡張</a></h3><h4 id="安全な出力"><a href="#%E5%AE%89%E5%85%A8%E3%81%AA%E5%87%BA%E5%8A%9B">5.1 安全な出力</a></h4><h5 id="開発の動機"><a href="#%E9%96%8B%E7%99%BA%E3%81%AE%E5%8B%95%E6%A9%9F">5.1.1 開発の動機</a></h5><p>HTMLテンプレートにデータを挿入する方法は、きわめて慎重に設計する必要があります。たとえば、<code>@review.title</code>を何の工夫もなくそのままHTMLに式展開するようなことは絶対にすべきではありません。もしこのレビューのタイトルが仮に"Flanagan &amp; Matz rules!"だとしたら、出力はwell-formedになりません。well-formedにするには、"&amp;amp;"のようにエスケープしなければなりません。さらに、ユーザーがレビューのタイトルに細工をして、悪意のあるHTMLをタイトルに含めれば、巨大なセキュリティホールになることすらあります。このリスクの詳細については、<a href="security.html#%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0-xss">セキュリティガイド</a>のクロスサイトスクリプティングの節を参照してください。</p><h5 id="安全な文字列"><a href="#%E5%AE%89%E5%85%A8%E3%81%AA%E6%96%87%E5%AD%97%E5%88%97">5.1.2 安全な文字列</a></h5><p>Active Supportには「(html的に) 安全な文字列」という概念があります。安全な文字列とは、HTMLにそのまま挿入しても問題がないというマークが付けられている文字列です。マーキングさえされていれば、「実際にエスケープされているかどうかにかかわらず」その文字列は信頼されます。</p><p>文字列はデフォルトでは <em>unsafe</em> とマークされます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"".html_safe? # =&gt; false

</pre>
</div>
<p>与えられた文字列に<code>html_safe</code>メソッドを適用することで、安全な文字列を得ることができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
s = "".html_safe
s.html_safe? # =&gt; true

</pre>
</div>
<p>ここで注意しなければならないのは、<code>html_safe</code>メソッドそれ自体は何らエスケープを行なっていないということです。安全であるとマーキングしているに過ぎません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
s = "&lt;script&gt;...&lt;/script&gt;".html_safe
s.html_safe? # =&gt; true
s            # =&gt; "&lt;script&gt;...&lt;/script&gt;"

</pre>
</div>
<p>従って、特定の文字列に対して<code>html_safe</code>メソッドを呼び出す際には、その文字列が本当に安全であることを確認する義務があります。</p><p>安全であると宣言された文字列に対し、安全でない文字列を<code>concat</code>/<code>&lt;&lt;</code>または<code>+</code>を使用して破壊的に追加すると、結果は安全な文字列になります。安全でない引数は追加時にエスケープされます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"".html_safe + "&lt;" # =&gt; "&amp;lt;"

</pre>
</div>
<p>安全な引数であれば、(エスケープなしで)直接追加されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"".html_safe + "&lt;".html_safe # =&gt; "&lt;"

</pre>
</div>
<p>基本的にこれらのメソッドは、通常のビューでは使用しないでください。現在のRailsのビューでは、安全でない値は自動的にエスケープされるためです。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= @review.title %&gt; &lt;%# 必要に応じてエスケープされるので問題なし %&gt;

</pre>
</div>
<p>何らかの理由で、エスケープされていない文字列を挿入したい場合は、<code>html_safe</code>を呼ぶのではなく、<code>raw</code>ヘルパーを使用するようにしてください。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= raw @cms.current_template %&gt; &lt;%# @cms.current_templateをそのまま挿入 %&gt;

</pre>
</div>
<p>あるいは、<code>raw</code>と同等の<code>&lt;%==</code>を使用します。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%== @cms.current_template %&gt; &lt;%# @cms.current_templateをそのまま挿入 %&gt;

</pre>
</div>
<p><code>raw</code>ヘルパーは、内部で<code>html_safe</code>を呼び出します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def raw(stringish)
  stringish.to_s.html_safe
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/output_safety.rb</code>です。</p></div><h5 id="安全な出力-各種変換"><a href="#%E5%AE%89%E5%85%A8%E3%81%AA%E5%87%BA%E5%8A%9B-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">5.1.3 各種変換</a></h5><p>経験上、上で説明したような連結 (concatenation) 操作を除き、どんなメソッドでも潜在的には文字列を安全でないものに変換してしまう可能性があることに常に注意を払う必要があります。そのようなメソッドには<code>downcase</code>、<code>gsub</code>、<code>strip</code>、<code>chomp</code>、<code>underscore</code>などがあります。</p><p><code>gsub!</code>のような破壊的な変換を行なうメソッドを使用すると、レシーバ自体が安全でなくなります。</p><div class="info"><p>こうしたメソッドを実行すると、実際に変換が行われたかどうかにかかわらず、安全を表すビットは常にオフになります。</p></div><h5 id="変換と強制"><a href="#%E5%A4%89%E6%8F%9B%E3%81%A8%E5%BC%B7%E5%88%B6">5.1.4 変換と強制</a></h5><p>安全な文字列に対して<code>to_s</code>を実行した場合は、安全な文字列が返されます。しかし、<code>to_str</code>による強制的な変換を実行した場合には安全でない文字列が返されます。</p><h5 id="コピー"><a href="#%E3%82%B3%E3%83%94%E3%83%BC">5.1.5 コピー</a></h5><p>安全な文字列に対して<code>dup</code>または<code>clone</code>を実行した場合は、安全な文字列が生成されます。</p><h4 id="remove"><a href="#remove">5.2 <code>remove</code></a></h4><p><code>remove</code>メソッドを実行すると、すべての該当パターンが削除されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Hello World".remove(/Hello /) # =&gt; "World"

</pre>
</div>
<p>このメソッドには破壊的なバージョンの<code>String#remove!</code>もあります。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/filters.rb</code>です。</p></div><h4 id="squish"><a href="#squish">5.3 <code>squish</code></a></h4><p><code>squish</code>メソッドは、冒頭と末尾のホワイトスペースを除去し、連続したホワイトスペースを1つに減らします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
" \n  foo\n\r \t bar \n".squish # =&gt; "foo bar"

</pre>
</div>
<p>このメソッドには破壊的なバージョンの<code>String#squish!</code>もあります。</p><p>このメソッドでは、ASCIIとUnicodeのホワイトスペースを扱えます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/filters.rb</code>です。</p></div><h4 id="truncate"><a href="#truncate">5.4 <code>truncate</code></a></h4><p><code>truncate</code>メソッドは、指定された<code>length</code>にまで長さを切り詰めたレシーバのコピーを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate(20)
# =&gt; "Oh dear! Oh dear!..."

</pre>
</div>
<p><code>:omission</code>オプションを指定することで、省略文字 (…) をカスタマイズすることもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate(20, omission: '&amp;hellip;')
# =&gt; "Oh dear! Oh &amp;hellip;"

</pre>
</div>
<p>文字列の切り詰めでは、省略文字列の長さも加味されることに特にご注意ください。</p><p><code>:separator</code>を指定することで、自然な区切り位置で切り詰めることができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate(18)
# =&gt; "Oh dear! Oh dea..."
"Oh dear! Oh dear! I shall be late!".truncate(18, separator: ' ')
# =&gt; "Oh dear! Oh..."

</pre>
</div>
<p><code>:separator</code>オプションで正規表現を使用することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate(18, separator: /\s/)
# =&gt; "Oh dear! Oh..."

</pre>
</div>
<p>上の例では、"dear"という文字で切り落とされそうになるところを、<code>:separator</code>によって防いでいます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/filters.rb</code>です。</p></div><h4 id="truncate-words"><a href="#truncate-words">5.5 <code>truncate_words</code></a></h4><p><code>truncate_words</code>メソッドは、指定されたワード数から後ろをきりおとしたレシーバのコピーを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate_words(4)
# =&gt; "Oh dear! Oh dear!..."

</pre>
</div>
<p><code>:omission</code>オプションを指定することで、省略文字 (…) をカスタマイズすることもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate_words(4, omission: '&amp;hellip;')
# =&gt; "Oh dear! Oh dear!&amp;hellip;"

</pre>
</div>
<p><code>:separator</code>を指定することで、自然な区切り位置で切り詰めることができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate_words(3, separator: '!')
# =&gt; "Oh dear! Oh dear! I shall be late..."

</pre>
</div>
<p><code>:separator</code>オプションで正規表現を使用することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate_words(4, separator: /\s/)
# =&gt; "Oh dear! Oh dear!..."

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/filters.rb</code>です。</p></div><h4 id="inquiry"><a href="#inquiry">5.6 <code>inquiry</code></a></h4><p><code>inquiry</code>は、文字列を<code>StringInquirer</code>オブジェクトに変換します。このオブジェクトを使用すると、等しいかどうかをよりスマートにチェックできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"production".inquiry.production? # =&gt; true
"active".inquiry.inactive?       # =&gt; false

</pre>
</div>
<h4 id="starts-with-questionmarkとends-with-questionmark"><a href="#starts-with-questionmark%E3%81%A8ends-with-questionmark">5.7 <code>starts_with?</code>と<code>ends_with?</code></a></h4><p>Active Supportでは、<code>String#start_with?</code>と<code>String#end_with?</code>を英語的に自然な三人称(starts、ends)にした別名も定義してあります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"foo".starts_with?("f") # =&gt; true
"foo".ends_with?("o")   # =&gt; true

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/starts_ends_with.rb</code>です。</p></div><h4 id="strip-heredoc"><a href="#strip-heredoc">5.8 <code>strip_heredoc</code></a></h4><p><code>strip_heredoc</code>メソッドは、ヒアドキュメントのインデントを除去します。</p><p>以下に例を示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
if options[:usage]
  puts &lt;&lt;-USAGE.strip_heredoc
    This command does such and such.

    Supported options are:
      -h         This message
      ...
  USAGE
end

</pre>
</div>
<p>このUSAGEメッセージは左寄せで表示されます。</p><p>技術的には、インデントが一番浅い行を探して、そのインデント分だけ行頭のホワイトスペースを全体から削除するという操作を行っています。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/strip.rb</code>です。</p></div><h4 id="indent"><a href="#indent">5.9 <code>indent</code></a></h4><p>このメソッドは、レシーバの行にインデントを与えます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
&lt;&lt;EOS.indent(2)
def some_method
  some_code
end
EOS
# =&gt;
  def some_method
    some_code
  end

</pre>
</div>
<p>2つめの引数<code>indent_string</code>は、インデントに使用する文字列を指定します。デフォルトは<code>nil</code>であり、この場合最初にインデントされている行のインデント文字を参照してそこからインデント文字を推測します。インデントがまったくない場合はスペース1つを使用します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"  foo".indent(2)        # =&gt; "    foo"
"foo\n\t\tbar".indent(2) # =&gt; "\t\tfoo\n\t\t\t\tbar"
"foo".indent(2, "\t")    # =&gt; "\t\tfoo"

</pre>
</div>
<p><code>indent_string</code>には1文字のスペースまたはタブを使用するのが普通ですが、どんな文字でも使用できます。</p><p>3つ目の引数<code>indent_empty_lines</code>は、空行もインデントするかどうかを指定するフラグです。デフォルトはfalseです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"foo\n\nbar".indent(2)            # =&gt; "  foo\n\n  bar"
"foo\n\nbar".indent(2, nil, true) # =&gt; "  foo\n  \n  bar"

</pre>
</div>
<p><code>indent!</code>メソッドはインデントをその場で (破壊的に) 行います。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/indent.rb</code>です。</p></div><h4 id="access"><a href="#access">5.10 Access</a></h4><h5 id="at-position"><a href="#at-position">5.10.1 <code>at(position)</code></a></h5><p>対象となる文字列のうち、<code>position</code>で指定された位置にある文字を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"hello".at(0)  # =&gt; "h"
"hello".at(4)  # =&gt; "o"
"hello".at(-1) # =&gt; "o"
"hello".at(10) # =&gt; nil

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/access.rb</code>です。</p></div><h5 id="from-position"><a href="#from-position">5.10.2 <code>from(position)</code></a></h5><p>文字列のうち、<code>position</code>で指定された位置から始まる部分文字列を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"hello".from(0)  # =&gt; "hello"
"hello".from(2)  # =&gt; "llo"
"hello".from(-2) # =&gt; "lo"
"hello".from(10) # =&gt; nil

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/access.rb</code>です。</p></div><h5 id="to-position"><a href="#to-position">5.10.3 <code>to(position)</code></a></h5><p>文字列のうち、<code>position</code>で指定された位置を終端とする部分文字列を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"hello".to(0)  # =&gt; "h"
"hello".to(2)  # =&gt; "hel"
"hello".to(-2) # =&gt; "hell"
"hello".to(10) # =&gt; "hello"

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/access.rb</code>です。</p></div><h5 id="first-limit-1"><a href="#first-limit-1">5.10.4 <code>first(limit = 1)</code></a></h5><p><code>str.first(n)</code>という呼び出しは、<code>n</code> &gt; 0 のとき<code>str.to(n-1)</code>と等価です。<code>n</code> == 0の場合は空文字列を返します。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/access.rb</code>です。</p></div><h5 id="last-limit-1"><a href="#last-limit-1">5.10.5 <code>last(limit = 1)</code></a></h5><p><code>str.last(n)</code> という呼び出しは、<code>n</code> &gt; 0 のとき<code>str.from(-n)</code>と等価です。<code>n</code> == 0 の場合は空文字列を返します。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/access.rb</code>です。</p></div><h4 id="活用形"><a href="#%E6%B4%BB%E7%94%A8%E5%BD%A2">5.11 活用形</a></h4><h5 id="pluralize"><a href="#pluralize">5.11.1 <code>pluralize</code></a></h5><p><code>pluralize</code>メソッドは、レシーバを「複数形」にしたものを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"table".pluralize     # =&gt; "tables"
"ruby".pluralize      # =&gt; "rubies"
"equipment".pluralize # =&gt; "equipment"

</pre>
</div>
<p>上の例でも示したように、Active Supportは不規則な複数形や非可算名詞についてある程度知っています。<code>config/initializers/inflections.rb</code>にあるビルトインのルールは拡張可能です。このファイルは<code>rails</code>コマンドで拡張可能であり、方法はコメントに示されています。</p><p><code>pluralize</code>メソッドではオプションで<code>count</code>パラメータを使用できます。もし<code>count == 1</code>を指定すると単数形が返されます。<code>count</code>がそれ以外の値の場合は複数形を返します(訳注: 英語では個数がゼロや小数の場合は複数形で表されます)。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"dude".pluralize(0) # =&gt; "dudes"
"dude".pluralize(1) # =&gt; "dude"
"dude".pluralize(2) # =&gt; "dudes"

</pre>
</div>
<p>Active Recordでは、モデル名に対応するデフォルトのテーブル名を求めるときにこのメソッドを使用しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_record/model_schema.rb
def undecorated_table_name(class_name = base_class.name)
  table_name = class_name.to_s.demodulize.underscore
  pluralize_table_names ? table_name.pluralize : table_name
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="singularize"><a href="#singularize">5.11.2 <code>singularize</code></a></h5><p><code>pluralize</code>と逆の動作です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"tables".singularize    # =&gt; "table"
"rubies".singularize    # =&gt; "ruby"
"equipment".singularize # =&gt; "equipment"

</pre>
</div>
<p>Railsの関連付け (association) では、関連付けられたクラスにデフォルトで対応する名前を求める時にこのメソッドが使用されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_record/reflection.rb
def derive_class_name
  class_name = name.to_s.camelize
  class_name = class_name.singularize if collection?
  class_name
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="camelize"><a href="#camelize">5.11.3 <code>camelize</code></a></h5><p><code>camelize</code>メソッドは、レシーバをキャメルケース (冒頭を大文字にした単語をスペースなしで連結した語) にしたものを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"product".camelize    # =&gt; "Product"
"admin_user".camelize # =&gt; "AdminUser"

</pre>
</div>
<p>このメソッドは、パスをRubyのクラスに変換するときにもよく使用されます。スラッシュで区切られているパスは「::」で区切られます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"backoffice/session".camelize # =&gt; "Backoffice::Session"

</pre>
</div>
<p>たとえばAction Packでは、特定のセッションストアを提供するクラスを読み込むのにこのメソッドを使用しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# action_controller/metal/session_management.rb
def session_store=(store)
  @@session_store = store.is_a?(Symbol) ?
    ActionDispatch::Session.const_get(store.to_s.camelize) :
    store
end

</pre>
</div>
<p><code>camelize</code>メソッドはオプションの引数を受け付けます。使用できるのは<code>:upper</code> (デフォルト) または<code>:lower</code>です。後者を指定すると、冒頭が小文字になります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"visual_effect".camelize(:lower) # =&gt; "visualEffect"

</pre>
</div>
<p>このメソッドは、そのような命名慣習に従っている言語 (JavaScriptなど) で使用される名前を求めるのに便利です。</p><div class="info"><p><code>camerize</code>メソッドの動作は、<code>underscore</code>メソッドと逆の動作と考えるとわかりやすいでしょう。ただし完全に逆の動作ではありません。たとえば、<code>"SSLError".underscore.camelize</code>を実行した結果は<code>"SslError"</code>になり、元に戻りません。このような場合をサポートするために、Active Supportでは<code>config/initializers/inflections.rb</code>の頭字語を指定することができます。</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActiveSupport::Inflector.inflections do |inflect|
  inflect.acronym 'SSL'
end

"SSLError".underscore.camelize # =&gt; "SSLError"

</pre>
</div>
<p><code>camelize</code>は<code>camelcase</code>の別名です。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="underscore"><a href="#underscore">5.11.4 <code>underscore</code></a></h5><p><code>underscore</code>メソッドは上と逆に、キャメルケースをパスに変換します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Product".underscore   # =&gt; "product"
"AdminUser".underscore # =&gt; "admin_user"

</pre>
</div>
<p>"::"も"/"に逆変換されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Backoffice::Session".underscore # =&gt; "backoffice/session"

</pre>
</div>
<p>小文字で始まる文字列も扱えます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"visualEffect".underscore # =&gt; "visual_effect"

</pre>
</div>
<p>ただし<code>underscore</code>は引数を取りません。</p><p>Railsで自動的に読み込まれるクラスとモジュールは、<code>underscore</code>メソッドを使用してファイルの拡張子を除いた相対パスを推測し、指定された定数が失われている場合にそれを定義するのに役立てます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_support/dependencies.rb
def load_missing_constant(from_mod, const_name)
  ...
  qualified_name = qualified_name_for from_mod, const_name
  path_suffix = qualified_name.underscore
  ...
end

</pre>
</div>
<div class="info"><p><code>underscore</code>メソッドの動作は、<code>camelize</code>メソッドと逆の動作と考えるとわかりやすいでしょう。ただし完全に逆の動作ではありません。たとえば、<code>"SSLError".underscore.camelize</code>を実行した結果は<code>"SslError"</code>になり、元に戻りません。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="titleize"><a href="#titleize">5.11.5 <code>titleize</code></a></h5><p><code>titleize</code>メソッドは、レシーバの語の1文字目を大文字にします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"alice in wonderland".titleize # =&gt; "Alice In Wonderland"
"fermat's enigma".titleize     # =&gt; "Fermat's Enigma"

</pre>
</div>
<p><code>titleize</code>メソッドは<code>titlecase</code>の別名です。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="dasherize"><a href="#dasherize">5.11.6 <code>dasherize</code></a></h5><p><code>dasherize</code>メソッドは、レシーバのアンダースコア文字をダッシュに置き換えます(訳注: ここで言うダッシュは実際には「ハイフンマイナス文字」(U+002D)です)。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"name".dasherize         # =&gt; "name"
"contact_data".dasherize # =&gt; "contact-data"

</pre>
</div>
<p>モデルのXMLシリアライザではこのメソッドを使用してノード名をダッシュ化しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_model/serializers/xml.rb
def reformat_name(name)
  name = name.camelize if camelize?
  dasherize? ? name.dasherize : name
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="demodulize"><a href="#demodulize">5.11.7 <code>demodulize</code></a></h5><p><code>demodulize</code>メソッドは、フルパスの (qualified) 定数名を与えられると、パス部分を取り除いて右側の定数名だけにしたものを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Product".demodulize                        # =&gt; "Product"
"Backoffice::UsersController".demodulize    # =&gt; "UsersController"
"Admin::Hotel::ReservationUtils".demodulize # =&gt; "ReservationUtils"
"::Inflections".demodulize                  # =&gt; "Inflections"
"".demodulize                               # =&gt; ""


</pre>
</div>
<p>以下のActive Recordの例では、このメソッドを使用してcounter_cacheカラムの名前を求めています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_record/reflection.rb
def counter_cache_column
  if options[:counter_cache] == true
    "#{active_record.name.demodulize.underscore.pluralize}_count"
  elsif options[:counter_cache]
    options[:counter_cache]
  end
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="deconstantize"><a href="#deconstantize">5.11.8 <code>deconstantize</code></a></h5><p><code>deconstantize</code>メソッドは、フルパスの定数を表す参照表現を与えられると、一番右の部分 (通常は定数名) を取り除きます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Product".deconstantize                        # =&gt; ""
"Backoffice::UsersController".deconstantize    # =&gt; "Backoffice"
"Admin::Hotel::ReservationUtils".deconstantize # =&gt; "Admin::Hotel"

</pre>
</div>
<p>以下のActive Recordの例では、<code>Module#qualified_const_set</code>でこのメソッドを使用しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def qualified_const_set(path, value)
  QualifiedConstUtils.raise_if_absolute(path)

  const_name = path.demodulize
  mod_name = path.deconstantize
  mod = mod_name.empty? ? self : qualified_const_get(mod_name)
  mod.const_set(const_name, value)
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="parameterize"><a href="#parameterize">5.11.9 <code>parameterize</code></a></h5><p><code>parameterize</code>メソッドは、レシーバを正しいURLで使用可能な形式に正規化します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"John Smith".parameterize # =&gt; "john-smith"
"Kurt Gödel".parameterize # =&gt; "kurt-godel"

</pre>
</div>
<p>実際に得られる文字列は、<code>ActiveSupport::Multibyte::Chars</code>のインスタンスでラップされています。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="tableize"><a href="#tableize">5.11.10 <code>tableize</code></a></h5><p><code>tableize</code>メソッドは、<code>underscore</code>の次に<code>pluralize</code>を実行したものです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Person".tableize      # =&gt; "people"
"Invoice".tableize     # =&gt; "invoices"
"InvoiceLine".tableize # =&gt; "invoice_lines"

</pre>
</div>
<p>単純な場合であれば、モデル名に<code>tableize</code>を使用するとモデルのテーブル名を得られます。実際のActive Recordの実装は、単に<code>tableize</code>を実行する場合よりも複雑です。Active Recordではクラス名に対して<code>demodulize</code>も行っており、返される文字列に影響する可能性のあるオプションもいくつかチェックしています。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="classify"><a href="#classify">5.11.11 <code>classify</code></a></h5><p><code>classify</code>メソッドは、<code>tableize</code>と逆の動作です。与えられたテーブル名に対応するクラス名を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"people".classify        # =&gt; "Person"
"invoices".classify      # =&gt; "Invoice"
"invoice_lines".classify # =&gt; "InvoiceLine"

</pre>
</div>
<p>このメソッドは、フルパスの (qualified) テーブル名も扱えます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"highrise_production.companies".classify # =&gt; "Company"

</pre>
</div>
<p><code>classify</code>が返すクラス名は文字列であることにご注意ください。得られた文字列に対して<code>constantize</code> (後述) を実行することで本当のクラスオブジェクトを得られます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="constantize"><a href="#constantize">5.11.12 <code>constantize</code></a></h5><p><code>constantize</code>メソッドは、レシーバの定数参照表現を解決し、実際のオブジェクトを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Fixnum".constantize # =&gt; Fixnum

module M
  X = 1
end
"M::X".constantize # =&gt; 1

</pre>
</div>
<p>与えられた文字列を<code>constantize</code>メソッドで評価しても既知の定数とマッチしない、または指定された定数名が正しくない場合は<code>NameError</code>が発生します。</p><p><code>constantize</code>メソッドによる定数名解決は、常にトップレベルの<code>Object</code>から開始されます。これは上位に"::"がない場合でも同じです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
X = :in_Object
module M
  X = :in_M

  X                 # =&gt; :in_M
  "::X".constantize # =&gt; :in_Object
  "X".constantize   # =&gt; :in_Object (!)
end

</pre>
</div>
<p>従って、このメソッドは、同じ場所でRubyが定数を評価したときの値と必ずしも等価ではありません。</p><p>メイラー (mailer) のテストケースでは、テストするクラスの名前からテスト対象のメイラーを取得するのに<code>constantize</code>メソッドを使用します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# action_mailer/test_case.rb
def determine_default_mailer(name)
  name.sub(/Test$/, '').constantize
rescue NameError =&gt; e
  raise NonInferrableMailerError.new(name)
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="humanize"><a href="#humanize">5.11.13 <code>humanize</code></a></h5><p><code>humanize</code>メソッドは、属性名を (英語的に) 読みやすい表記に変換します。</p><p>具体的には以下の変換を行います。</p>
<ul>
<li>引数に (英語の) 活用ルールを適用します(inflection)。</li>
<li>冒頭にアンダースコアがある場合は削除します。</li>
<li>末尾に"_id"がある場合は削除します。</li>
<li>アンダースコアが他にもある場合はスペースに置き換えます。</li>
<li>略語を除いてすべての単語を小文字にします(downcase)。</li>
<li>最初の単語だけ冒頭の文字を大文字にします(capitalize)。</li>
</ul>
<p><code>capitalize</code>オプションをfalseにすると、冒頭の文字は大文字にされません(デフォルトはtrue)。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"name".humanize                         # =&gt; "Name"
"author_id".humanize                    # =&gt; "Author"
"author_id".humanize(capitalize: false) # =&gt; "author"
"comments_count".humanize               # =&gt; "Comments count"
"_id".humanize                          # =&gt; "Id"

</pre>
</div>
<p>"SSL"が頭字語と定義されている場合は以下のようにエラーになります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
'ssl_error'.humanize # =&gt; "SSL error"

</pre>
</div>
<p>ヘルパーメソッド<code>full_messages</code>では、属性名をメッセージに含めるときに<code>humanize</code>を使用しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def full_messages
  map { |attribute, message| full_message(attribute, message) }
end

def full_message
  ...
  attr_name = attribute.to_s.tr('.', '_').humanize
  attr_name = @base.class.human_attribute_name(attribute, default: attr_name)
  ...
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h5 id="foreign-key"><a href="#foreign-key">5.11.14 <code>foreign_key</code></a></h5><p><code>foreign_key</code>メソッドは、クラス名から外部キーカラム名を求める時に使用します。具体的には、<code>demodulize</code>、<code>underscore</code>を実行し、末尾に "_id" を追加します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"User".foreign_key           # =&gt; "user_id"
"InvoiceLine".foreign_key    # =&gt; "invoice_line_id"
"Admin::Session".foreign_key # =&gt; "session_id"

</pre>
</div>
<p>末尾の "_id" のアンダースコアが不要な場合は引数に<code>false</code>を指定します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"User".foreign_key(false) # =&gt; "userid"

</pre>
</div>
<p>関連付け (association) では、外部キーの名前を推測するときにこのメソッドを使用します。たとえば<code>has_one</code>と<code>has_many</code>では以下を行っています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_record/associations.rb
foreign_key = options[:foreign_key] || reflection.active_record.name.foreign_key

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/inflections.rb</code>です。</p></div><h4 id="stringの拡張-各種変換"><a href="#string%E3%81%AE%E6%8B%A1%E5%BC%B5-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">5.12 各種変換</a></h4><h5 id="to-date、to-time、to-datetime"><a href="#to-date%E3%80%81to-time%E3%80%81to-datetime">5.12.1 <code>to_date</code>、<code>to_time</code>、<code>to_datetime</code></a></h5><p><code>to_date</code>、<code>to_time</code>、<code>to_datetime</code>メソッドは、<code>Date._parse</code>をラップして使いやすくします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"2010-07-27".to_date              # =&gt; Tue, 27 Jul 2010
"2010-07-27 23:37:00".to_time     # =&gt; Tue Jul 27 23:37:00 UTC 2010
"2010-07-27 23:37:00".to_datetime # =&gt; Tue, 27 Jul 2010 23:37:00 +0000

</pre>
</div>
<p><code>to_time</code>はオプションで<code>:utc</code>や<code>:local</code>を引数に取り、タイムゾーンを指定することができます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"2010-07-27 23:42:00".to_time(:utc)   # =&gt; Tue Jul 27 23:42:00 UTC 2010
"2010-07-27 23:42:00".to_time(:local) # =&gt; Tue Jul 27 23:42:00 +0200 2010

</pre>
</div>
<p>デフォルトは<code>:utc</code>です。</p><p>詳細については<code>Date._parse</code>のドキュメントを参照してください。</p><div class="info"><p>3つのメソッドはいずれも、レシーバが空の場合は<code>nil</code>を返します。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/string/conversions.rb</code>です。</p></div><h3 id="numericの拡張"><a href="#numeric%E3%81%AE%E6%8B%A1%E5%BC%B5">6 <code>Numeric</code>の拡張</a></h3><h4 id="バイト"><a href="#%E3%83%90%E3%82%A4%E3%83%88">6.1 バイト</a></h4><p>すべての数値は、以下のメソッドに応答します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
bytes
kilobytes
megabytes
gigabytes
terabytes
petabytes
exabytes

</pre>
</div>
<p>これらのメソッドは、対応するバイト数を返すときに1024の倍数を使用します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
2.kilobytes   # =&gt; 2048
3.megabytes   # =&gt; 3145728
3.5.gigabytes # =&gt; 3758096384
-4.exabytes   # =&gt; -4611686018427387904

</pre>
</div>
<p>これらのメソッドには単数形の別名もあります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.megabyte # =&gt; 1048576

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/numeric/bytes.rb</code>です。</p></div><h4 id="time"><a href="#time">6.2 Time</a></h4><p>たとえば<code>45.minutes + 2.hours + 4.years</code>のように時間の計算や宣言を行なうことができます。</p><p>これらのメソッドでは、from_nowやagoなどを使用したり、またはTimeオブジェクトから得た結果の加減算を行なう際に、Time#advanceを使用して正確な日付計算を行っています。以下に例を示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Time.current.advance(months: 1) と等価
1.month.from_now

# Time.current.advance(years: 2) と等価
2.years.from_now

# Time.current.advance(months: 4, years: 5) と等価
(4.months + 5.years).from_now

</pre>
</div>
<h4 id="フォーマッティング"><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">6.3 フォーマッティング</a></h4><p>数値はさまざまな方法でフォーマットできます。</p><p>以下のように、数値を電話番号形式の文字列に変換できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
5551234.to_s(:phone)
# =&gt; 555-1234
1235551234.to_s(:phone)
# =&gt; 123-555-1234
1235551234.to_s(:phone, area_code: true)
# =&gt; (123) 555-1234
1235551234.to_s(:phone, delimiter: " ")
# =&gt; 123 555 1234
1235551234.to_s(:phone, area_code: true, extension: 555)
# =&gt; (123) 555-1234 x 555
1235551234.to_s(:phone, country_code: 1)
# =&gt; +1-123-555-1234

</pre>
</div>
<p>以下のように、数値を通貨形式の文字列に変換できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1234567890.50.to_s(:currency)                 # =&gt; $1,234,567,890.50
1234567890.506.to_s(:currency)                # =&gt; $1,234,567,890.51
1234567890.506.to_s(:currency, precision: 3)  # =&gt; $1,234,567,890.506

</pre>
</div>
<p>以下のように、数値を百分率形式の文字列に変換できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
100.to_s(:percentage)
# =&gt; 100.000%
100.to_s(:percentage, precision: 0)
# =&gt; 100%
1000.to_s(:percentage, delimiter: '.', separator: ',')
# =&gt; 1.000,000%
302.24398923423.to_s(:percentage, precision: 5)
# =&gt; 302.24399%

</pre>
</div>
<p>以下のように、数値の桁区切りを追加して文字列形式にできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
12345678.to_s(:delimited)                     # =&gt; 12,345,678
12345678.05.to_s(:delimited)                  # =&gt; 12,345,678.05
12345678.to_s(:delimited, delimiter: ".")     # =&gt; 12.345.678
12345678.to_s(:delimited, delimiter: ",")     # =&gt; 12,345,678
12345678.05.to_s(:delimited, separator: " ")  # =&gt; 12,345,678 05

</pre>
</div>
<p>以下のように、数字を特定の精度に丸めて文字列形式にできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
111.2345.to_s(:rounded)                     # =&gt; 111.235
111.2345.to_s(:rounded, precision: 2)       # =&gt; 111.23
13.to_s(:rounded, precision: 5)             # =&gt; 13.00000
389.32314.to_s(:rounded, precision: 0)      # =&gt; 389
111.2345.to_s(:rounded, significant: true)  # =&gt; 111

</pre>
</div>
<p>以下のように、数値を人間にとって読みやすいバイト数形式の文字列に変換できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
123.to_s(:human_size)            # =&gt; 123 Bytes
1234.to_s(:human_size)           # =&gt; 1.21 KB
12345.to_s(:human_size)          # =&gt; 12.1 KB
1234567.to_s(:human_size)        # =&gt; 1.18 MB
1234567890.to_s(:human_size)     # =&gt; 1.15 GB
1234567890123.to_s(:human_size)  # =&gt; 1.12 TB

</pre>
</div>
<p>以下のように、数値を人間にとって読みやすいバイト数形式で単位が単語の文字列に変換できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
123.to_s(:human)               # =&gt; "123"
1234.to_s(:human)              # =&gt; "1.23 Thousand"
12345.to_s(:human)             # =&gt; "12.3 Thousand"
1234567.to_s(:human)           # =&gt; "1.23 Million"
1234567890.to_s(:human)        # =&gt; "1.23 Billion"
1234567890123.to_s(:human)     # =&gt; "1.23 Trillion"
1234567890123456.to_s(:human)  # =&gt; "1.23 Quadrillion"

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/numeric/conversions.rb</code>です。</p></div><h3 id="integerの拡張"><a href="#integer%E3%81%AE%E6%8B%A1%E5%BC%B5">7 <code>Integer</code>の拡張</a></h3><h4 id="multiple-of-questionmark"><a href="#multiple-of-questionmark">7.1 <code>multiple_of?</code></a></h4><p><code>multiple_of?</code>メソッドは、レシーバの整数が引数の倍数であるかどうかをテストします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
2.multiple_of?(1) # =&gt; true
1.multiple_of?(2) # =&gt; false

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/integer/multiple.rb</code>です。</p></div><h4 id="ordinal"><a href="#ordinal">7.2 <code>ordinal</code></a></h4><p><code>ordinal</code>メソッドは、レシーバの整数に対応する序数のサフィックス文字列を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.ordinal    # =&gt; "st"
2.ordinal    # =&gt; "nd"
53.ordinal   # =&gt; "rd"
2009.ordinal # =&gt; "th"
-21.ordinal  # =&gt; "st"
-134.ordinal # =&gt; "th"

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/integer/inflections.rb</code>です。</p></div><h4 id="ordinalize"><a href="#ordinalize">7.3 <code>ordinalize</code></a></h4><p><code>ordinalize</code>メソッドは、レシーバの整数に、対応する序数文字列を追加したものをかえします。先に紹介した<code>ordinal</code>メソッドは、序数文字列 <strong>だけ</strong> を返す点が異なることにご注意ください。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.ordinalize    # =&gt; "1st"
2.ordinalize    # =&gt; "2nd"
53.ordinalize   # =&gt; "53rd"
2009.ordinalize # =&gt; "2009th"
-21.ordinalize  # =&gt; "-21st"
-134.ordinalize # =&gt; "-134th"

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/integer/inflections.rb</code>です。</p></div><h3 id="bigdecimalの拡張"><a href="#bigdecimal%E3%81%AE%E6%8B%A1%E5%BC%B5">8 <code>BigDecimal</code>の拡張</a></h3><h4 id="bigdecimalの拡張-to-s"><a href="#bigdecimal%E3%81%AE%E6%8B%A1%E5%BC%B5-to-s">8.1 <code>to_s</code></a></h4><p>この<code>to_s</code>メソッドは、<code>to_formatted_s</code>メソッドの別名です。このメソッドは、浮動小数点記法のBigDecimal値を簡単に表示するための便利な方法を提供します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
BigDecimal.new(5.00, 6).to_s  # =&gt; "5.0"

</pre>
</div>
<h4 id="bigdecimalの拡張-to-formatted-s"><a href="#bigdecimal%E3%81%AE%E6%8B%A1%E5%BC%B5-to-formatted-s">8.2 <code>to_formatted_s</code></a></h4><p>この<code>to_formatted_s</code>メソッドは、"F"のデフォルトの指定部 (specifier) を提供します。これは、<code>to_formatted_s</code>または<code>to_s</code>を単に呼び出すと、エンジニアリング記法 ('0.5E1'のような記法) ではなく浮動小数点記法を得られるということです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
BigDecimal.new(5.00, 6).to_formatted_s  # =&gt; "5.0"

</pre>
</div>
<p>また、シンボルを使用した指定部もサポートされます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
BigDecimal.new(5.00, 6).to_formatted_s(:db)  # =&gt; "5.0"

</pre>
</div>
<p>エンジニアリング記法も従来通りサポートされます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
BigDecimal.new(5.00, 6).to_formatted_s("e")  # =&gt; "0.5E1"

</pre>
</div>
<h3 id="enumerableの拡張"><a href="#enumerable%E3%81%AE%E6%8B%A1%E5%BC%B5">9 <code>Enumerable</code>の拡張</a></h3><h4 id="sum"><a href="#sum">9.1 <code>sum</code></a></h4><p><code>sum</code>メソッドはenumerableの要素を合計します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[1, 2, 3].sum # =&gt; 6
(1..100).sum  # =&gt; 5050

</pre>
</div>
<p><code>+</code>に応答する要素のみが加算の対象として前提とされます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[[1, 2], [2, 3], [3, 4]].sum    # =&gt; [1, 2, 2, 3, 3, 4]
%w(foo bar baz).sum             # =&gt; "foobarbaz"
{a: 1, b: 2, c: 3}.sum # =&gt; [:b, 2, :c, 3, :a, 1]

</pre>
</div>
<p>空のコレクションはデフォルトではゼロを返しますが、この動作はカスタマイズ可能です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[].sum    # =&gt; 0
[].sum(1) # =&gt; 1

</pre>
</div>
<p>ブロックが与えられた場合、<code>sum</code>はイテレータになってコレクションの要素をyieldし、そこから返された値を合計します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(1..5).sum {|n| n * 2 } # =&gt; 30
[2, 4, 6, 8, 10].sum    # =&gt; 30

</pre>
</div>
<p>ブロックを与える場合にも、レシーバが空のときのデフォルト値をカスタマイズできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[].sum(1) {|n| n**3} # =&gt; 1

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/enumerable.rb</code>です。</p></div><h4 id="index-by"><a href="#index-by">9.2 <code>index_by</code></a></h4><p><code>index_by</code>メソッドは、何らかのキーによってインデックス化されたenumerableの要素を持つハッシュを生成します。</p><p>このメソッドはコレクションを列挙し、各要素をブロックに渡します。この要素は、ブロックから返された値によってインデックス化されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
invoices.index_by(&amp;:number)
# =&gt; {'2009-032' =&gt; &lt;Invoice ...&gt;, '2009-008' =&gt; &lt;Invoice ...&gt;, ...}

</pre>
</div>
<div class="warning"><p>キーは通常はユニークでなければなりません。異なる要素から同じ値が返されると、そのキーのコレクションは作成されません。返された項目のうち、最後の項目だけが使用されます。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/enumerable.rb</code>です</p></div><h4 id="many-questionmark"><a href="#many-questionmark">9.3 <code>many?</code></a></h4><p><code>many?</code>メソッドは、<code>collection.size &gt; 1</code>の短縮形です。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;% if pages.many? %&gt;
  &lt;%= pagination_links %&gt;
&lt;% end %&gt;

</pre>
</div>
<p><code>many?</code>は、ブロックがオプションとして与えられると、trueを返す要素だけを扱います。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
@see_more = videos.many? {|video| video.category == params[:category]}

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/enumerable.rb</code>です。</p></div><h4 id="exclude-questionmark"><a href="#exclude-questionmark">9.4 <code>exclude?</code></a></h4><p><code>exclude?</code>述語は、与えられたオブジェクトがそのコレクションに属して <strong>いない</strong> かどうかをテストします。<code>include?</code>の逆の動作です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
to_visit &lt;&lt; node if visited.exclude?(node)

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/enumerable.rb</code>です。</p></div><h4 id="without"><a href="#without">9.5 <code>without</code></a></h4><p><code>without</code>メソッドは、指定した要素を除外したenumerableのコピーを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
["David", "Rafael", "Aaron", "Todd"].without("Aaron", "Todd") # =&gt; ["David", "Rafael"]

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/enumerable.rb</code>です。</p></div><h3 id="arrayの拡張"><a href="#array%E3%81%AE%E6%8B%A1%E5%BC%B5">10 <code>Array</code>の拡張</a></h3><h4 id="accessing"><a href="#accessing">10.1 Accessing</a></h4><p>Active Supportには配列のAPIが多数追加されており、配列に容易にアクセスできるようになっています。たとえば<code>to</code>メソッドは、配列の冒頭から、渡されたインデックスが示す箇所までの範囲を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).to(2) # =&gt; %w(a b c)
[].to(7)          # =&gt; []

</pre>
</div>
<p>同様に<code>from</code>メソッドは、配列のうち、インデックスが指す箇所から末尾までの要素を返します。インデックスが配列のサイズより大きい場合は、空の配列を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).from(2)  # =&gt; %w(c d)
%w(a b c d).from(10) # =&gt; []
[].from(0)           # =&gt; []

</pre>
</div>
<p><code>second</code>、<code>third</code>、<code>fourth</code>、<code>fifth</code>は、対応する位置の要素を返します (<code>first</code>は元からビルトインされています)。社会の智慧と建設的な姿勢のおかげで、今では<code>forty_two</code>も使用できます (訳注: <a href="https://github.com/rails/rails/commit/9d8cc60ec3845fa3e6f9292a65b119fe4f619f7e">Rails 2.2 以降</a>で使えます。「42」については、Wikipediaの<a href="http://ja.wikipedia.org/wiki/%E7%94%9F%E5%91%BD%E3%80%81%E5%AE%87%E5%AE%99%E3%80%81%E3%81%9D%E3%81%97%E3%81%A6%E4%B8%87%E7%89%A9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E7%A9%B6%E6%A5%B5%E3%81%AE%E7%96%91%E5%95%8F%E3%81%AE%E7%AD%94%E3%81%88">生命、宇宙、そして万物についての究極の疑問の答え</a>を参照してください)。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).third # =&gt; c
%w(a b c d).fifth # =&gt; nil

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/access.rb</code>です。</p></div><h4 id="要素を加える"><a href="#%E8%A6%81%E7%B4%A0%E3%82%92%E5%8A%A0%E3%81%88%E3%82%8B">10.2 要素を加える</a></h4><h5 id="prepend"><a href="#prepend">10.2.1 <code>prepend</code></a></h5><p>このメソッドは、<code>Array#unshift</code>の別名です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).prepend('e')  # =&gt; %w(e a b c d)
[].prepend(10)            # =&gt; [10]

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/prepend_and_append.rb</code>です。</p></div><h5 id="append"><a href="#append">10.2.2 <code>append</code></a></h5><p>このメソッドは、<code>Array#&lt;&lt;</code>の別名です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).append('e')  # =&gt; %w(a b c d e)
[].append([1,2])         # =&gt; [[1,2]]

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/prepend_and_append.rb</code>です。</p></div><h4 id="オプションの展開"><a href="#%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%B1%95%E9%96%8B">10.3 オプションの展開</a></h4><p>Rubyでは、メソッドに与えられた最後の引数がハッシュの場合、それが<code>&amp;block</code>引数である場合を除いて、ハッシュの波括弧を省略できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
User.exists?(email: params[:email])

</pre>
</div>
<p>このようなシンタックスシュガーは、多数ある引数が順序に依存することを避け、名前付きパラメータをエミュレートするインターフェイスを提供するためにRailsで多用されています。特に、末尾にオプションのハッシュを置くというのは定番中の定番です。</p><p>しかし、あるメソッドが受け取る引数の数が固定されておらず、メソッド宣言で<code>*</code>が使用されていると、そのような波括弧なしのオプションハッシュは、引数の配列の末尾の要素になってしまい、ハッシュとして認識されなくなってしまいます。</p><p>このような場合、<code>extract_options!</code>メソッドは、配列の最後の項目の型をチェックします。それがハッシュの場合、そのハッシュを取り出して返し、それ以外の場合は空のハッシュを返します。</p><p><code>caches_action</code>コントローラマクロでの定義を例にとって見てみましょう。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def caches_action(*actions)
  return unless cache_configured?
  options = actions.extract_options!
  ...
end

</pre>
</div>
<p>このメソッドは、任意の数のアクション名を引数に取ることができ、引数の末尾項目でオプションハッシュを使用できます。<code>extract_options!</code>メソッドを使用すると、このオプションハッシュを取り出し、<code>actions</code>から取り除くことが簡単かつ明示的に行えます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/extract_options.rb</code>です。</p></div><h4 id="arrayの拡張-各種変換"><a href="#array%E3%81%AE%E6%8B%A1%E5%BC%B5-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">10.4 各種変換</a></h4><h5 id="to-sentence"><a href="#to-sentence">10.4.1 <code>to_sentence</code></a></h5><p><code>to_sentence</code>メソッドは、配列を変換して、要素を列挙する英文にします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w().to_sentence                # =&gt; ""
%w(Earth).to_sentence           # =&gt; "Earth"
%w(Earth Wind).to_sentence      # =&gt; "Earth and Wind"
%w(Earth Wind Fire).to_sentence # =&gt; "Earth, Wind, and Fire"

</pre>
</div>
<p>このメソッドは3つのオプションを受け付けます。</p>
<ul>
<li>
<code>:two_words_connector</code>: 項目数が2つの場合の接続詞を指定します。デフォルトは" and "です。</li>
<li>
<code>:words_connector</code>: 3つ以上の要素を接続する場合、最後の2つの間以外で使われる接続詞を指定します。デフォルトは", "です。</li>
<li>
<code>:last_word_connector</code>: 3つ以上の要素を接続する場合、最後の2つの要素で使用する接続詞を指定します。デフォルトは", and "です。</li>
</ul>
<p>これらのオプションは標準の方法でローカライズできます。使用するキーは以下のとおりです。</p>
<table>
<thead>
<tr>
<th>オプション</th>
<th>I18n キー</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>:two_words_connector</code></td>
<td><code>support.array.two_words_connector</code></td>
</tr>
<tr>
<td><code>:words_connector</code></td>
<td><code>support.array.words_connector</code></td>
</tr>
<tr>
<td><code>:last_word_connector</code></td>
<td><code>support.array.last_word_connector</code></td>
</tr>
</tbody>
</table>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/conversions.rb</code>です。</p></div><h5 id="各種変換-to-formatted-s"><a href="#%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B-to-formatted-s">10.4.2 <code>to_formatted_s</code></a></h5><p><code>to_formatted_s</code>メソッドは、デフォルトでは<code>to_s</code>と同様に振る舞います。</p><p>ただし、配列の中に<code>id</code>に応答する項目がある場合は、<code>:db</code>というシンボルを引数として渡すことで対応できる点が異なります。この手法は、Active Recordオブジェクトのコレクションに対してよく使われます。返される文字列は以下のとおりです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[].to_formatted_s(:db)            # =&gt; "null"
[user].to_formatted_s(:db)        # =&gt; "8456"
invoice.lines.to_formatted_s(:db) # =&gt; "23,567,556,12"

</pre>
</div>
<p>上の例の整数は、<code>id</code>への呼び出しによって取り出されたものと考えられます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/conversions.rb</code>です。</p></div><h5 id="arrayの拡張-各種変換-to-xml"><a href="#array%E3%81%AE%E6%8B%A1%E5%BC%B5-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B-to-xml">10.4.3 <code>to_xml</code></a></h5><p><code>to_xml</code>メソッドは、レシーバをXML表現に変換したものを含む文字列を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Contributor.limit(2).order(:rank).to_xml
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;contributors type="array"&gt;
#   &lt;contributor&gt;
#     &lt;id type="integer"&gt;4356&lt;/id&gt;
#     &lt;name&gt;Jeremy Kemper&lt;/name&gt;
#     &lt;rank type="integer"&gt;1&lt;/rank&gt;
#     &lt;url-id&gt;jeremy-kemper&lt;/url-id&gt;
#   &lt;/contributor&gt;
#   &lt;contributor&gt;
#     &lt;id type="integer"&gt;4404&lt;/id&gt;
#     &lt;name&gt;David Heinemeier Hansson&lt;/name&gt;
#     &lt;rank type="integer"&gt;2&lt;/rank&gt;
#     &lt;url-id&gt;david-heinemeier-hansson&lt;/url-id&gt;
#   &lt;/contributor&gt;
# &lt;/contributors&gt;

</pre>
</div>
<p>実際には、<code>to_xml</code>をすべての要素に送り、結果をルートノードの下に集めます。すべての要素が<code>to_xml</code>に応答する必要があります。そうでない場合は例外が発生します。</p><p>デフォルトでは、ルート要素の名前は最初の要素のクラス名を複数形にしてアンダースコア化(underscorize)とダッシュ化(dasherize)を行います。残りの要素も最初の要素と同じ型 (<code>is_a?</code>でチェックされます) に属し、ハッシュでないことが前提となっています。上の例で言うと、"contributors"です。</p><p>最初の要素と同じ型に属さない要素が1つでもある場合、ルートノードには<code>objects</code>が使用されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[Contributor.first, Commit.first].to_xml
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;objects type="array"&gt;
#   &lt;object&gt;
#     &lt;id type="integer"&gt;4583&lt;/id&gt;
#     &lt;name&gt;Aaron Batalion&lt;/name&gt;
#     &lt;rank type="integer"&gt;53&lt;/rank&gt;
#     &lt;url-id&gt;aaron-batalion&lt;/url-id&gt;
#   &lt;/object&gt;
#   &lt;object&gt;
#     &lt;author&gt;Joshua Peek&lt;/author&gt;
#     &lt;authored-timestamp type="datetime"&gt;2009-09-02T16:44:36Z&lt;/authored-timestamp&gt;
#     &lt;branch&gt;origin/master&lt;/branch&gt;
#     &lt;committed-timestamp type="datetime"&gt;2009-09-02T16:44:36Z&lt;/committed-timestamp&gt;
#     &lt;committer&gt;Joshua Peek&lt;/committer&gt;
#     &lt;git-show nil="true"&gt;&lt;/git-show&gt;
#     &lt;id type="integer"&gt;190316&lt;/id&gt;
#     &lt;imported-from-svn type="boolean"&gt;false&lt;/imported-from-svn&gt;
#     &lt;message&gt;Kill AMo observing wrap_with_notifications since ARes was only using it&lt;/message&gt;
#     &lt;sha1&gt;723a47bfb3708f968821bc969a9a3fc873a3ed58&lt;/sha1&gt;
#   &lt;/object&gt;
# &lt;/objects&gt;

</pre>
</div>
<p>レシーバがハッシュの配列である場合、ルート要素はデフォルトで<code>objects</code>になります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[{a: 1, b: 2}, {c: 3}].to_xml
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;objects type="array"&gt;
#   &lt;object&gt;
#     &lt;b type="integer"&gt;2&lt;/b&gt;
#     &lt;a type="integer"&gt;1&lt;/a&gt;
#   &lt;/object&gt;
#   &lt;object&gt;
#     &lt;c type="integer"&gt;3&lt;/c&gt;
#   &lt;/object&gt;
# &lt;/objects&gt;

</pre>
</div>
<div class="warning"><p>コレクションが空の場合、ルート要素はデフォルトで"nilクラス"になります。ここからわかるように、たとえば上の例でのcontributorsのリストのルート要素は、コレクションがもし空であれば "contributors" ではなく "nilクラス" になってしまうということです。<code>:root</code>オプションを使用することで一貫したルート要素を使用することもできます。</p></div><p>子ノードの名前は、デフォルトではルートノードを単数形にしたものが使用されます。上の例で言うと"contributor"や"object"です。<code>:children</code>オプションを使用すると、これらをノード名として設定できます。</p><p>デフォルトのXMLビルダは、<code>Builder::XmlMarkup</code>から直接生成されたインスタンスです。<code>:builder</code>オブションを使用することで、独自のビルダを構成できます。このメソッドでは<code>:dasherize</code>とその同族と同様のオプションが使用できます。それらのオプションはビルダに転送されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Contributor.limit(2).order(:rank).to_xml(skip_types: true)
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;contributors&gt;
#   &lt;contributor&gt;
#     &lt;id&gt;4356&lt;/id&gt;
#     &lt;name&gt;Jeremy Kemper&lt;/name&gt;
#     &lt;rank&gt;1&lt;/rank&gt;
#     &lt;url-id&gt;jeremy-kemper&lt;/url-id&gt;
#   &lt;/contributor&gt;
#   &lt;contributor&gt;
#     &lt;id&gt;4404&lt;/id&gt;
#     &lt;name&gt;David Heinemeier Hansson&lt;/name&gt;
#     &lt;rank&gt;2&lt;/rank&gt;
#     &lt;url-id&gt;david-heinemeier-hansson&lt;/url-id&gt;
#   &lt;/contributor&gt;
# &lt;/contributors&gt;

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/conversions.rb</code>です。</p></div><h4 id="ラッピング"><a href="#%E3%83%A9%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0">10.5 ラッピング</a></h4><p><code>Array.wrap</code>メソッドは、配列の中にある引数が配列 (または配列のようなもの) になっていない場合に、それらを配列の中にラップします。</p><p>特徴:</p>
<ul>
<li>引数が<code>nil</code>の場合、空の配列が返されます。</li>
<li>上記以外の場合で、引数が<code>to_ary</code>に応答する場合は<code>to_ary</code>が呼び出され、<code>to_ary</code>の値が<code>nil</code>でない場合はその値が返されます。</li>
<li>上記以外の場合、引数を内側に含んだ配列 (要素が1つだけの配列) が返されます。</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Array.wrap(nil)       # =&gt; []
Array.wrap([1, 2, 3]) # =&gt; [1, 2, 3]
Array.wrap(0)         # =&gt; [0]

</pre>
</div>
<p>このメソッドの目的は<code>Kernel#Array</code>と似ていますが、いくつかの相違点があります。</p>
<ul>
<li>引数が<code>to_ary</code>に応答する場合、このメソッドが呼び出されます。<code>nil</code>が返された場合、<code>Kernel#Array</code>は<code>to_a</code>を適用しようと動作を続けますが、<code>Array.wrap</code>はその場で、引数を単一の要素として持つ配列を返します。</li>
<li>
<code>to_ary</code>から返された値が<code>nil</code>でも<code>Array</code>オブジェクトでもない場合、<code>Kernel#Array</code>は例外を発生しますが、<code>Array.wrap</code>は例外を発生せずに単にその値を返します。</li>
<li>このメソッドは引数に対して<code>to_a</code>を呼び出しませんが、この引数が +to_ary+ に応答しない場合、引数を単一の要素として持つ配列を返します。</li>
</ul>
<p>最後の性質は、列挙型同士を比較する場合に特に便利です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Array.wrap(foo: :bar) # =&gt; [{:foo=&gt;:bar}]
Array(foo: :bar)      # =&gt; [[:foo, :bar]]

</pre>
</div>
<p>この動作は、スプラット演算子を使用する手法にも関連します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[*object]

</pre>
</div>
<p>上はRuby 1.8の場合、<code>nil</code>に対して<code>[nil]</code>を返し、それ以外の場合には<code>Array(object)</code>を呼び出します(1.9のcontact機能の正確な動作を理解していることが前提です)。</p><p>従って、この場合<code>nil</code>に対する動作は異なり、上で説明されている<code>Kernel#Array</code>についてもこの異なる動作が残りの<code>object</code>に適用されます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/wrap.rb</code>です。</p></div><h4 id="複製"><a href="#%E8%A4%87%E8%A3%BD">10.6 複製</a></h4><p><code>Array.deep_dup</code>メソッドは、自分自身を複製すると同時に、その中のすべてのオブジェクトをActive Supportの<code>Object#deep_dup</code>メソッドによって再帰的に複製します。この動作は、<code>Array#map</code>を使用して<code>deep_dup</code>メソッドを内部の各オブジェクトに適用するのと似ています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
array = [1, [2, 3]]
dup = array.deep_dup
dup[1][2] = 4
array[1][2] == nil   # =&gt; true

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/deep_dup.rb</code>です。</p></div><h4 id="グループ化"><a href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96">10.7 グループ化</a></h4><h5 id="in-groups-of-number-fill-with-nil"><a href="#in-groups-of-number-fill-with-nil">10.7.1 <code>in_groups_of(number, fill_with = nil)</code></a></h5><p><code>in_groups_of</code>メソッドは、指定のサイズで配列を連続したグループに分割します。分割されたグループを内包する配列を1つ返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[1, 2, 3].in_groups_of(2) # =&gt; [[1, 2], [3, nil]]

</pre>
</div>
<p>ブロックが渡された場合はyieldします。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;% sample.in_groups_of(3) do |a, b, c| %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= a %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= b %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= c %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;

</pre>
</div>
<p>最初の例では、<code>in_groups_of</code>メソッドは最後のグループをなるべく<code>nil</code>要素で埋め、指定のサイズを満たすようにしています。空きを埋める値は2番目のオプション引数で指定できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[1, 2, 3].in_groups_of(2, 0) # =&gt; [[1, 2], [3, 0]]

</pre>
</div>
<p>2番目のオプション引数に<code>false</code>を渡すと、最後のグループの空きは詰められます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[1, 2, 3].in_groups_of(2, false) # =&gt; [[1, 2], [3]]

</pre>
</div>
<p>従って、<code>false</code>は空きを埋める値としては使用できません。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/grouping.rb</code>です。</p></div><h5 id="in-groups-number-fill-with-nil"><a href="#in-groups-number-fill-with-nil">10.7.2 <code>in_groups(number, fill_with = nil)</code></a></h5><p><code>in_groups</code>は、配列を指定の個数のグループに分割します。分割されたグループを内包する配列を1つ返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(1 2 3 4 5 6 7).in_groups(3)
# =&gt; [["1", "2", "3"], ["4", "5", nil], ["6", "7", nil]]

</pre>
</div>
<p>ブロックが渡された場合はyieldします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(1 2 3 4 5 6 7).in_groups(3) {|group| p group}
["1", "2", "3"]
["4", "5", nil]
["6", "7", nil]

</pre>
</div>
<p>この例では、<code>in_groups</code>メソッドは一部のグループの後ろを必要に応じて<code>nil</code>要素で埋めているのがわかります。1つのグループには、このような余分な要素がグループの一番右側に必要に応じて最大で1つ置かれる可能性があります。また、そのような値を持つグループは、常に全体の中で最後のグループになります。</p><p>空きを埋める値は2番目のオプション引数で指定できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(1 2 3 4 5 6 7).in_groups(3, "0")
# =&gt; [["1", "2", "3"], ["4", "5", "0"], ["6", "7", "0"]]

</pre>
</div>
<p>2番目のオプション引数に<code>false</code>を渡すと、要素の個数の少ないグループの空きは詰められます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(1 2 3 4 5 6 7).in_groups(3, false)
# =&gt; [["1", "2", "3"], ["4", "5"], ["6", "7"]]

</pre>
</div>
<p>従って、<code>false</code>は空きを埋める値としては使用できません。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/grouping.rb</code>です。</p></div><h5 id="split-value-nil"><a href="#split-value-nil">10.7.3 <code>split(value = nil)</code></a></h5><p><code>split</code>メソッドは、指定のセパレータで配列を分割し、分割されたチャンクを返します。</p><p>ブロックを渡した場合、配列の要素のうちブロックがtrueを返す要素がセパレータとして使用されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(-5..5).to_a.split { |i| i.multiple_of?(4) }
# =&gt; [[-5], [-3, -2, -1], [1, 2, 3], [5]]

</pre>
</div>
<p>ブロックを渡さない場合、引数として受け取った値がセパレータとして使用されます。デフォルトのセパレータは<code>nil</code>です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[0, 1, -5, 1, 1, "foo", "bar"].split(1)
# =&gt; [[0], [-5], [], ["foo", "bar"]]

</pre>
</div>
<div class="info"><p>上の例からもわかるように、セパレータが連続すると空の配列になります。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/array/grouping.rb</code>です。</p></div><h3 id="hashの拡張"><a href="#hash%E3%81%AE%E6%8B%A1%E5%BC%B5">11 <code>Hash</code>の拡張</a></h3><h4 id="hashの拡張-各種変換"><a href="#hash%E3%81%AE%E6%8B%A1%E5%BC%B5-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">11.1 各種変換</a></h4><h5 id="hashの拡張-各種変換-to-xml"><a href="#hash%E3%81%AE%E6%8B%A1%E5%BC%B5-%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B-to-xml">11.1.1 <code>to_xml</code></a></h5><p><code>to_xml</code>メソッドは、レシーバをXML表現に変換したものを含む文字列を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{"foo" =&gt; 1, "bar" =&gt; 2}.to_xml
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;hash&gt;
#   &lt;foo type="integer"&gt;1&lt;/foo&gt;
#   &lt;bar type="integer"&gt;2&lt;/bar&gt;
# &lt;/hash&gt;

</pre>
</div>
<p>具体的には、このメソッドは与えられたペアから <em>値</em> に応じてノードを作成します。キーと値のペアが与えられたとき、以下のように動作します。</p>
<ul>
<li><p>値がハッシュのとき、キーを<code>:root</code>として再帰的な呼び出しを行います。</p></li>
<li><p>値が配列の場合、キーを<code>:root</code>に、キーを単数形化 (singularize) したものを<code>:children</code>に指定して再帰的な呼び出しを行います。</p></li>
<li><p>値が呼び出し可能な (callable) オブジェクトの場合、引数が1つまたは2つ必要です。引数の数に応じて (arityメソッドで確認)、呼び出し可能オブジェクトを呼び出します。第1引数には<code>:root</code>にキーを指定したもの、第2引数にはキーを単数形化したものが使用されます。戻り値は新しいノードです。</p></li>
<li><p><code>value</code>が<code>to_xml</code>メソッドに応答する場合、<code>:root</code>にキーが指定されます。</p></li>
<li><p>その他の場合、<code>key</code>を持ち、ノードがタグとして作成されます。そのノードには<code>value</code>を文字列形式にしたものがテキストノードとして追加されます。<code>value</code>が<code>nil</code>の場合、"nil"属性が"true"に設定されたものが追加されます。<code>:skip_types</code>オプションがtrueでない (または<code>:skip_types</code>オプションがない) 場合、以下のようなマッピングで"type"属性も追加されます。</p></li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
XML_TYPE_NAMES = {
  "Symbol"     =&gt; "symbol",
  "Fixnum"     =&gt; "integer",
  "Bignum"     =&gt; "integer",
  "BigDecimal" =&gt; "decimal",
  "Float"      =&gt; "float",
  "TrueClass"  =&gt; "boolean",
  "FalseClass" =&gt; "boolean",
  "Date"       =&gt; "date",
  "DateTime"   =&gt; "datetime",
  "Time"       =&gt; "datetime"
}

</pre>
</div>
<p>デフォルトではルートノードは"hash"ですが、<code>:root</code>オプションを使用してカスタマイズできます。</p><p>デフォルトのXMLビルダは、<code>Builder::XmlMarkup</code>から直接生成されたインスタンスです。<code>:builder</code>オブションを使用することで、独自のビルダを構成できます。このメソッドでは<code>:dasherize</code>とその同族と同様のオプションが使用できます。それらのオプションはビルダに転送されます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/conversions.rb</code>です。</p></div><h4 id="マージ"><a href="#%E3%83%9E%E3%83%BC%E3%82%B8">11.2 マージ</a></h4><p>Rubyには、2つのハッシュをマージするビルトインの<code>Hash#merge</code>メソッドがあります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 1}.merge(a: 0, c: 2)
# =&gt; {:a=&gt;0, :b=&gt;1, :c=&gt;2}

</pre>
</div>
<p>Active Supportでは、この他にも便利なハッシュのマージをいくつか提供しています。</p><h5 id="reverse-mergeとreverse-merge-bang"><a href="#reverse-merge%E3%81%A8reverse-merge-bang">11.2.1 <code>reverse_merge</code>と<code>reverse_merge!</code></a></h5><p>キーが衝突した場合、引数のハッシュのキーが<code>merge</code>では優先されます。以下のような定形の手法を使用することで、デフォルト値を持つオプションハッシュをコンパクトにサポートできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
options = {length: 30, omission: "..."}.merge(options)

</pre>
</div>
<p>Active Supportでは、別の記法を使いたい場合のために<code>reverse_merge</code>も定義されています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
options = options.reverse_merge(length: 30, omission: "...")

</pre>
</div>
<p>マージを対象内で行なう破壊的なバージョンの<code>reverse_merge!</code>もあります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
options.reverse_merge!(length: 30, omission: "...")

</pre>
</div>
<div class="warning"><p><code>reverse_merge!</code>は呼び出し元のハッシュを変更する可能性があることにご注意ください。それが意図した副作用であるかそうでないかにかかわらず、注意が必要です。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/reverse_merge.rb</code>です。</p></div><h5 id="reverse-update"><a href="#reverse-update">11.2.2 <code>reverse_update</code></a></h5><p><code>reverse_update</code>メソッドは、上で説明した<code>reverse_merge!</code>の別名です。</p><p>WARN: <code>reverse_update</code>には破壊的なバージョンはありません。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/reverse_merge.rb</code>です。</p></div><h5 id="deep-mergeとdeep-merge-bang"><a href="#deep-merge%E3%81%A8deep-merge-bang">11.2.3 <code>deep_merge</code>と<code>deep_merge!</code></a></h5><p>先の例で説明したとおり、キーがレシーバと引数で重複している場合、引数の側の値が優先されます。</p><p>Active Supportでは<code>Hash#deep_merge</code>が定義されています。ディープマージでは、レシーバと引数の両方に同じキーが出現し、さらにどちらも値がハッシュである場合に、その下位のハッシュを <em>マージ</em> したものが、最終的なハッシュで値として使用されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: {b: 1}}.deep_merge(a: {c: 2})
# =&gt; {:a=&gt;{:b=&gt;1, :c=&gt;2}}

</pre>
</div>
<p><code>deep_merge!</code>メソッドはディープマージを破壊的に実行します。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/deep_merge.rb</code>です。</p></div><h4 id="ディープ複製"><a href="#%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E8%A4%87%E8%A3%BD">11.3 ディープ複製</a></h4><p><code>Hash.deep_dup</code>メソッドは、自分自身の複製に加えて その中のすべてのキーと値を再帰的に複製します。複製にはActive Supportの<code>Object#deep_dup</code>メソッドを使用しています。この動作は、<code>Enumerator#each_with_object</code>を使用して下位のすべてのオブジェクトに<code>deep_dup</code>を送信するのと似ています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
hash = { a: 1, b: { c: 2, d: [3, 4] } }

dup = hash.deep_dup
dup[:b][:e] = 5
dup[:b][:d] &lt;&lt; 5

hash[:b][:e] == nil      # =&gt; true
hash[:b][:d] == [3, 4]   # =&gt; true

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/object/deep_dup.rb</code>です。</p></div><h4 id="ハッシュキーの操作"><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AD%E3%83%BC%E3%81%AE%E6%93%8D%E4%BD%9C">11.4 ハッシュキーの操作</a></h4><h5 id="exceptとexcept-bang"><a href="#except%E3%81%A8except-bang">11.4.1 <code>except</code>と<code>except!</code></a></h5><p><code>except</code>メソッドは、引数で指定されたキーがあればレシーバのハッシュから取り除きます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 2}.except(:a) # =&gt; {:b=&gt;2}

</pre>
</div>
<p>レシーバが<code>convert_key</code>に応答する場合、このメソッドはすべての引数に対して呼び出されます。そのおかげで、<code>except</code>メソッドはたとえばwith_indifferent_accessなどで期待どおりに動作します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1}.with_indifferent_access.except(:a)  # =&gt; {}
{a: 1}.with_indifferent_access.except("a") # =&gt; {}

</pre>
</div>
<p>レシーバーからキーを取り除く破壊的な<code>except!</code>もあります。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/except.rb</code>です。</p></div><h5 id="transform-keysとtransform-keys-bang"><a href="#transform-keys%E3%81%A8transform-keys-bang">11.4.2 <code>transform_keys</code>と<code>transform_keys!</code></a></h5><p><code>transform_keys</code>メソッドは、ブロックを1つ取り、ハッシュを1つ返します。返されるハッシュには、レシーバのそれぞれのキーに対してブロック操作を適用した結果が含まれます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, a: :a}.transform_keys { |key| key.to_s.upcase }
# =&gt; {"" =&gt; nil, "A" =&gt; :a, "1" =&gt; 1}

</pre>
</div>
<p>キーが重複している場合、いずれかの値が優先されます。優先される値は、同じハッシュが与えられた場合であっても一定する保証はありません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{"a" =&gt; 1, a: 2}.transform_keys { |key| key.to_s.upcase }
# 以下のどちらになるかは一定ではない
# =&gt; {"A"=&gt;2}
# または
# =&gt; {"A"=&gt;1}

</pre>
</div>
<p>このメソッドは、特殊な変換を行いたい場合に便利なことがあります。たとえば、<code>stringify_keys</code>と<code>symbolize_keys</code>では、キーの変換に<code>transform_keys</code>を使用しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def stringify_keys
  transform_keys { |key| key.to_s }
end
...
def symbolize_keys
  transform_keys { |key| key.to_sym rescue key }
end

</pre>
</div>
<p>レシーバ自体のキーに対して破壊的なブロック操作を適用する<code>transform_keys!</code>メソッドもあります。</p><p>また、<code>deep_transform_keys</code>や<code>deep_transform_keys!</code>を使用して、与えられたハッシュのすべてのキーと、その中にネストされているすべてのハッシュに対してブロック操作を適用することもできます。以下に例を示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, nested: {a: 3, 5 =&gt; 5}}.deep_transform_keys { |key| key.to_s.upcase }
# =&gt; {""=&gt;nil, "1"=&gt;1, "NESTED"=&gt;{"A"=&gt;3, "5"=&gt;5}}

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/keys.rb</code>です。</p></div><h5 id="stringify-keysとstringify-keys-bang"><a href="#stringify-keys%E3%81%A8stringify-keys-bang">11.4.3 <code>stringify_keys</code>と<code>stringify_keys!</code></a></h5><p><code>stringify_keys</code>メソッドは、レシーバのハッシュキーを文字列に変換したハッシュを返します。具体的には、レシーバのハッシュキーに対して<code>to_s</code>を送信しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, a: :a}.stringify_keys
# =&gt; {"" =&gt; nil, "a" =&gt; :a, "1" =&gt; 1}

</pre>
</div>
<p>キーが重複している場合、いずれかの値が優先されます。優先される値は、同じハッシュが与えられた場合であっても一定する保証はありません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{"a" =&gt; 1, a: 2}.stringify_keys
# 以下のどちらになるかは一定ではない
# =&gt; {"a"=&gt;2}
# または
# =&gt; {"a"=&gt;1}

</pre>
</div>
<p>このメソッドは、シンボルと文字列が両方含まれているハッシュをオプションとして受け取る場合に便利なことがあります。たとえば、<code>ActionView::Helpers::FormHelper</code>では以下のように定義されています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def to_check_box_tag(options = {}, checked_value = "1", unchecked_value = "0")
  options = options.stringify_keys
  options["type"] = "checkbox"
  ...
end

</pre>
</div>
<p>stringify_keysメソッドのおかげで、2行目で"type"キーに安全にアクセスできます。メソッドの利用者は、<code>:type</code>のようなシンボルと"type"のような文字列のどちらでも使用できます。</p><p>レシーバーのキーを直接文字列化する破壊的な<code>stringify_keys!</code>もあります。</p><p>また、<code>deep_stringify_keys</code>や<code>deep_stringify_keys!</code>を使用して、与えられたハッシュのすべてのキーを文字列化し、その中にネストされているすべてのハッシュのキーも文字列化することもできます。以下に例を示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, nested: {a: 3, 5 =&gt; 5}}.deep_stringify_keys
# =&gt; {""=&gt;nil, "1"=&gt;1, "nested"=&gt;{"a"=&gt;3, "5"=&gt;5}}

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/keys.rb</code>です。</p></div><h5 id="symbolize-keysとsymbolize-keys-bang"><a href="#symbolize-keys%E3%81%A8symbolize-keys-bang">11.4.4 <code>symbolize_keys</code>と<code>symbolize_keys!</code></a></h5><p><code>symbolize_keys</code>メソッドは、レシーバのハッシュキーをシンボルに変換したハッシュを返します。具体的には、レシーバのハッシュキーに対して<code>to_sym</code>を送信しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, "a" =&gt; "a"}.symbolize_keys
# =&gt; {1=&gt;1, nil=&gt;nil, :a=&gt;"a"}

</pre>
</div>
<div class="warning"><p>上の例では、3つのキーのうち最後の1つしかシンボルに変換されていないことにご注意ください。数字とnilはシンボルになりません。</p></div><p>キーが重複している場合、いずれかの値が優先されます。優先される値は、同じハッシュが与えられた場合であっても一定する保証はありません。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{"a" =&gt; 1, a: 2}.symbolize_keys
# 以下のどちらになるかは一定ではない
# =&gt; {:a=&gt;2}
# または
# =&gt; {:a=&gt;1}

</pre>
</div>
<p>このメソッドは、シンボルと文字列が両方含まれているハッシュをオプションとして受け取る場合に便利なことがあります。たとえば、<code>ActionController::UrlRewriter</code>では以下のように定義されています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def rewrite_path(options)
  options = options.symbolize_keys
  options.update(options[:params].symbolize_keys) if options[:params]
  ...
end

</pre>
</div>
<p>symbolize_keysメソッドのおかげで、2行目で<code>:params</code>キーに安全にアクセスできています。メソッドの利用者は、<code>:params</code>のようなシンボルと"params"のような文字列のどちらでも使用できます。</p><p>レシーバーのキーを直接シンボルに変換する破壊的な<code>symbolize_keys!</code>もあります。</p><p>また、<code>deep_symbolize_keys</code>や<code>deep_symbolize_keys!</code>を使用して、与えられたハッシュのすべてのキーと、その中にネストされているすべてのハッシュのキーをシンボルに変換することもできます。以下に例を示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, "nested" =&gt; {"a" =&gt; 3, 5 =&gt; 5}}.deep_symbolize_keys
# =&gt; {nil=&gt;nil, 1=&gt;1, nested:{a:3, 5=&gt;5}}

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/keys.rb</code>です。</p></div><h5 id="to-optionsとto-options-bang"><a href="#to-options%E3%81%A8to-options-bang">11.4.5 <code>to_options</code>と<code>to_options!</code></a></h5><p><code>to_options</code>メソッドと<code>to_options!</code>メソッドは、それそれ<code>symbolize_keys</code>メソッドと<code>symbolize_keys!</code>メソッドの別名です。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/keys.rb</code>です。</p></div><h5 id="assert-valid-keys"><a href="#assert-valid-keys">11.4.6 <code>assert_valid_keys</code></a></h5><p><code>assert_valid_keys</code>メソッドは任意の数の引数を取ることができ、ホワイトリストに含まれていないキーがレシーバにあるかどうかをチェックします。そのようなキーが見つかった場合、<code>ArgumentError</code>が発生します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1}.assert_valid_keys(:a)  # パスする
{a: 1}.assert_valid_keys("a") # ArgumentError

</pre>
</div>
<p>Active Recordは、たとえば関連付けが行われている場合に未知のオプションを受け付けません。このメソッドでは、<code>assert_valid_keys</code>を使用した制御を実装しています。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/keys.rb</code>です。</p></div><h4 id="値の操作"><a href="#%E5%80%A4%E3%81%AE%E6%93%8D%E4%BD%9C">11.5 値の操作</a></h4><h5 id="transform-valuesとtransform-values-bang"><a href="#transform-values%E3%81%A8transform-values-bang">11.5.1 <code>transform_values</code>と<code>transform_values!</code></a></h5><p><code>transform_values</code>メソッドは、ブロックを1つ取り、ハッシュを1つ返します。返されるハッシュには、レシーバのそれぞれの値に対してブロック操作を適用した結果が含まれます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{ nil =&gt; nil, 1 =&gt; 1, :x =&gt; :a }.transform_values { |value| value.to_s.upcase }
# =&gt; {nil=&gt;"", 1=&gt;"1", :x=&gt;"A"}

</pre>
</div>
<p>レシーバ自体のキーに対して破壊的なブロック操作を適用する<code>transform_values!</code>メソッドもあります。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/transform_values.rb</code>です。</p></div><h4 id="スライス"><a href="#%E3%82%B9%E3%83%A9%E3%82%A4%E3%82%B9">11.6 スライス</a></h4><p>Rubyには、文字列や配列をスライスして一部を取り出すビルトインのメソッドをサポートしています。Active Supportでは、スライス操作をハッシュに対して拡張しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 2, c: 3}.slice(:a, :c)
# =&gt; {:c=&gt;3, :a=&gt;1}

{a: 1, b: 2, c: 3}.slice(:b, :X)
# =&gt; {:b=&gt;2} # 存在しないキーは無視される

</pre>
</div>
<p>レシーバが<code>convert_key</code>に応答する場合、キーは正規化されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 2}.with_indifferent_access.slice("a")
# =&gt; {:a=&gt;1}

</pre>
</div>
<div class="note"><p>スライス処理は、キーのホワイトリストを使用してオプションハッシュをサニタイズするのに便利です。</p></div><p>破壊的なスライス操作を行なう<code>slice!</code>メソッドもあります。戻り値は、取り除かれた要素です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
hash = {a: 1, b: 2}
rest = hash.slice!(:a) # =&gt; {:b=&gt;2}
hash                   # =&gt; {:a=&gt;1}

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/slice.rb</code>です。</p></div><h4 id="抽出"><a href="#%E6%8A%BD%E5%87%BA">11.7 抽出</a></h4><p><code>extract!</code>メソッドは、与えられたキーにマッチするキー/値ペアを取り除き、取り除いたペアを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
hash = {a: 1, b: 2}
rest = hash.extract!(:a) # =&gt; {:a=&gt;1}
hash                     # =&gt; {:b=&gt;2}

</pre>
</div>
<p><code>extract!</code>メソッドは、レシーバのハッシュのサブクラスと同じサブクラスを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
hash = {a: 1, b: 2}.with_indifferent_access
rest = hash.extract!(:a).class
# =&gt; ActiveSupport::HashWithIndifferentAccess

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/slice.rb</code>です。</p></div><h4 id="ハッシュキーがシンボルでも文字列でも同様に扱う-indifferent-access"><a href="#%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AD%E3%83%BC%E3%81%8C%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%81%A7%E3%82%82%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E3%82%82%E5%90%8C%E6%A7%98%E3%81%AB%E6%89%B1%E3%81%86-indifferent-access">11.8 ハッシュキーがシンボルでも文字列でも同様に扱う (indifferent access)</a></h4><p><code>with_indifferent_access</code>メソッドは、レシーバに対して<code>ActiveSupport::HashWithIndifferentAccess</code>を実行した結果を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1}.with_indifferent_access["a"] # =&gt; 1

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/indifferent_access.rb</code>です。</p></div><h4 id="コンパクト化"><a href="#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%AF%E3%83%88%E5%8C%96">11.9 コンパクト化</a></h4><p><code>compact</code>メソッドと<code>compact!</code>メソッドは、ハッシュから<code>nil</code>値を除外したものを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 2, c: nil}.compact # =&gt; {a: 1, b: 2}

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/hash/compact.rb</code>です。</p></div><h3 id="regexpの拡張"><a href="#regexp%E3%81%AE%E6%8B%A1%E5%BC%B5">12 <code>Regexp</code>の拡張</a></h3><h4 id="multiline-questionmark"><a href="#multiline-questionmark">12.1 <code>multiline?</code></a></h4><p><code>multiline?</code>メソッドは、正規表現に<code>/m</code>フラグが設定されているかどうかをチェックします。このフラグが設定されていると、ドット (.) が改行にマッチし、複数行を扱えるようになります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%r{.}.multiline? # =&gt; false
%r{.}m.multiline? # =&gt; true

Regexp.new('.').multiline?                    # =&gt; false
Regexp.new('.', Regexp::MULTILINE).multiline? # =&gt; true

</pre>
</div>
<p>Railsはこのメソッドをある場所で使用しており、ルーティングコードでも使用しています。ルーティングでは正規表現で複数行を扱うことを許していないので、このフラグを使用して制限を加えています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def assign_route_options(segments, defaults, requirements)
  ...
  if requirement.multiline?
    raise ArgumentError, "Regexp multiline option not allowed in routing requirements: #{requirement.inspect}"
  end
  ...
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/regexp.rb</code>です。</p></div><h3 id="rangeの拡張"><a href="#range%E3%81%AE%E6%8B%A1%E5%BC%B5">13 <code>Range</code>の拡張</a></h3><h4 id="rangeの拡張-to-s"><a href="#range%E3%81%AE%E6%8B%A1%E5%BC%B5-to-s">13.1 <code>to_s</code></a></h4><p>Active Supportは<code>Range#to_s</code>メソッドを拡張してフォーマット引数をオプションで受け付けるようにしています。執筆時点では、デフォルトでないフォーマットとしてサポートされているのは<code>:db</code>のみです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(Date.today..Date.tomorrow).to_s
# =&gt; "2009-10-25..2009-10-26"

(Date.today..Date.tomorrow).to_s(:db)
# =&gt; "BETWEEN '2009-10-25' AND '2009-10-26'"

</pre>
</div>
<p>上の例でもわかるように、フォーマットに<code>:db</code>を指定するとSQLの<code>BETWEEN</code>句が生成されます。このフォーマットは、Active Recordで条件の値の範囲をサポートするときに使用されています。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/range/conversions.rb</code>です。</p></div><h4 id="include-questionmark"><a href="#include-questionmark">13.2 <code>include?</code></a></h4><p><code>Range#include?</code>メソッドと<code>Range#===</code>メソッドは、与えられたインスタンスの範囲内に値が収まっているかどうかをチェックします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(2..3).include?(Math::E) # =&gt; true

</pre>
</div>
<p>Active Supportではこれらのメソッドを拡張して、他の範囲指定を引数で指定できるようにしています。この場合、引数の範囲がレシーバの範囲の中に収まっているかどうかがチェックされています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(1..10).include?(3..7)  # =&gt; true
(1..10).include?(0..7)  # =&gt; false
(1..10).include?(3..11) # =&gt; false
(1...9).include?(3..9)  # =&gt; false

(1..10) === (3..7)  # =&gt; true
(1..10) === (0..7)  # =&gt; false
(1..10) === (3..11) # =&gt; false
(1...9) === (3..9)  # =&gt; false

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/range/include_range.rb</code>です。</p></div><h4 id="overlaps-questionmark"><a href="#overlaps-questionmark">13.3 <code>overlaps?</code></a></h4><p><code>Range#overlaps?</code>メソッドは、与えられた2つの範囲に(空白でない)重なりがあるかどうかをチェックします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(1..10).overlaps?(7..11)  # =&gt; true
(1..10).overlaps?(0..7)   # =&gt; true
(1..10).overlaps?(11..27) # =&gt; false

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/range/overlaps.rb</code>です。</p></div><h3 id="dateの拡張"><a href="#date%E3%81%AE%E6%8B%A1%E5%BC%B5">14 <code>Date</code>の拡張</a></h3><h4 id="dateの拡張-計算"><a href="#date%E3%81%AE%E6%8B%A1%E5%BC%B5-%E8%A8%88%E7%AE%97">14.1 計算</a></h4><div class="note"><p>これらはすべて同じ定義ファイル<code>active_support/core_ext/date/calculations.rb</code>にあります。</p></div><div class="info"><p>以下の計算方法の一部では1582年10月を極端な例として使用しています。この月にユリウス暦からグレゴリオ暦への切り替えが行われたため、10月5日から10月14日までが存在しません。本ガイドはこの特殊な月について長々と解説することはしませんが、メソッドがこの月でも期待どおりに動作することについては説明しておきたいと思います。具体的には、たとえば<code>Date.new(1582, 10, 4).tomorrow</code>を実行すると<code>Date.new(1582, 10, 15)</code>が返されます。期待どおりに動作することは、Active Supportの<code>test/core_ext/date_ext_test.rb</code>用のテストスイートで確認できます。</p></div><h5 id="date-current"><a href="#date-current">14.1.1 <code>Date.current</code></a></h5><p>Active Supportでは、<code>Date.current</code>を定義して現在のタイムゾーンにおける「今日」を定めています。このメソッドは<code>Date.today</code>と似ていますが、ユーザー定義のタイムゾーンがある場合にそれを考慮する点が異なります。Active Supportでは<code>Date.yesterday</code>メソッドと<code>Date.tomorrow</code>も定義しています。インスタンスでは<code>past?</code>、<code>today?</code>、<code>future?</code>を使用でき、これらはすべて<code>Date.current</code>を起点として導かれます。</p><p>ユーザー定義のタイムゾーンを考慮するメソッドを使用して日付を比較したい場合、<code>Date.today</code>ではなく必ず<code>Date.current</code>を使用してください。将来、ユーザー定義のタイムゾーンがシステムのタイムゾーンと比較されることがありえます。システムのタイムゾーンではデフォルトで<code>Date.today</code>が使用されます。つまり、<code>Date.today</code>が<code>Date.yesterday</code>と等しくなることがありえるということです。</p><h5 id="名前付き日付"><a href="#%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E6%97%A5%E4%BB%98">14.1.2 名前付き日付</a></h5><h6 id="prev-year、next-year"><a href="#prev-year%E3%80%81next-year">14.1.2.1 <code>prev_year</code>、<code>next_year</code></a></h6><p>Ruby 1.9の<code>prev_year</code>メソッドと<code>next_year</code>メソッドは、それぞれ昨年と来年の同じ日と月を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 8) # =&gt; Sat, 08 May 2010
d.prev_year              # =&gt; Fri, 08 May 2009
d.next_year              # =&gt; Sun, 08 May 2011

</pre>
</div>
<p>うるう年の2月29日の場合、昨年と来年の日付はいずれも2月28日になります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2000, 2, 29) # =&gt; Tue, 29 Feb 2000
d.prev_year               # =&gt; Sun, 28 Feb 1999
d.next_year               # =&gt; Wed, 28 Feb 2001

</pre>
</div>
<p><code>prev_year</code>は<code>last_year</code>の別名です。</p><h6 id="prev-month、next-month"><a href="#prev-month%E3%80%81next-month">14.1.2.2 <code>prev_month</code>、<code>next_month</code></a></h6><p>Ruby 1.9の<code>prev_month</code>メソッドと<code>next_month</code>メソッドは、それぞれ先月と翌月の同じ日を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 8) # =&gt; Sat, 08 May 2010
d.prev_month             # =&gt; Thu, 08 Apr 2010
d.next_month             # =&gt; Tue, 08 Jun 2010

</pre>
</div>
<p>同じ日が行き先の月にない場合、その月の最後の日が返されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2000, 5, 31).prev_month # =&gt; Sun, 30 Apr 2000
Date.new(2000, 3, 31).prev_month # =&gt; Tue, 29 Feb 2000
Date.new(2000, 5, 31).next_month # =&gt; Fri, 30 Jun 2000
Date.new(2000, 1, 31).next_month # =&gt; Tue, 29 Feb 2000

</pre>
</div>
<p><code>prev_month</code>は<code>last_month</code>の別名です。</p><h6 id="prev-quarter、next-quarter"><a href="#prev-quarter%E3%80%81next-quarter">14.1.2.3 <code>prev_quarter</code>、<code>next_quarter</code></a></h6><p><code>prev_month</code>および<code>next_month</code>と基本的に同じ要領で動作します。前四半期または来四半期の同じ日の日付を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
t = Time.local(2010, 5, 8) # =&gt; Sat, 08 May 2010
t.prev_quarter             # =&gt; Mon, 08 Feb 2010
t.next_quarter             # =&gt; Sun, 08 Aug 2010

</pre>
</div>
<p>同じ日が行き先の月にない場合、その月の最後の日が返されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Time.local(2000, 7, 31).prev_quarter  # =&gt; Sun, 30 Apr 2000
Time.local(2000, 5, 31).prev_quarter  # =&gt; Tue, 29 Feb 2000
Time.local(2000, 10, 31).prev_quarter # =&gt; Mon, 30 Oct 2000
Time.local(2000, 11, 31).next_quarter # =&gt; Wed, 28 Feb 2001

</pre>
</div>
<p><code>prev_quarter</code>は<code>last_quarter</code>の別名です。</p><h6 id="beginning-of-week、end-of-week"><a href="#beginning-of-week%E3%80%81end-of-week">14.1.2.4 <code>beginning_of_week</code>、<code>end_of_week</code></a></h6><p><code>beginning_of_week</code>メソッドと<code>end_of_week</code>メソッドは、それぞれ週の最初の日付と週の最後の日付を返します。週の始まりはデフォルトでは月曜日ですが、引数を渡して変更できます。そのときにスレッドローカルの<code>Date.beginning_of_week</code>または<code>config.beginning_of_week</code>を設定します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 8)     # =&gt; Sat, 08 May 2010
d.beginning_of_week          # =&gt; Mon, 03 May 2010
d.beginning_of_week(:sunday) # =&gt; Sun, 02 May 2010
d.end_of_week                # =&gt; Sun, 09 May 2010
d.end_of_week(:sunday)       # =&gt; Sat, 08 May 2010

</pre>
</div>
<p><code>beginning_of_week</code>は<code>at_beginning_of_week</code>の別名、<code>end_of_week</code>は<code>at_end_of_week</code>の別名です。</p><h6 id="monday、sunday"><a href="#monday%E3%80%81sunday">14.1.2.5 <code>monday</code>、<code>sunday</code></a></h6><p><code>monday</code>メソッドと<code>sunday</code>メソッドは、それぞれ前の月曜、次の日曜をそれぞれ返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 8)     # =&gt; Sat, 08 May 2010
d.monday                     # =&gt; Mon, 03 May 2010
d.sunday                     # =&gt; Sun, 09 May 2010

d = Date.new(2012, 9, 10)    # =&gt; Mon, 10 Sep 2012
d.monday                     # =&gt; Mon, 10 Sep 2012

d = Date.new(2012, 9, 16)    # =&gt; Sun, 16 Sep 2012
d.sunday                     # =&gt; Sun, 16 Sep 2012

</pre>
</div>
<h6 id="prev-week、next-week"><a href="#prev-week%E3%80%81next-week">14.1.2.6 <code>prev_week</code>、<code>next_week</code></a></h6><p><code>next_week</code>メソッドは、英語表記 (デフォルトではスレッドローカルの<code>Date.beginning_of_week</code>または<code>config.beginning_of_week</code>または<code>:monday</code>) の日付名のシンボルを受け取り、それに対応する日付を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 9) # =&gt; Sun, 09 May 2010
d.next_week              # =&gt; Mon, 10 May 2010
d.next_week(:saturday)   # =&gt; Sat, 15 May 2010

</pre>
</div>
<p><code>prev_week</code>も同様です。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d.prev_week              # =&gt; Mon, 26 Apr 2010
d.prev_week(:saturday)   # =&gt; Sat, 01 May 2010
d.prev_week(:friday)     # =&gt; Fri, 30 Apr 2010

</pre>
</div>
<p><code>prev_week</code>は<code>last_week</code>の別名です。</p><p><code>Date.beginning_of_week</code>または<code>config.beginning_of_week</code>が設定されていれば、<code>next_week</code>と<code>prev_week</code>はどちらも正常に動作します。</p><h6 id="beginning-of-month、end-of-month"><a href="#beginning-of-month%E3%80%81end-of-month">14.1.2.7 <code>beginning_of_month</code>、<code>end_of_month</code></a></h6><p><code>beginning_of_month</code>メソッドと<code>end_of_month</code>メソッドは、それぞれ月の最初の日付と月の最後の日付を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 9) # =&gt; Sun, 09 May 2010
d.beginning_of_month     # =&gt; Sat, 01 May 2010
d.end_of_month           # =&gt; Mon, 31 May 2010

</pre>
</div>
<p><code>beginning_of_month</code>は<code>at_beginning_of_month</code>の別名、<code>end_of_month</code>は<code>at_end_of_month</code>の別名です。</p><h6 id="beginning-of-quarter、end-of-quarter"><a href="#beginning-of-quarter%E3%80%81end-of-quarter">14.1.2.8 <code>beginning_of_quarter</code>、<code>end_of_quarter</code></a></h6><p><code>beginning_of_quarter</code>メソッドと<code>end_of_quarter</code>メソッドは、レシーバのカレンダーの年における四半期の最初の日と最後の日をそれぞれ返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 9) # =&gt; Sun, 09 May 2010
d.beginning_of_quarter   # =&gt; Thu, 01 Apr 2010
d.end_of_quarter         # =&gt; Wed, 30 Jun 2010

</pre>
</div>
<p><code>beginning_of_quarter</code>は<code>at_beginning_of_quarter</code>の別名、<code>end_of_quarter</code>は<code>at_end_of_quarter</code>の別名です。</p><h6 id="beginning-of-year、end-of-year"><a href="#beginning-of-year%E3%80%81end-of-year">14.1.2.9 <code>beginning_of_year</code>、<code>end_of_year</code></a></h6><p><code>beginning_of_year</code>メソッドと<code>end_of_year</code>メソッドは、その年の最初の日と最後の日をそれぞれ返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 9) # =&gt; Sun, 09 May 2010
d.beginning_of_year      # =&gt; Fri, 01 Jan 2010
d.end_of_year            # =&gt; Fri, 31 Dec 2010

</pre>
</div>
<p><code>beginning_of_year</code>は<code>at_beginning_of_year</code>の別名、<code>end_of_year</code>は<code>at_end_of_year</code>の別名です。</p><h5 id="その他の日付計算メソッド"><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%97%A5%E4%BB%98%E8%A8%88%E7%AE%97%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89">14.1.3 その他の日付計算メソッド</a></h5><h6 id="years-ago、years-since"><a href="#years-ago%E3%80%81years-since">14.1.3.1 <code>years_ago</code>、<code>years_since</code></a></h6><p><code>years_ago</code>メソッドは、年数を受け取り、その年数前の同じ日付を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 7)
date.years_ago(10) # =&gt; Wed, 07 Jun 2000

</pre>
</div>
<p><code>years_since</code>も同じ要領で、その年数後の同じ日付を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 7)
date.years_since(10) # =&gt; Sun, 07 Jun 2020

</pre>
</div>
<p>同じ日が行き先の月にない場合、その月の最後の日が返されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2012, 2, 29).years_ago(3)     # =&gt; Sat, 28 Feb 2009
Date.new(2012, 2, 29).years_since(3)   # =&gt; Sat, 28 Feb 2015

</pre>
</div>
<h6 id="months-ago、months-since"><a href="#months-ago%E3%80%81months-since">14.1.3.2 <code>months_ago</code>、<code>months_since</code></a></h6><p><code>months_ago</code>メソッドと<code>months_since</code>メソッドは、上と同じ要領で月に対して行います。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 4, 30).months_ago(2)   # =&gt; Sun, 28 Feb 2010
Date.new(2010, 4, 30).months_since(2) # =&gt; Wed, 30 Jun 2010

</pre>
</div>
<p>同じ日が行き先の月にない場合、その月の最後の日が返されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 4, 30).months_ago(2)    # =&gt; Sun, 28 Feb 2010
Date.new(2009, 12, 31).months_since(2) # =&gt; Sun, 28 Feb 2010

</pre>
</div>
<h6 id="weeks-ago"><a href="#weeks-ago">14.1.3.3 <code>weeks_ago</code></a></h6><p><code>weeks_ago</code>メソッドは、同じ要領で週に対して行います。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 5, 24).weeks_ago(1)    # =&gt; Mon, 17 May 2010
Date.new(2010, 5, 24).weeks_ago(2)    # =&gt; Mon, 10 May 2010

</pre>
</div>
<h6 id="その他の日付計算メソッド-advance"><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%97%A5%E4%BB%98%E8%A8%88%E7%AE%97%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89-advance">14.1.3.4 <code>advance</code></a></h6><p>日付を移動する最も一般的な方法は<code>advance</code>メソッドを使用することです。このメソッドは<code>:years</code>、<code>:months</code>、<code>:weeks</code>、<code>:days</code>をキーに持つハッシュを受け取り、日付をできるだけ詳細な形式で、現在のキーで示されるとおりに返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 6)
date.advance(years: 1, weeks: 2)  # =&gt; Mon, 20 Jun 2011
date.advance(months: 2, days: -2) # =&gt; Wed, 04 Aug 2010

</pre>
</div>
<p>上の例にも示されているように、増分値には負の数も指定できます。</p><p>計算の順序は、最初に年を増減し、次に月、最後に日を増減します。この順序で計算していることは、特に月を計算する時に重要です。たとえば、現在が2010年2月の最後の日で、そこから1か月と1日先に進めたいとします。</p><p><code>advance</code>メソッドは最初に月を進め、それから日を進めます。それにより以下の結果を得ます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 2, 28).advance(months: 1, days: 1)
# =&gt; Sun, 29 Mar 2010

</pre>
</div>
<p>計算の順序が異なる場合、同じ結果が得られない可能性があります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 2, 28).advance(days: 1).advance(months: 1)
# =&gt; Thu, 01 Apr 2010

</pre>
</div>
<h5 id="dateの拡張-計算-要素の変更"><a href="#date%E3%81%AE%E6%8B%A1%E5%BC%B5-%E8%A8%88%E7%AE%97-%E8%A6%81%E7%B4%A0%E3%81%AE%E5%A4%89%E6%9B%B4">14.1.4 要素の変更</a></h5><p><code>change</code>メソッドは、与えられた年、月、日に応じてレシーバの日付を変更し、与えられなかった部分はそのままにしてその日付を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 12, 23).change(year: 2011, month: 11)
# =&gt; Wed, 23 Nov 2011

</pre>
</div>
<p>存在しない日付が指定されると<code>ArgumentError</code>が発生します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 1, 31).change(month: 2)
# =&gt; ArgumentError: invalid date

</pre>
</div>
<h5 id="dateの拡張-計算-期間"><a href="#date%E3%81%AE%E6%8B%A1%E5%BC%B5-%E8%A8%88%E7%AE%97-%E6%9C%9F%E9%96%93">14.1.5 期間</a></h5><p>日付に対して期間を加減算できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.current
# =&gt; Mon, 09 Aug 2010
d + 1.year
# =&gt; Tue, 09 Aug 2011
d - 3.hours
# =&gt; Sun, 08 Aug 2010 21:00:00 UTC +00:00

</pre>
</div>
<p>これらの計算は、内部で<code>since</code>メソッドや<code>advance</code>メソッドに置き換えられます。たとえば、作り直したカレンダー内で正しくジャンプできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(1582, 10, 4) + 1.day
# =&gt; Fri, 15 Oct 1582

</pre>
</div>
<h5 id="タイムスタンプ"><a href="#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%97">14.1.6 タイムスタンプ</a></h5><div class="info"><p>以下のメソッドは可能であれば<code>Time</code>オブジェクトを返し、それ以外の場合は<code>DateTime</code>を返します。ユーザーのタイムゾーンを設定しておけば配慮されます。</p></div><h6 id="beginning-of-day、end-of-day"><a href="#beginning-of-day%E3%80%81end-of-day">14.1.6.1 <code>beginning_of_day</code>、<code>end_of_day</code></a></h6><p><code>beginning_of_day</code>メソッドは、その日の開始時点 (00:00:00) のタイムスタンプを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 7)
date.beginning_of_day # =&gt; Mon Jun 07 00:00:00 +0200 2010

</pre>
</div>
<p><code>end_of_day</code>メソッドは、その日の最後の時点 (23:59:59) のタイムスタンプを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 7)
date.end_of_day # =&gt; Mon Jun 07 23:59:59 +0200 2010

</pre>
</div>
<p><code>at_beginning_of_day</code>と<code>midnight</code>と<code>at_midnight</code>は、<code>beginning_of_day</code>の別名です。</p><h6 id="beginning-of-hour、end-of-hour"><a href="#beginning-of-hour%E3%80%81end-of-hour">14.1.6.2 <code>beginning_of_hour</code>、<code>end_of_hour</code></a></h6><p><code>beginning_of_hour</code>メソッドは、その時の最初の時点 (hh:00:00) のタイムスタンプを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = DateTime.new(2010, 6, 7, 19, 55, 25)
date.beginning_of_hour # =&gt; Mon Jun 07 19:00:00 +0200 2010

</pre>
</div>
<p><code>end_of_hour</code>メソッドは、その時の最後の時点 (hh:59:59) のタイムスタンプを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = DateTime.new(2010, 6, 7, 19, 55, 25)
date.end_of_hour # =&gt; Mon Jun 07 19:59:59 +0200 2010

</pre>
</div>
<p><code>beginning_of_hour</code>は<code>at_beginning_of_hour</code>の別名です。</p><h6 id="beginning-of-minute、end-of-minute"><a href="#beginning-of-minute%E3%80%81end-of-minute">14.1.6.3 <code>beginning_of_minute</code>、<code>end_of_minute</code></a></h6><p><code>beginning_of_minute</code>は、その分の最初の時点 (hh:mm:00) のタイムスタンプを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = DateTime.new(2010, 6, 7, 19, 55, 25)
date.beginning_of_minute # =&gt; Mon Jun 07 19:55:00 +0200 2010

</pre>
</div>
<p><code>end_of_minute</code>メソッドは、その分の最後の時点 (hh:mm:59) のタイムスタンプを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = DateTime.new(2010, 6, 7, 19, 55, 25)
date.end_of_minute # =&gt; Mon Jun 07 19:55:59 +0200 2010

</pre>
</div>
<p><code>beginning_of_minute</code>は<code>at_beginning_of_minute</code>の別名です。</p><div class="info"><p><code>beginning_of_hour</code>、<code>end_of_hour</code>、<code>beginning_of_minute</code>、<code>end_of_minute</code>は<code>Time</code>および<code>DateTime</code>への実装ですが、<code>Date</code>への実装では <strong>ありません</strong> 。<code>Date</code>インスタンスに対して時間や分の最初や最後を問い合わせる意味はありません。</p></div><h6 id="ago、since"><a href="#ago%E3%80%81since">14.1.6.4 <code>ago</code>、<code>since</code></a></h6><p><code>ago</code>メソッドは秒数を引数として受け取り、真夜中の時点からその秒数だけさかのぼった時点のタイムスタンプを返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.current # =&gt; Fri, 11 Jun 2010
date.ago(1)         # =&gt; Thu, 10 Jun 2010 23:59:59 EDT -04:00

</pre>
</div>
<p><code>since</code>メソッドは、同様にその秒数だけ先に進みます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.current # =&gt; Fri, 11 Jun 2010
date.since(1)       # =&gt; Fri, 11 Jun 2010 00:00:01 EDT -04:00

</pre>
</div>
<h5 id="その他の時間計算"><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%99%82%E9%96%93%E8%A8%88%E7%AE%97">14.1.7 その他の時間計算</a></h5><h4 id="各種変換"><a href="#%E5%90%84%E7%A8%AE%E5%A4%89%E6%8F%9B">14.2 各種変換</a></h4><h3 id="datetimeの拡張"><a href="#datetime%E3%81%AE%E6%8B%A1%E5%BC%B5">15 <code>DateTime</code>の拡張</a></h3><div class="warning"><p><code>DateTime</code>は夏時間 (DST) ルールについては関知しません。夏時間の変更が行われた場合、メソッドの一部がこのとおりに動作しないことがあります。たとえば、<code>seconds_since_midnight</code>メソッドが返す秒数が実際の総量と合わない可能性があります。</p></div><h4 id="datetimeの拡張-計算"><a href="#datetime%E3%81%AE%E6%8B%A1%E5%BC%B5-%E8%A8%88%E7%AE%97">15.1 計算</a></h4><div class="note"><p>これらはすべて同じ定義ファイル<code>active_support/core_ext/date_time/calculations.rb</code>にあります。</p></div><p><code>DateTime</code>クラスは<code>Date</code>のサブクラスであり、<code>active_support/core_ext/date/calculations.rb</code>を読み込むことでこれらのメソッドと別名を継承することができます。ただしこれらは常にdatetimesを返す点が異なります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
yesterday
tomorrow
beginning_of_week (at_beginning_of_week)
end_of_week (at_end_of_week)
monday
sunday
weeks_ago
prev_week (last_week)
next_week
months_ago
months_since
beginning_of_month (at_beginning_of_month)
end_of_month (at_end_of_month)
prev_month (last_month)
next_month
beginning_of_quarter (at_beginning_of_quarter)
end_of_quarter (at_end_of_quarter)
beginning_of_year (at_beginning_of_year)
end_of_year (at_end_of_year)
years_ago
years_since
prev_year (last_year)
next_year

</pre>
</div>
<p>以下のメソッドはすべて再実装されるため、これらを使用するために<code>active_support/core_ext/date/calculations.rb</code>を読み込む必要は <strong>ありません</strong> 。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
beginning_of_day (midnight, at_midnight, at_beginning_of_day)
end_of_day
ago
since (in)

</pre>
</div>
<p>他方、<code>advance</code>と<code>change</code>も定義されていますがこれらはさらに多くのオプションをサポートしています。これらについては後述します。</p><p>以下のメソッドは<code>active_support/core_ext/date_time/calculations.rb</code>にのみ実装されています。これらは<code>DateTime</code>インスタンスに対して使用しないと意味がないためです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
beginning_of_hour (at_beginning_of_hour)
end_of_hour

</pre>
</div>
<h5 id="名前付き日付時刻"><a href="#%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E6%97%A5%E4%BB%98%E6%99%82%E5%88%BB">15.1.1 名前付き日付時刻</a></h5><h6 id="datetime-current"><a href="#datetime-current">15.1.1.1 <code>DateTime.current</code></a></h6><p>Active Supportでは、<code>DateTime.current</code>を<code>Time.now.to_datetime</code>と同様に定義しています。ただし、<code>DateTime.current</code>はユーザータイムゾーンが定義されている場合に対応する点が異なります。Active Supportでは<code>Date.yesterday</code>メソッドと<code>Date.tomorrow</code>も定義しています。インスタンスでは<code>past?</code>と<code>future?</code>を使用でき、これらは<code>Date.current</code>を起点として導かれます。</p><h5 id="その他の拡張"><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%8B%A1%E5%BC%B5">15.1.2 その他の拡張</a></h5><h6 id="seconds-since-midnight"><a href="#seconds-since-midnight">15.1.2.1 <code>seconds_since_midnight</code></a></h6><p><code>seconds_since_midnight</code>メソッドは、真夜中からの経過秒数を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.current     # =&gt; Mon, 07 Jun 2010 20:26:36 +0000
now.seconds_since_midnight # =&gt; 73596

</pre>
</div>
<h6 id="utc"><a href="#utc">15.1.2.2 <code>utc</code></a></h6><p><code>utc</code>メソッドは、レシーバの日付時刻をUTCで返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.current # =&gt; Mon, 07 Jun 2010 19:27:52 -0400
now.utc                # =&gt; Mon, 07 Jun 2010 23:27:52 +0000

</pre>
</div>
<p><code>getutc</code>はこのメソッドの別名です。</p><h6 id="utc-questionmark"><a href="#utc-questionmark">15.1.2.3 <code>utc?</code></a></h6><p><code>utc?</code>述語は、レシーバがそのタイムゾーンに合ったUTC時刻を持っているかどうかをチェックします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.now # =&gt; Mon, 07 Jun 2010 19:30:47 -0400
now.utc?          # =&gt; false
now.utc.utc?      # =&gt; true

</pre>
</div>
<h6 id="その他の拡張-advance"><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%8B%A1%E5%BC%B5-advance">15.1.2.4 <code>advance</code></a></h6><p>日時を移動する最も一般的な方法は<code>advance</code>メソッドを使用することです。このメソッドは<code>:years</code>、<code>:months</code>、<code>:weeks</code>、<code>:days</code>、<code>:hours</code>、<code>:minutes</code>および<code>:seconds</code>をキーに持つハッシュを受け取り、日時をできるだけ詳細な形式で、現在のキーで示されるとおりに返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = DateTime.current
# =&gt; Thu, 05 Aug 2010 11:33:31 +0000
d.advance(years: 1, months: 1, days: 1, hours: 1, minutes: 1, seconds: 1)
# =&gt; Tue, 06 Sep 2011 12:34:32 +0000

</pre>
</div>
<p>このメソッドはまず、上で説明されている<code>Date#advance</code>に対する経過年(<code>:years</code>)、経過月 (<code>:months</code>)、経過週 (<code>:weeks</code>)、経過日 (<code>:days</code>) を元に移動先の日付を算出します。続いて、算出された時点までの経過秒数を元に<code>since</code>メソッドを呼び出し、時間を補正します。この実行順序には意味があります。極端なケースでは、順序が変わると計算結果も異なる場合があります。これは上の<code>Date#advance</code>で示した例で適用されます。相対的な時間の計算においても計算の順序は同様に重要です。</p><p>もし仮に日付部分を先に進め (前述したとおり、相対的な計算順序があります)、続いて時間の部分も先に進めると、以下のような計算結果が得られます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = DateTime.new(2010, 2, 28, 23, 59, 59)
# =&gt; Sun, 28 Feb 2010 23:59:59 +0000
d.advance(months: 1, seconds: 1)
# =&gt; Mon, 29 Mar 2010 00:00:00 +0000

</pre>
</div>
<p>今度は順序を変えて計算すると、結果が異なります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d.advance(seconds: 1).advance(months: 1)
# =&gt; Thu, 01 Apr 2010 00:00:00 +0000

</pre>
</div>
<div class="warning"><p><code>DateTime</code>は夏時間 (DST) を考慮しません。算出された時間が最終的に存在しない時間になっても警告やエラーは発生しません。</p></div><h5 id="datetimeの拡張-計算-要素の変更"><a href="#datetime%E3%81%AE%E6%8B%A1%E5%BC%B5-%E8%A8%88%E7%AE%97-%E8%A6%81%E7%B4%A0%E3%81%AE%E5%A4%89%E6%9B%B4">15.1.3 要素の変更</a></h5><p><code>change</code>メソッドを使用して、レシーバの日時の一部の要素だけを更新した新しい日時を得ることができます。変更する要素としては、<code>:year</code>、<code>:month</code>、<code>:day</code>、<code>:hour</code>、<code>:min</code>、<code>:sec</code>、<code>:offset</code>、<code>:start</code>などが指定できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.current
# =&gt; Tue, 08 Jun 2010 01:56:22 +0000
now.change(year: 2011, offset: Rational(-6, 24))
# =&gt; Wed, 08 Jun 2011 01:56:22 -0600

</pre>
</div>
<p>時 (hour) がゼロの場合、分と秒も値を与えられない限り同様にゼロになります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now.change(hour: 0)
# =&gt; Tue, 08 Jun 2010 00:00:00 +0000

</pre>
</div>
<p>同様に、分がゼロの場合、秒も値を与えられない限りゼロになります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now.change(min: 0)
# =&gt; Tue, 08 Jun 2010 01:00:00 +0000

</pre>
</div>
<p>存在しない日付が指定されると<code>ArgumentError</code>が発生します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
DateTime.current.change(month: 2, day: 30)
# =&gt; ArgumentError: invalid date

</pre>
</div>
<h5 id="datetimeの拡張-計算-期間"><a href="#datetime%E3%81%AE%E6%8B%A1%E5%BC%B5-%E8%A8%88%E7%AE%97-%E6%9C%9F%E9%96%93">15.1.4 期間</a></h5><p>日時に対して期間を加減算できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.current
# =&gt; Mon, 09 Aug 2010 23:15:17 +0000
now + 1.year
# =&gt; Tue, 09 Aug 2011 23:15:17 +0000
now - 1.week
# =&gt; Mon, 02 Aug 2010 23:15:17 +0000

</pre>
</div>
<p>これらの計算は、内部で<code>since</code>メソッドや<code>advance</code>メソッドに置き換えられます。たとえば、作り直したカレンダー内で正しくジャンプできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
DateTime.new(1582, 10, 4, 23) + 1.hour
# =&gt; Fri, 15 Oct 1582 00:00:00 +0000

</pre>
</div>
<h3 id="timeの拡張"><a href="#time%E3%81%AE%E6%8B%A1%E5%BC%B5">16 <code>Time</code>の拡張</a></h3><h4 id="計算"><a href="#%E8%A8%88%E7%AE%97">16.1 計算</a></h4><div class="note"><p>これらはすべて同じ定義ファイル<code>active_support/core_ext/time/calculations.rb</code>にあります。</p></div><p>Active Supportは、<code>DateTime</code>で使用できるメソッドの多くを<code>Time</code>に追加しています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
past?
today?
future?
yesterday
tomorrow
seconds_since_midnight
change
advance
ago
since (in)
beginning_of_day (midnight, at_midnight, at_beginning_of_day)
end_of_day
beginning_of_hour (at_beginning_of_hour)
end_of_hour
beginning_of_week (at_beginning_of_week)
end_of_week (at_end_of_week)
monday
sunday
weeks_ago
prev_week (last_week)
next_week
months_ago
months_since
beginning_of_month (at_beginning_of_month)
end_of_month (at_end_of_month)
prev_month (last_month)
next_month
beginning_of_quarter (at_beginning_of_quarter)
end_of_quarter (at_end_of_quarter)
beginning_of_year (at_beginning_of_year)
end_of_year (at_end_of_year)
years_ago
years_since
prev_year (last_year)
next_year

</pre>
</div>
<p>これらは同様に動作します。関連するドキュメントを参照し、以下の相違点についても把握しておいてください。</p>
<ul>
<li>
<code>change</code>メソッドは追加の<code>:usec</code>も受け付けます。</li>
<li>
<code>Time</code>は夏時間 (DST) を理解します。以下のように夏時間を正しく算出できます。</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Time.zone_default
# =&gt; #&lt;ActiveSupport::TimeZone:0x7f73654d4f38 @utc_offset=nil, @name="Madrid", ...&gt;

# バルセロナでは夏時間により2010/03/28 02:00 +0100が2010/03/28 03:00 +0200になる
t = Time.local(2010, 3, 28, 1, 59, 59)
# =&gt; Sun Mar 28 01:59:59 +0100 2010
t.advance(seconds: 1)
# =&gt; Sun Mar 28 03:00:00 +0200 2010

</pre>
</div>

<ul>
<li>
<code>since</code>や<code>ago</code>の移動先の時間が<code>Time</code>で表現できない場合、<code>DateTime</code>オブジェクトが代わりに返されます。</li>
</ul>
<h5 id="time-current"><a href="#time-current">16.1.1 <code>Time.current</code></a></h5><p>Active Supportでは、<code>Time.current</code>を定義して現在のタイムゾーンにおける「今日」を定めています。このメソッドは<code>Time.now</code>と似ていますが、ユーザー定義のタイムゾーンがある場合にそれを考慮する点が異なります。Active Supportでは<code>past?</code>、<code>today?</code>、<code>future?</code>を示すインスタンス述語も定義されており、これらはすべてこの<code>Time.current</code>を起点にしています。</p><p>ユーザー定義のタイムゾーンを考慮するメソッドを使用して日付を比較したい場合、<code>Time.now</code>ではなく必ず<code>Time.current</code>を使用してください。将来、ユーザー定義のタイムゾーンがシステムのタイムゾーンと比較されることがありえます。システムのタイムゾーンではデフォルトで<code>Time#now</code>が使用されます。つまり、<code>Time.now</code>が<code>Time.currentyesterday</code>と等しくなることがありえるということです。</p><h5 id="all-day、all-week、all-month、all-quarter、all-year"><a href="#all-day%E3%80%81all-week%E3%80%81all-month%E3%80%81all-quarter%E3%80%81all-year">16.1.2 <code>all_day</code>、<code>all_week</code>、<code>all_month</code>、<code>all_quarter</code>、<code>all_year</code></a></h5><p><code>all_day</code>メソッドは、現在時刻を含むその日一日を表す範囲を返します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = Time.current
# =&gt; Mon, 09 Aug 2010 23:20:05 UTC +00:00
now.all_day
# =&gt; Mon, 09 Aug 2010 00:00:00 UTC +00:00..Mon, 09 Aug 2010 23:59:59 UTC +00:00

</pre>
</div>
<p>同様に、<code>all_week</code>、<code>all_month</code>、<code>all_quarter</code>、<code>all_year</code>も時間の範囲を生成できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = Time.current
# =&gt; Mon, 09 Aug 2010 23:20:05 UTC +00:00
now.all_week
# =&gt; Mon, 09 Aug 2010 00:00:00 UTC +00:00..Sun, 15 Aug 2010 23:59:59 UTC +00:00
now.all_week(:sunday)
# =&gt; Sun, 16 Sep 2012 00:00:00 UTC +00:00..Sat, 22 Sep 2012 23:59:59 UTC +00:00
now.all_month
# =&gt; Sat, 01 Aug 2010 00:00:00 UTC +00:00..Tue, 31 Aug 2010 23:59:59 UTC +00:00
now.all_quarter
# =&gt; Thu, 01 Jul 2010 00:00:00 UTC +00:00..Thu, 30 Sep 2010 23:59:59 UTC +00:00
now.all_year
# =&gt; Fri, 01 Jan 2010 00:00:00 UTC +00:00..Fri, 31 Dec 2010 23:59:59 UTC +00:00

</pre>
</div>
<h4 id="時間コンストラクタ"><a href="#%E6%99%82%E9%96%93%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF">16.2 時間コンストラクタ</a></h4><p>ユーザータイムゾーンが定義されている場合、Active Supportが定義する<code>Time.current</code>の値は<code>Time.zone.now</code>の値と同じになります。ユーザータイムゾーンが定義されていない場合は、<code>Time.now</code>と同じになります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Time.zone_default
# =&gt; #&lt;ActiveSupport::TimeZone:0x7f73654d4f38 @utc_offset=nil, @name="Madrid", ...&gt;
Time.current
# =&gt; Fri, 06 Aug 2010 17:11:58 CEST +02:00

</pre>
</div>
<p><code>DateTime</code>と同様、述語<code>past?</code>と<code>future?</code>は<code>Time.current</code>を起点とします。</p><p>構成される時間が、実行プラットフォームの<code>Time</code>でサポートされる範囲を超えている場合は、usecは破棄され、<code>DateTime</code>オブジェクトが代りに返されます。</p><h5 id="期間"><a href="#%E6%9C%9F%E9%96%93">16.2.1 期間</a></h5><p>Timeオブジェクトに対して期間を加減算できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = Time.current
# =&gt; Mon, 09 Aug 2010 23:20:05 UTC +00:00
now + 1.year
#  =&gt; Tue, 09 Aug 2011 23:21:11 UTC +00:00
now - 1.week
# =&gt; Mon, 02 Aug 2010 23:21:11 UTC +00:00

</pre>
</div>
<p>これらの計算は、内部で<code>since</code>メソッドや<code>advance</code>メソッドに置き換えられます。たとえば、作り直したカレンダー内で正しくジャンプできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Time.utc(1582, 10, 3) + 5.days
# =&gt; Mon Oct 18 00:00:00 UTC 1582

</pre>
</div>
<h3 id="fileの拡張"><a href="#file%E3%81%AE%E6%8B%A1%E5%BC%B5">17 <code>File</code>の拡張</a></h3><h4 id="atomic-write"><a href="#atomic-write">17.1 <code>atomic_write</code></a></h4><p><code>File.atomic_write</code>クラスメソッドを使用すると、書きかけの文章を誰にも読まれないようにファイルを保存することができます。</p><p>このメソッドにファイル名を引数として渡すと、書き込み用にオープンされたファイルハンドルを生成します。ブロックが完了すると、<code>atomic_write</code>はファイルハンドルをクローズして処理を完了します。</p><p>Action Packは、このメソッドを利用して<code>all.css</code>などのキャッシュファイルへの書き込みを行ったりしています。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
File.atomic_write(joined_asset_path) do |cache|
  cache.write(join_asset_file_contents(asset_paths))
end

</pre>
</div>
<p><code>atomic_write</code>は、処理を完了するために一時的なファイルを作成します。ブロック内のコードが実際に書き込むのはこのファイルです。完了時にはこの一時ファイルはリネームされます。リネームは、POSIXシステムのアトミック操作に基いて行われます。書き込み対象ファイル既にが存在する場合、<code>atomic_write</code>はそれを上書きしてオーナーとパーミッションを保持します。ただし、<code>atomic_write</code>メソッドがファイルのオーナーシップとパーミッションを変更できないケースがまれにあります。このエラーはキャッチされ、そのファイルがそれを必要とするプロセスからアクセスできるようにするために、ユーザーのファイルシステムへの信頼をスキップします。</p><div class="note"><p><code>atomic_write</code>が行なうchmod操作が原因で、書き込み対象ファイルがACLセットを持っているときにそのACLが再計算/変更されます。</p></div><div class="warning"><p><code>atomic_write</code>で追記を行なうことはできません。</p></div><p>この補助ファイルは標準の一時ファイル用ディレクトリに書き込まれますが、2番目の引数でディレクトリを直接指定することもできます。</p><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/file/atomic.rb</code>です。</p></div><h3 id="marshalの拡張"><a href="#marshal%E3%81%AE%E6%8B%A1%E5%BC%B5">18 <code>Marshal</code>の拡張</a></h3><h4 id="load"><a href="#load">18.1 <code>load</code></a></h4><p>Active Supportは、<code>load</code>に一定の自動読み込みサポートを追加します。</p><p>たとえば、ファイルキャッシュストアでは以下のように非直列化 (deserialize) します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
File.open(file_name) { |f| Marshal.load(f) }

</pre>
</div>
<p>キャッシュデータが不明な定数を参照している場合、自動読み込みがトリガされます。読み込みに成功した場合は非直列化を透過的に再試行します。</p><div class="warning"><p>引数が<code>IO</code>の場合、再試行を可能にするために<code>rewind</code>に応答する必要があります。通常のファイルは<code>rewind</code>に応答します。</p></div><div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/marshal.rb</code>です。</p></div><h3 id="nameerrorの拡張"><a href="#nameerror%E3%81%AE%E6%8B%A1%E5%BC%B5">19 <code>NameError</code>の拡張</a></h3><p>Active Supportは<code>NameError</code>に<code>missing_name?</code>メソッドを追加します。このメソッドは、引数として渡された名前が原因で例外が発生するかどうかをテストします。</p><p>渡される名前はシンボルまたは文字列です。シンボルを渡した場合は単なる定数名をテストし、文字列を渡した場合はフルパス (fully-qualified) の定数名をテストします。</p><div class="info"><p>シンボルは<code>:"ActiveRecord::Base"</code>で行なっているのと同じようにフルパスの定数として表すことができます。シンボルがそのように動作するのはそれが便利だからであり、技術的にそうしなければならないというものではありません。</p></div><p>たとえば、<code>ArticlesController</code>のアクションが呼び出されると、Railsはその名前からすぐに推測できる<code>ArticleHelper</code>を使用しようとします。ここではこのヘルパーモジュールが存在していなくても問題はないので、この定数名で例外が発生しても例外として扱わずに黙殺する必要があります。しかし、実際に不明な定数が原因で<code>articles_helper.rb</code>が<code>NameError</code>エラーを発生するという場合が考えられます。そのような場合は、改めて例外を発生させなくてはなりません。<code>missing_name?</code>メソッドは、この2つの場合を区別するために使用されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def default_helper_module!
  module_name = name.sub(/Controller$/, '')
  module_path = module_name.underscore
  helper module_path
rescue LoadError =&gt; e
  raise e unless e.is_missing? "helpers/#{module_path}_helper"
rescue NameError =&gt; e
  raise e unless e.missing_name? "#{module_name}Helper"
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/name_error.rb</code>です。</p></div><h3 id="loaderrorの拡張"><a href="#loaderror%E3%81%AE%E6%8B%A1%E5%BC%B5">20 <code>LoadError</code>の拡張</a></h3><p>Active Supportは<code>is_missing?</code>を<code>LoadError</code>に追加します。</p><p><code>is_missing?</code>は、パス名を引数に取り、特定のファイルが原因で例外が発生するかどうかをテストします (".rb"拡張子が原因と思われる場合を除きます)。</p><p>たとえば、<code>ArticlesController</code>のアクションが呼び出されると、Railsは<code>articles_helper.rb</code>を読み込もうとしますが、このファイルは存在しないことがあります。ヘルパーモジュールは必須ではないので、Railsは読み込みエラーを例外扱いせずに黙殺します。しかし、ヘルパーモジュールが存在しないために別のライブラリが必要になり、それがさらに見つからないという場合が考えられます。Railsはそのような場合には例外を再発生させなければなりません。<code>is_missing?</code>メソッドは、この2つの場合を区別するために使用されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def default_helper_module!
  module_name = name.sub(/Controller$/, '')
  module_path = module_name.underscore
  helper module_path
rescue LoadError =&gt; e
  raise e unless e.is_missing? "helpers/#{module_path}_helper"
rescue NameError =&gt; e
  raise e unless e.missing_name? "#{module_name}Helper"
end

</pre>
</div>
<div class="note"><p>定義ファイルの場所は<code>active_support/core_ext/load_error.rb</code>です。</p></div>
        

        <h3 id="feedback"><a href="#feedback">フィードバックについて</a></h3>
        <p>
          本ガイドは GitHub上の <a href="https://github.com/yasslab/railsguides.jp">yasslab/railsguides.jp</a> で管理・公開されております。
          本ガイドを読んで気になる文章や間違ったコードを見かけたら、上記リポジトリにてお気軽に <a href="https://github.com/yasslab/railsguides.jp/issues">Issue</a> を出して頂けると嬉しいです。また、「Pull Request を送りたい!」という場合には、<a href="ruby_on_rails_guides_guidelines.html">Ruby on Railsガイドのガイドライン</a>と、<a href="https://github.com/yasslab/railsguides.jp#%E7%BF%BB%E8%A8%B3%E3%81%AE%E6%B5%81%E3%82%8C">README</a>に記載されている「翻訳の流れ」をご参考にしてください。
        </p>
        <p>
          なお、原著における間違いを見つけたら、「Ruby on Railsに貢献する方法」に記されている<a href="/contributing_to_ruby_on_rails.html#rails%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AB%E8%B2%A2%E7%8C%AE%E3%81%99%E3%82%8B">Railsのドキュメントに貢献する</a>を参考にしながら、ぜひRailsコミュニティに貢献してみてしてください :)
        </p>
        <p>
          本ガイドの品質向上に向けて、皆さまのご協力が得られれば幸いです。よろしくお願い致します。
        </p>
        <ol class="snsb" style="margin-left: 0px">
	  <li><div class="fb-like" data-href="http://railsguides.jp/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div></li>
	  <li><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://railsguides.jp/" data-text="Ruby on Rails ガイド：体系的に Rails を学ぼう" data-lang="en" data-hashtags="Railsガイド" data-via="RailsGuidesJP" width="100">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></li>
          <li><iframe src="http://ghbtns.com/github-btn.html?user=yasslab&repo=railsguides.jp&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80" height="20"></iframe></li>
          <li><a href="http://b.hatena.ne.jp/entry/railsguides.jp" class="hatena-bookmark-button" data-hatena-bookmark-title="Ruby on Rails ガイド：体系的に Rails を学ぼう" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script></li>          
	  <li><div class="g-plusone" data-size="medium" data-lang="ja"></div>
	    <script type="text/javascript">
	      (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	      })();
	    </script>
	  </li>
        </ol>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <div class="sitemap">
          <dl class="L">
            <dt>はじめに</dt>
              <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
            <dt>モデル</dt>
              <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
              <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
              <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
              <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
              <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
              <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
              <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
            <dt>ビュー</dt>
              <dd><a href="action_view_overview.html">Action View の概要</a></dd>
              <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
              <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
            <dt>コントローラ</dt>
              <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
              <dd><a href="routing.html">Rails ルーティング</a></dd>
          </dl>
          <dl class="C">
            <dt>高度なトピック</dt>
              <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
              <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
              <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
              <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
              <dd><a href="testing.html">Rails テスティングガイド</a></dd>
              <dd><a href="security.html">Rails セキュリティガイド</a></dd>
              <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
              <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
              <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
              <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
              <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
              <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
              <dd><a href="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</a></dd>
              <dd><a href="caching_with_rails.html">Rails のキャッシュ: 概要</a></dd>
              <dd><a href="active_support_instrumentation.html">Active Support の Instrumentation 機能</a></dd>
              <dd><a href="profiling.html">Rails アプリのプロファイリング</a></dd>
              <dd><a href="api_app.html">Rails による API 専用アプリ</a></dd>
              <dd><a href="action_cable_overview.html">Action Cable の概要</a></dd>
            <dt>Rails を拡張する</dt>
              <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
              <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
              <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
              <dd><a href="engines.html">Rails エンジン入門</a></dd>
          </dl>
          <dl class="R">
            <dt>Ruby on Rails に貢献する</dt>
              <dd><a href="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</a></dd>
              <dd><a href="development_dependencies_install.html">Rails コア開発環境の構築方法</a></dd>
              <dd><a href="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</a></dd>
              <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
            <dt>メンテナンスポリシー</dt>
              <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
            <dt>リリースノート</dt>
              <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
              <dd><a href="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</a></dd>
              <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
              <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
              <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
              <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
              <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
              <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
              <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
              <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
          </dl>
      </div>

      <ol class="snsb" style="padding-top: 20px">
	<li>本ガイドは<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.ja">クリエイティブ・コモンズ 表示-継承 4.0 国際</a> (CC BY-SA 4.0) ライセンスに基づいて公開されています。また、「Rails」および「Ruby on Rails」という名称、そして Rails のロゴは、David Heinemeier Hansson による登録商標で、すべての権利を有しています。</li>
      </ol>
    </div>
  </div>
</h5>
  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-50163209-4', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
